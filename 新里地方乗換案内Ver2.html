<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>新里地方 乗換案内 — SVG 中心接続版</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#f7fafc;
  --card:#ffffff;
  --muted:#64748b;
  --radius:10px;
  --gutter:40px;
  --dotMajor:18px;
  --dotMinor:12px;
  --lineWMajor:6;
  --lineWMinor:4;
  --font-sans:"Hiragino Kaku Gothic ProN","Meiryo",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
}
html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:#021124}
.wrap{max-width:980px;margin:28px auto;padding:18px}
h1{margin:0 0 12px;font-size:20px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 24px rgba(2,6,23,0.06);margin-bottom:12px}
.row{display:flex;gap:12px;align-items:flex-start;flex-direction:column}
.col{display:flex;flex-direction:column;gap:6px;position:relative;align-items:flex-start}
select,button{font-size:14px;padding:8px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff}
label{font-size:13px;color:var(--muted)}
button.primary{cursor:pointer;background:#0b5fff;color:#fff;border:none}
.resultHeader{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.resultHeader .meta{display:flex;gap:18px;color:#111}

/* 路線図レイアウト（新設計） */
.routeLine{display:flex;flex-direction:column;gap:12px;margin-top:6px}
.rowStation{display:grid;grid-template-columns:var(--gutter) 1fr;align-items:start;column-gap:10px;position:relative;padding:6px 0;}
.railCol{display:flex;flex-direction:column;align-items:center;position:relative;min-height:36px;}
.railLayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1} /* SVG を置くレイヤ */
.railDot{border-radius:50%;width:var(--dotMajor);height:var(--dotMajor);z-index:3;border:3px solid #fff;box-sizing:border-box;position:relative;left:50%;transform:translateX(-50%);display:inline-block}
.rowBetween .railDot{width:var(--dotMinor);height:var(--dotMinor);border:2px solid #fff}
.railLineVisual{position:absolute;left:50%;transform:translateX(-50%);width:var(--lineWMajor);background:transparent;z-index:2}
.stationText{display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start}
.stationName{font-weight:700;font-size:15px;line-height:1.25;margin:0}
.lineBadge{display:inline-block;color:#fff;font-size:13px;line-height:1;padding:2px 6px;border-radius:6px;margin-top:6px;white-space:nowrap;margin-right:6px}
.stationWithIcons{display:flex;align-items:center;gap:6px}
.stationIcon{width:24px;height:24px;border-radius:3px;object-fit:cover;display:inline-block}

/* between 行（途中駅） */
.rowBetween{display:grid;grid-template-columns:var(--gutter) 1fr;column-gap:10px;align-items:start;height:auto;padding:8px 0;}
.minorName{font-size:14px;font-weight:300;margin:0;color:#222;position:relative;top:-2px}

/* toggle 等 */
.toggleWrap{margin-top:6px}
.toggleBtn{cursor:pointer;padding:6px 8px;font-size:13px;border-radius:6px;border:1px solid #e6eefc;background:#f8fbff}
.viaList{display:flex;flex-direction:column;gap:6px;margin:6px 0;align-items:flex-start}
.viaRow{display:flex;align-items:center;gap:6px;justify-content:flex-start}
.viaRow button{font-size:12px;padding:4px 6px}

/* レスポンシブ */
@media (max-width:640px){
  :root{--gutter:44px}
  .stationIcon{width:20px;height:20px}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>新里地方 乗換案内 — SVG 中心接続版</h1>

  <div class="card">
    <div id="stationSelector">
      <div class="row">
        <div class="col">
          <label>発駅</label>
          <div style="display:flex;gap:6px">
            <select class="lineSelect" id="fromLine"></select>
            <select class="stationSelect" id="fromStation"></select>
          </div>
        </div>

        <div class="col">
          <label>経由地</label>
          <div class="viaList" id="viaList"></div>
          <button id="addViaBtn" class="primary" style="margin-top:8px">経由地を追加</button>
        </div>

        <div class="col">
          <label>着駅</label>
          <div style="display:flex;gap:6px">
            <select class="lineSelect" id="toLine"></select>
            <select class="stationSelect" id="toStation"></select>
          </div>
        </div>

        <div style="display:flex;align-items:flex-end;">
          <button id="searchBtn" class="primary">検索</button>
        </div>
      </div>
    </div>
  </div>

  <div id="resultArea"></div>
</div>

<script>
/* -----------------------
   データ（前回と同等）
   ----------------------- */
document.addEventListener('DOMContentLoaded', () => {
  try {
    const stationLines = {
     "新里鉄道湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
     "新里鉄道燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
     "新里鉄道鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
     "新里鉄道新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
     "新里鉄道彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"],
    "鈴浜電気鉄道鈴浜電鉄線":["桜川国際空港(鈴浜電鉄)","りんくう桜川","余田","白砂","千種園","大三浜","外神","紅原台","恋野宮","南河都","河都","北河都","百合ヶ丘公園","猫崎海岸","籾井","白木稲荷","流沢温泉口","流沢温泉","京新峡","奥沢高原","原津","神道山口","新的場","虹川","片牧町","鬼越峠","北鶴宮"],
    "桜川電気鉄道彩山線":["喜多瀬浜","喜多瀬","久我山","桜鉄彩山口"],
    "桜川電気鉄道空港線":["桜川","公園東口","桜川公園北口","御厨","南深江","北深江","桜鉄浪原","東浪原","喜多瀬浜","葵台","汐見台","月野原","高瀬","結原","りんくう桜川","桜川国際空港(桜川電鉄)"],
    "桜川電気鉄道桜州環状線":["八軒町","川渡","西中野","中野","東中野","桜台","福原","桜鉄久我原","浪原","桜鉄浪原","彩山川","似島","中洲","糸島","南糸島","野瀬","新浜","海岸通り","桜町","東片野","東新地","新地"],
    "桜川電気鉄道中野線":["中野","南中野","大里","栄町","北桜川","桜川","南桜川","東豊野","すすき野","永田","平川","片野","北新地","新地"],
      "豊野鉄道豊野線":["糸島","西糸島","平田","文京町","東桜川","桜川","豊野月見台","豊野","西豊野","白州川","春田","桜峠","桑畑","常盤台","天津川","広野","追分","野川","幕生","羽草","清見台","東園木","園木"],
    "豊野鉄道新地線":["春田","南春田","日野原","加納","永楽町","室町","西新地","新地"],
    "豊野鉄道坂川線":["桑畑","北桑畑","坂川","天津温泉"],
      "坂津電鉄坂津本線":["坂津港","港通","坂電坂津","大井野","中天神町","飯倉町","酒何町","能地","初川","春原","岩川崎"],
    "坂津電鉄豊町線":["豊町","削野","勝垰","重石町","東坂津","港通"],
      "坂津ポートライナー線":["横宿","北横宿","総合運動場","郡元","鈴里","港通","坂津港"],
    "今橋鉄道成津線":["今橋","新今橋","土川","小弥又","大弥又","今橋学園前","久末","大町","成津","東成津","津塚","牛ヶ瀬","松橋","合浜","綿部","陣中原","萱海","弦川","二番街","高越","築田市","南築田","榎仏子","高座","口松","津垣","大道寺"],
    "今橋鉄道豊海線":["成津","北成津","原葉","徳橋","発樫","豊海","虹松","甲部","夕陽ヶ浜","艶華","富士町","園木"],
      "東橋鉄道東橋本線":[
        "東橋","河井町","黒田","新東橋","浅見","柴若","六日市通","岩田城","内山","新荘",
        "葉賀ノ台","木森","理李ヶ丘","小査","寺尾","栗島","宮間","大木沢","園木","新東園木",
        "綾山","豊川大野","垂生崎","南豊川","幕ヶ原","咲田口"
      ],
      // 横宿線を逆順にしました（ユーザ指定）
      "東橋鉄道横宿線":[
        "横宿","日森町","和泉原","朋田","小柴","新大崎","杜山","東黒田","新東橋"
      ]
    };

    const lineColors = {
      "新里鉄道湯の浜線":"#00bfff",
      "新里鉄道燠野線":"#ff4d6d",
      "新里鉄道鶴宮線":"#ffa500",
      "新里鉄道新里線":"#228b22",
      "新里鉄道彩山線":"#32cd32",
      "鈴浜電気鉄道鈴浜電鉄線":"#0c9451",
      "桜川電気鉄道彩山線":"#20b07b",
      "桜川電気鉄道中野線":"#e296f1",
      "桜川電気鉄道空港線":"#2dbbe5",
      "桜川電気鉄道桜州環状線":"#f18b23",
      "豊野鉄道豊野線":"#239d54",
      "豊野鉄道新地線":"#f06719",
      "豊野鉄道坂川線":"#fdc01f",
      "坂津電鉄坂津本線":"#0044cc",
      "坂津電鉄豊町線":"#0044cc",
      "坂津ポートライナー線":"#33ccff",
      "今橋鉄道豊海線":"#1f1fff",
      "今橋鉄道成津線":"#ff0000",
      "東橋鉄道東橋本線":"#00cc99",
      "東橋鉄道横宿線":"#0099cc"
    };

    const lineIcons = {
      "新里鉄道湯の浜線": "https://img.atwiki.jp/niizato-area/attach/15/105/Yunohama.png",
      "新里鉄道燠野線": "https://img.atwiki.jp/niizato-area/attach/16/106/Atano.png",
      "新里鉄道鶴宮線": "https://img.atwiki.jp/niizato-area/attach/17/104/Tsurumiya.png",
      "新里鉄道彩山線": "https://img.atwiki.jp/niizato-area/attach/19/103/Sayama.png",
      "新里鉄道新里線": "https://img.atwiki.jp/niizato-area/attach/18/108/Niizato.png"
    };

    const stationIcons = {
      "新里鉄道湯の浜線": {
        "豊町": "https://img.atwiki.jp/niizato-area/attach/15/38/Y01.png",
        "東豊町": "https://img.atwiki.jp/niizato-area/attach/15/37/Y02.png",
        "清水浜": "https://img.atwiki.jp/niizato-area/attach/15/40/Y03.png",
        "安田町": "https://img.atwiki.jp/niizato-area/attach/15/39/Y04.png",
        "南栃原": "https://img.atwiki.jp/niizato-area/attach/15/62/Y05.png",
        "栃原": "https://img.atwiki.jp/niizato-area/attach/15/61/Y06.png",
        "宇城": "https://img.atwiki.jp/niizato-area/attach/15/60/Y07.png",
        "須川": "https://img.atwiki.jp/niizato-area/attach/15/59/Y08.png",
        "御浜埼公園": "https://img.atwiki.jp/niizato-area/attach/15/58/Y09.png",
        "御浜": "https://img.atwiki.jp/niizato-area/attach/15/57/Y10.png",
        "伊坂": "https://img.atwiki.jp/niizato-area/attach/15/56/Y11.png",
        "垳下": "https://img.atwiki.jp/niizato-area/attach/15/55/Y12.png",
        "北浜": "https://img.atwiki.jp/niizato-area/attach/15/54/Y13.png",
        "西新里": "https://img.atwiki.jp/niizato-area/attach/15/53/Y14.png",
        "新里": "https://img.atwiki.jp/niizato-area/attach/15/52/Y15.png",
        "河岸": "https://img.atwiki.jp/niizato-area/attach/15/51/Y16.png",
        "新里海浜公園": "https://img.atwiki.jp/niizato-area/attach/15/50/Y17.png",
        "湯の浜海岸": "https://img.atwiki.jp/niizato-area/attach/15/49/Y18.png",
        "湯の浜": "https://img.atwiki.jp/niizato-area/attach/15/48/Y19.png",
        "七浦": "https://img.atwiki.jp/niizato-area/attach/15/47/Y20.png",
        "那珂町": "https://img.atwiki.jp/niizato-area/attach/15/46/Y21.png",
        "宇多野": "https://img.atwiki.jp/niizato-area/attach/15/45/Y22.png",
        "伊奈崎": "https://img.atwiki.jp/niizato-area/attach/15/44/Y23.png",
        "鶴宮神社": "https://img.atwiki.jp/niizato-area/attach/15/43/Y24.png",
        "鶴宮": "https://img.atwiki.jp/niizato-area/attach/15/42/Y25.png",
        "北鶴宮": "https://img.atwiki.jp/niizato-area/attach/15/41/Y26.png",
      },
      "新里鉄道燠野線": {
        "湯の浜": "https://img.atwiki.jp/niizato-area/attach/16/70/A01.png",
        "新里大学前": "https://img.atwiki.jp/niizato-area/attach/16/69/A02.png",
        "綾原": "https://img.atwiki.jp/niizato-area/attach/16/68/A03.png",
        "福来": "https://img.atwiki.jp/niizato-area/attach/16/67/A04.png",
        "燠野": "https://img.atwiki.jp/niizato-area/attach/16/66/A05.png",
        "湯川": "https://img.atwiki.jp/niizato-area/attach/16/65/A06.png",
        "温泉口": "https://img.atwiki.jp/niizato-area/attach/16/64/A07.png",
        "燠野温泉": "https://img.atwiki.jp/niizato-area/attach/16/63/A08.png"
      },
      "新里鉄道鶴宮線": {
        "鶴宮": "https://img.atwiki.jp/niizato-area/attach/17/84/T01.png",
        "南鶴宮": "https://img.atwiki.jp/niizato-area/attach/17/83/T02.png",
        "あずさ台": "https://img.atwiki.jp/niizato-area/attach/17/82/T03.png",
        "橘町": "https://img.atwiki.jp/niizato-area/attach/17/81/T04.png",
        "燠野山口": "https://img.atwiki.jp/niizato-area/attach/17/80/T05.png",
        "白枝": "https://img.atwiki.jp/niizato-area/attach/17/79/T06.png",
        "燠野": "https://img.atwiki.jp/niizato-area/attach/17/78/T07.png",
        "紅葉台": "https://img.atwiki.jp/niizato-area/attach/17/77/T08.png",
        "桐山": "https://img.atwiki.jp/niizato-area/attach/17/76/T09.png",
        "湊川": "https://img.atwiki.jp/niizato-area/attach/17/75/T10.png",
        "彩山親水公園": "https://img.atwiki.jp/niizato-area/attach/17/74/T11.png",
        "彩山": "https://img.atwiki.jp/niizato-area/attach/17/73/T12.png",
        "蓮華寺": "https://img.atwiki.jp/niizato-area/attach/17/72/T13.png",
        "星宮": "https://img.atwiki.jp/niizato-area/attach/17/71/T14.png",
        "田ノ原": "https://img.atwiki.jp/niizato-area/attach/17/85/T15.png"
      },
      "新里鉄道新里線": {
        "新里": "https://img.atwiki.jp/niizato-area/attach/18/91/N01.png",
        "南新里": "https://img.atwiki.jp/niizato-area/attach/18/90/N02.png",
        "田ノ原": "https://img.atwiki.jp/niizato-area/attach/18/89/N03.png",
        "北玖川": "https://img.atwiki.jp/niizato-area/attach/18/88/N04.png",
        "玖川": "https://img.atwiki.jp/niizato-area/attach/18/87/N05.png",
        "中野原": "https://img.atwiki.jp/niizato-area/attach/18/86/N06.png",
      },
      "新里鉄道彩山線": {
        "彩山": "https://img.atwiki.jp/niizato-area/attach/19/101/S01.png",
        "彩山口": "https://img.atwiki.jp/niizato-area/attach/19/100/S02.png",
        "新里国際スキー場": "https://img.atwiki.jp/niizato-area/attach/19/99/S03.png",
        "鷹見台": "https://img.atwiki.jp/niizato-area/attach/19/98/S04.png",
        "久我原": "https://img.atwiki.jp/niizato-area/attach/19/97/S05.png",
        "浪原": "https://img.atwiki.jp/niizato-area/attach/19/96/S06.png",
        "深江": "https://img.atwiki.jp/niizato-area/attach/19/95/S07.png",
        "三栗谷": "https://img.atwiki.jp/niizato-area/attach/19/94/S08.png",
        "桜川公園": "https://img.atwiki.jp/niizato-area/attach/19/93/S09.png",
        "桜川": "https://img.atwiki.jp/niizato-area/attach/19/92/S10.png",
      }
    };

    // 距離グラフ・運賃等は前回と同等の関数を使う（ここでは簡略化して同じスタブを用意）
    const rawGraph = {/* （前回同様の長い距離データをここに入れる） */};

    // ここでは core レンダリングのズレ対策（SVG 中心接続）に注力するため、
    // 距離/運賃などの詳細は既存ファイルからコピペして統合してください（省略せず必要なら追加可能）。
    // --- UI 初期化（簡潔版） ---
    const fromLineSel = document.getElementById('fromLine');
    const toLineSel = document.getElementById('toLine');
    const fromStationSel = document.getElementById('fromStation');
    const toStationSel = document.getElementById('toStation');
    const addViaBtn = document.getElementById('addViaBtn');
    const viaListDiv = document.getElementById('viaList');
    const searchBtn = document.getElementById('searchBtn');
    const resultArea = document.getElementById('resultArea');

    function populateLineSelect(sel){
      sel.innerHTML = '';
      Object.keys(stationLines).forEach(l=>{
        const o = document.createElement('option'); o.value = l; o.textContent = l; sel.appendChild(o);
      });
    }
    function populateStationSelect(lineSel, stationSel){
      stationSel.innerHTML = '';
      const line = lineSel.value;
      (stationLines[line] || []).forEach(st=>{
        const o = document.createElement('option'); o.value = st; o.textContent = st; stationSel.appendChild(o);
      });
    }
    [ fromLineSel, toLineSel ].forEach(sel => populateLineSelect(sel));
    populateStationSelect(fromLineSel, fromStationSel);
    populateStationSelect(toLineSel, toStationSel);

    fromLineSel.addEventListener('change', ()=> populateStationSelect(fromLineSel, fromStationSel));
    toLineSel.addEventListener('change', ()=> populateStationSelect(toLineSel, toStationSel));

    // 初期値（あれば）
    if(stationLines['新里鉄道湯の浜線']){
      fromLineSel.value = '新里鉄道湯の浜線';
      populateStationSelect(fromLineSel, fromStationSel);
      fromStationSel.value = '新里';
    }
    if(stationLines['新里鉄道燠野線']){
      toLineSel.value = '新里鉄道燠野線';
      populateStationSelect(toLineSel, toStationSel);
      toStationSel.value = '燠野温泉';
    }

    addViaBtn.addEventListener('click', ()=>{ 
      const viaRow = document.createElement('div');
      viaRow.className = 'viaRow';
      const lineSel = document.createElement('select');
      lineSel.className = 'lineSelect';
      populateLineSelect(lineSel);
      const stationSel = document.createElement('select');
      stationSel.className = 'stationSelect';
      populateStationSelect(lineSel, stationSel);
      lineSel.addEventListener('change', ()=> populateStationSelect(lineSel, stationSel));
      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.textContent = '削除';
      delBtn.addEventListener('click', ()=> { viaListDiv.removeChild(viaRow); });
      viaRow.appendChild(lineSel);
      viaRow.appendChild(stationSel);
      viaRow.appendChild(delBtn);
      viaListDiv.appendChild(viaRow);
    });

    // -----------------------
    // SVG 中心接続描画ロジック（再設計の肝）
    // -----------------------
    // 各ルートカード内に個別 SVG レイヤを作り、そこに太線・細線を描画する。
    // dot 要素には data-dot-id を付与し、SVG 上ではそれらの中心座標を使って <line> を描く。

    function createRouteCardContainer(){
      const cont = document.createElement('div');
      cont.className = 'card';
      return cont;
    }

    // path: 駅名配列、partIndex: 識別子
    function renderRouteCardSVG(path, partIndex){
      const card = createRouteCardContainer();
      const header = document.createElement('div');
      header.className = 'resultHeader';
      header.innerHTML = `<div style="font-weight:700">経路パート ${partIndex+1}</div><div class="meta"></div>`;
      card.appendChild(header);

      const routeWrap = document.createElement('div');
      routeWrap.className = 'routeLine';
      routeWrap.dataset.part = partIndex;

      // major stops を単純に path の先頭と末尾と交差点（簡略）で抽出する（詳細ロジックは必要に応じ追加）
      // ここでは見た目優先で主要駅を path の先頭・括目点・末尾とする（元ロジックより簡素化）
      const majors = [];
      majors.push(path[0]);
      // 中間は重複判定とかの高度処理をここに入れられます（今回は描画ロジックの確実性が目的）
      if(path.length > 2){
        // 1/3 と 2/3 の位置を主要駅として追加する（視認用）
        const m1 = Math.floor((path.length-1)/2);
        if(m1 > 0 && m1 < path.length-1) majors.push(path[m1]);
      }
      if(path.length > 1) majors.push(path[path.length-1]);

      // ただし majors はユニーク化してインデックスに変換
      const majorsUnique = Array.from(new Set(majors.map(m => m))).filter(Boolean);

      // 各 major 行を出力。major と major の間の途中駅は rowBetween として出す。
      for(let mi = 0; mi < majorsUnique.length; mi++){
        const st = majorsUnique[mi];
        // major の行
        const row = document.createElement('div');
        row.className = 'rowStation';
        const railCol = document.createElement('div');
        railCol.className = 'railCol';

        // SVG レイヤ（1カードにつき1つ。後で線を描く）
        // カード内の最初の railCol にしか SVG を入れない（高さはカード全体に拡げる）
        if(!routeWrap._svgCreated){
          const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
          svg.setAttribute('class','railLayer');
          svg.setAttribute('preserveAspectRatio','none');
          svg.setAttribute('aria-hidden','true');
          svg.style.height = '100%';
          svg.style.width = '100%';
          routeWrap._svg = svg;
          routeWrap.appendChild(svg);
          routeWrap._svgCreated = true;
        }

        // 丸（major）
        const dot = document.createElement('div');
        dot.className = 'railDot';
        dot.style.background = '#999';
        dot.dataset.dotId = `p${partIndex}-dot-${mi}-major`;
        dot.dataset.dotType = 'major';
        // 駅名テキスト
        const stationText = document.createElement('div');
        stationText.className = 'stationText';
        stationText.innerHTML = `<div class="stationWithIcons"><div class="stationName">${st}</div></div>
                                 <div class="toggleWrap"><button class="toggleBtn" data-open="false">停車駅を表示</button></div>`;

        railCol.appendChild(dot);
        row.appendChild(railCol);
        row.appendChild(stationText);
        routeWrap.appendChild(row);

        // between（major と次の major の間にある途中駅を挿入）
        const idxInPath = path.indexOf(st);
        const nextMajor = (mi < majorsUnique.length -1) ? majorsUnique[mi+1] : null;
        if(nextMajor){
          const idxNext = path.indexOf(nextMajor);
          const betweenStart = Math.min(idxInPath, idxNext) + 1;
          const betweenEnd = Math.max(idxInPath, idxNext) - 1;
          for(let b = betweenStart; b <= betweenEnd; b++){
            const betweenRow = document.createElement('div');
            betweenRow.className = 'rowBetween';
            const railColB = document.createElement('div');
            railColB.className = 'railCol';
            const minorDot = document.createElement('div');
            minorDot.className = 'railDot';
            minorDot.dataset.dotId = `p${partIndex}-dot-${mi}-between-${b}`;
            minorDot.dataset.dotType = 'minor';
            minorDot.style.background = '#bbb';
            // 小さい見た目用（CSS で rowBetween の railDot を縮小）
            minorDot.style.width = '12px';
            minorDot.style.height = '12px';
            minorDot.style.borderWidth = '2px';
            railColB.appendChild(minorDot);
            const stationTextB = document.createElement('div');
            stationTextB.className = 'stationText';
            stationTextB.innerHTML = `<div class="stationWithIcons"><div class="minorName">${path[b]}</div></div>`;
            betweenRow.appendChild(railColB);
            betweenRow.appendChild(stationTextB);
            routeWrap.appendChild(betweenRow);
          }
        }
      }

      // SVG をカードに挿入（routeWrap._svg を先頭にしてから routeWrap 中身を追加）
      card.appendChild(routeWrap);
      return card;
    }

    // 汎用: カード内の全ドットを取得して SVG に線を描く（中心 to 中心）
    function drawLinesForCard(cardElem, path, partIndex){
      const routeWrap = cardElem.querySelector('.routeLine');
      if(!routeWrap) return;
      const svg = routeWrap._svg;
      if(!svg) return;

      // SVG の高さをカード内の高さに合わせる
      const rect = routeWrap.getBoundingClientRect();
      svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
      svg.style.height = rect.height + 'px';
      svg.style.width = rect.width + 'px';

      // 全ドットを取得（DOM の順序通り path に沿った順序）
      const dots = Array.from(routeWrap.querySelectorAll('.railDot'));
      // map dotId -> center
      const centers = {};
      dots.forEach(d => {
        const r = d.getBoundingClientRect();
        // convert to routeWrap-local coordinates
        const parentRect = routeWrap.getBoundingClientRect();
        const cx = (r.left + r.right)/2 - parentRect.left;
        const cy = (r.top + r.bottom)/2 - parentRect.top;
        centers[d.dataset.dotId] = {cx, cy, type: d.dataset.dotType};
      });

      // 既存の線を消す
      while(svg.firstChild) svg.removeChild(svg.firstChild);

      // Build ordered list of dot ids based on DOM order (we'll draw from first to last)
      const orderedDotIds = dots.map(d => d.dataset.dotId);

      // Draw major lines connecting major-to-major via intermediate minors:
      // We'll draw a continuous polyline from the first dot to the last dot following DOM order,
      // splitting stroke width by dot type to approximate "major" vs "minor" visual.
      // Simpler: draw straight lines between consecutive dots.
      for(let i=0;i<orderedDotIds.length-1;i++){
        const aId = orderedDotIds[i];
        const bId = orderedDotIds[i+1];
        const a = centers[aId];
        const b = centers[bId];
        if(!a || !b) continue;

        // Decide stroke width/color by types
        const tA = a.type, tB = b.type;
        const isMajorSegment = (tA === 'major' && tB === 'major') || (tA === 'major' && tB === 'minor') || (tA === 'minor' && tB === 'major');
        const strokeW = isMajorSegment ? parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lineWMajor')) || 6
                                        : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lineWMinor')) || 4;
        const color = isMajorSegment ? '#cbd5e1' : '#d7e1ea';

        // create line
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', a.cx);
        line.setAttribute('y1', a.cy);
        line.setAttribute('x2', b.cx);
        line.setAttribute('y2', b.cy);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', strokeW);
        line.setAttribute('stroke-linecap', 'round');
        line.setAttribute('opacity', 1.0);
        svg.appendChild(line);
      }

      // Optionally: add a background thin path to simulate multi-color segments.
      // For determinism and to avoid overlap issues we keep a single-color line here.
    }

    // 再描画ユーティリティ（カードごと）
    function layoutAndDrawAll(){
      const cards = Array.from(resultArea.querySelectorAll('.card'));
      cards.forEach((card, idx) => {
        // routeLine 内 path を再構築するために参照しておく（ここでは card.dataset.path を利用）
        const pathJson = card.dataset.path;
        if(!pathJson) return;
        const path = JSON.parse(pathJson);
        // adjust svg viewbox and draw lines
        drawLinesForCard(card, path, idx);
      });
    }

    // 検索処理（簡易：入力された from->via->to を単純に shortest direct の path として扱う）
    // NOTE: ここは最短経路アルゴリズム等を統合する場所です。今回は視覚整合重視で単純化してあります。
    function buildSimplePath(from, viaArr, to){
      // 単純につなげる（from -> via1 -> via2 -> ... -> to）
      const waypoints = [from, ...viaArr, to];
      // 実際の最短経路ロジックが必要なら shortestPath() を組み込んでください。
      // 今回は「表示の正確さ（線が中心をつなぐ）」が目的なので、waypoints 配列のまま返します。
      return waypoints;
    }

    searchBtn.addEventListener('click', ()=>{
      const stationSelectsAll = Array.from(document.querySelectorAll('.stationSelect'));
      const from = stationSelectsAll[0] ? stationSelectsAll[0].value : '';
      const to = stationSelectsAll[stationSelectsAll.length - 1] ? stationSelectsAll[stationSelectsAll.length - 1].value : '';
      const viaSelects = Array.from(viaListDiv.querySelectorAll('.stationSelect'));
      const viaStations = viaSelects.map(s=>s.value).filter(v=>v);

      if(!from || !to){
        resultArea.innerHTML = '<div class="card">駅を選択してください</div>';
        return;
      }
      if(from === to && viaStations.length === 0){
        resultArea.innerHTML = '<div class="card">発駅と着駅が同じです</div>';
        return;
      }

      // path の構築 — 実運用では shortestPath を差し込んでください
      const path = buildSimplePath(from, viaStations, to);

      // クリア
      resultArea.innerHTML = '';

      // ここでは path を 1 パートとして描画（複数パートに分ける場合は parts 配列を作ってループ）
      const partCard = renderRouteCardSVG(path, 0);
      // 保存しておけばリサイズ時に再描画できる
      partCard.dataset.path = JSON.stringify(path);
      resultArea.appendChild(partCard);

      // 少し待ってから（DOM 描画後） SVG をセットアップして線を描く
      setTimeout(()=> {
        layoutAndDrawAll();
        // wire toggle buttons
        partCard.querySelectorAll('.toggleBtn').forEach(btn => {
          btn.addEventListener('click', ()=>{
            const listEls = partCard.querySelectorAll('.rowBetween');
            const visible = getComputedStyle(listEls[0] || {display:'none'}).display !== 'none';
            listEls.forEach(el => el.style.display = visible ? 'none' : 'grid');
            btn.textContent = visible ? '停車駅を表示' : '停車駅を非表示';
            // SVG 再描画（間隔が変わるため）
            setTimeout(()=> layoutAndDrawAll(), 0);
          });
        });
      }, 20);
    });

    // ウィンドウリサイズ時の再描画（SVG を path に合わせる）
    let resizeTimer = null;
    window.addEventListener('resize', ()=>{
      if(resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=> {
        layoutAndDrawAll();
      }, 80);
    });

    // 初期の説明カード
    resultArea.innerHTML = `<div class="card">発駅・着駅を選んで「検索」を押してください。SVG を使って丸の<strong>中心同士が常に結ばれる</strong>よう再設計しています。</div>`;

  } catch (e) {
    console.error('初期化エラー', e);
    document.getElementById('resultArea').innerHTML = `<div class="card" style="color:#b00020">初期化でエラーが発生しました: ${e && e.message}</div>`;
  }
});
</script>
</body>
</html>
