<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>テスト - 駅アイコン表示</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Meiryo, sans-serif;padding:18px;background:#f7fafc;color:#0b1324}
.card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
.stationWithIcons{display:flex;align-items:center;gap:8px}
.stationIcon{width:26px;height:26px;border-radius:4px;object-fit:cover}
.lineBadge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:10px;color:#fff;margin-right:6px}
</style>
</head>
<body>
  <h2>動作確認：駅アイコン＆路線バッジ</h2>
  <div id="resultArea" class="card">結果はここに表示されます</div>

<script>
/* --- エラーハンドラ（画面とコンソールに出す） --- */
window.addEventListener('error', function(ev){
  const msg = ev && (ev.message || (ev.error && ev.error.message)) || String(ev);
  console.error('Window error:', ev);
  const out = document.getElementById('resultArea');
  if(out) out.innerHTML = '<div style="color:#b00020">JS エラー: '+ msg +'</div>';
});
window.addEventListener('unhandledrejection', function(ev){
  console.error('UnhandledRejection', ev);
  const out = document.getElementById('resultArea');
  if(out) out.innerHTML = '<div style="color:#b00020">Promise Rejection: '+ (ev.reason && ev.reason.message || JSON.stringify(ev.reason)) +'</div>';
});

/* --- DOM 準備後に実行 --- */
document.addEventListener('DOMContentLoaded', function(){
  try {

    // テスト用データ（簡素）
    const stationLines = {
      "新里鉄道湯の浜線": ["豊町","新里","湯の浜"],
      "新里鉄道燠野線":   ["湯の浜","燠野"]
    };
    const lineIcons = {
      "新里鉄道湯の浜線": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><rect width='24' height='24' fill='%2300bfff'/></svg>",
      "新里鉄道燠野線":   "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><rect width='24' height='24' fill='%23ff4d6d'/></svg>"
    };
    const stationIcons = {
      "新里鉄道湯の浜線": {
        "新里": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><circle cx='24' cy='24' r='20' fill='%2300bfff'/></svg>",
        "湯の浜": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='48' fill='%2300bfff'/></svg>"
      },
      "新里鉄道燠野線": {
        "湯の浜": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><circle cx='24' cy='24' r='20' fill='%23ff4d6d'/></svg>",
        "燠野": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='48' fill='%23ff4d6d'/></svg>"
      }
    };

    // 優先順
    const niizatoPriority = ["新里鉄道湯の浜線","新里鉄道燠野線","新里鉄道鶴宮線","新里鉄道彩山線","新里鉄道新里線"];

    function findLineOfSegment(a,b){
      for(const [ln, arr] of Object.entries(stationLines)){
        const ia = arr.indexOf(a), ib = arr.indexOf(b);
        if(ia !== -1 && ib !== -1 && Math.abs(ia-ib)===1) return ln;
      }
      return null;
    }

    function getStationIconsForIndex(path, idx){
      const linesSet = new Set();
      if(idx>0){
        const l = findLineOfSegment(path[idx-1], path[idx]);
        if(l) linesSet.add(l);
      }
      if(idx<path.length-1){
        const l = findLineOfSegment(path[idx], path[idx+1]);
        if(l) linesSet.add(l);
      }
      const ordered = niizatoPriority.filter(l => linesSet.has(l)).slice(0,2);
      return ordered.map(l => {
        const stationName = path[idx];
        const img = (stationIcons[l] && stationIcons[l][stationName]) ? stationIcons[l][stationName] : (lineIcons[l] || '');
        return {line:l, src: img};
      });
    }

    // テスト用パス
    const path = ["豊町","新里","湯の浜","燠野"];

    // 描画
    const out = document.getElementById('resultArea');
    let html = '<div><strong>ルート:</strong> ' + path.join(' → ') + '</div><hr>';
    for(let i=0;i<path.length;i++){
      const icons = getStationIconsForIndex(path, i);
      const iconsHtml = icons.map(ic => `<img class="stationIcon" src="${ic.src}" alt="${ic.line}">`).join('');
      html += `<div style="margin:8px 0"><div class="stationWithIcons">${iconsHtml}<div style="font-weight:700">${path[i]}</div></div></div>`;
    }

    html += '<hr><div><strong>使われている路線バッジ例:</strong><div style="margin-top:8px">';
    Object.keys(lineIcons).forEach(l => {
      html += `<span class="lineBadge" style="background:${l==='新里鉄道湯の浜線' ? '#00bfff' : '#ff4d6d'}"><img src="${lineIcons[l]}" width="18" height="18" style="vertical-align:middle;border-radius:3px">${l}</span>`;
    });
    html += '</div></div>';

    out.innerHTML = html;

    console.log('test UI rendered OK');
  } catch(e){
    console.error('init error', e);
    const out = document.getElementById('resultArea');
    if(out) out.innerHTML = '<div style="color:#b00020">初期化エラー: '+ (e && e.message) +'</div>';
  }
});
</script>
</body>
</html>
