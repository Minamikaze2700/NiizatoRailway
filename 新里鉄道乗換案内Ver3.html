<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>路線図 経路表示</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    .station-line {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }
    .circle {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .line {
      flex-grow: 1;
      height: 4px;
      margin: 0 4px;
    }
    .station-info {
      margin-left: 8px;
    }
    .station-name {
      font-weight: bold;
    }
    .route-button {
      margin-top: 2px;
      padding: 2px 6px;
      background: #f0f0f0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body class="p-6">
  <h1 class="text-xl font-bold mb-4">路線検索</h1>
  <div class="mb-4">
    <input id="start" placeholder="出発駅" class="border p-2 mr-2">
    <input id="goal" placeholder="到着駅" class="border p-2 mr-2">
    <button onclick="searchRoute()" class="bg-blue-500 text-white px-4 py-2 rounded">検索</button>
  </div>
  <div id="result"></div>

  <script>
    // 駅・路線データ
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };

    const lineColors = {
      "湯の浜線":"#07b5f7",
      "燠野線":"#fd5062",
      "新里線":"#0cab5e",
      "鶴宮線":"#feac2c",
      "彩山線":"#7dca22"
    };

    // 駅間距離データ（省略なし）
    const rawGraph = {
      "豊町":{"東豊町":1.2},
      "東豊町":{"清水浜":1.4},
      "清水浜":{"安田町":1.9},
      "安田町":{"南栃原":2.2},
      "南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},
      "宇城":{"須川":2.1},
      "須川":{"御浜埼公園":1.9},
      "御浜埼公園":{"御浜":0.6},
      "御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},
      "垳下":{"北浜":2.3},
      "北浜":{"西新里":1.4},
      "西新里":{"新里":1.7},
      "新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},
      "新里海浜公園":{"湯の浜海岸":2.3},
      "湯の浜海岸":{"湯の浜":1.5},
      "湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},
      "那珂町":{"宇多野":2.2},
      "宇多野":{"伊奈崎":1.8},
      "伊奈崎":{"鶴宮神社":1.5},
      "鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},
      "新里大学前":{"綾原":0.7},
      "綾原":{"福来":1.2},
      "福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},
      "湯川":{"温泉口":1.6},
      "温泉口":{"燠野温泉":1.9},
      "南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},
      "橘町":{"燠野山口":1.1},
      "燠野山口":{"白枝":1.2},
      "白枝":{"燠野":1.1},
      "紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},
      "湊川":{"彩山親水公園":1.1},
      "彩山親水公園":{"彩山":1.2},
      "彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},
      "星宮":{"田ノ原":1.1},
      "南新里":{"田ノ原":2.3},
      "田ノ原":{"北玖川":2.4},
      "北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},
      "彩山口":{"新里国際スキー場":3.4},
      "新里国際スキー場":{"鷹見台":10.7},
      "鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},
      "浪原":{"深江":1.4},
      "深江":{"三栗谷":1.3},
      "三栗谷":{"桜川公園":1.5},
      "桜川公園":{"桜川":2.2}
    };

    // 双方向化
    const graph = {};
    for (const [from, targets] of Object.entries(rawGraph)) {
      if (!graph[from]) graph[from] = {};
      for (const [to, d] of Object.entries(targets)) {
        graph[from][to] = d;
        if (!graph[to]) graph[to] = {};
        graph[to][from] = d;
      }
    }

    // 運賃
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ダイクストラ法で最短経路探索
    function shortestPath(start, goal) {
      const dist = {};
      const prev = {};
      const visited = new Set();
      const pq = [];

      for (const node in graph) dist[node] = Infinity;
      dist[start] = 0;
      pq.push([0, start]);

      while (pq.length) {
        pq.sort((a,b)=>a[0]-b[0]);
        const [d,u] = pq.shift();
        if (visited.has(u)) continue;
        visited.add(u);
        if (u===goal) break;
        for (const [v,w] of Object.entries(graph[u])) {
          const nd = d+w;
          if (nd<dist[v]) {
            dist[v]=nd;
            prev[v]=u;
            pq.push([nd,v]);
          }
        }
      }

      const path=[];
      let u=goal;
      while(u){
        path.unshift(u);
        u=prev[u];
      }
      return {path, distance:dist[goal]};
    }

    // 駅が属する路線を返す
    function getLine(station) {
      for (const [line, stations] of Object.entries(stationLines)) {
        if (stations.includes(station)) return line;
      }
      return null;
    }

    // 経路を表示
    function searchRoute() {
      const start=document.getElementById("start").value.trim();
      const goal=document.getElementById("goal").value.trim();
      if(!graph[start]||!graph[goal]) {
        document.getElementById("result").innerHTML="<p class='text-red-500'>駅名が正しくありません</p>";
        return;
      }
      const {path,distance}=shortestPath(start,goal);
      const f=fare(distance);

      let html=`<p>距離: ${distance.toFixed(1)} km / 運賃: 大人${f.adult}円 子供${f.child}円</p>`;

      for (let i=0;i<path.length;i++) {
        const st=path[i];
        const line=getLine(st);
        const color=lineColors[line]||"#999";
        html+=`
          <div class="station-line">
            <div class="circle" style="background:${color}"></div>
            <div class="line" style="background:${color}"></div>
            <div class="station-info">
              <div class="station-name">${st}</div>
              <div>${line}</div>
              <button class="route-button" onclick="toggleStops('${st}','${line}')">途中駅表示</button>
              <div id="stops-${st}" style="display:none"></div>
            </div>
          </div>`;
      }

      document.getElementById("result").innerHTML=html;
    }

    // 途中駅を展開
    function toggleStops(station,line) {
      const div=document.getElementById(`stops-${station}`);
      if (div.style.display==="none") {
        const stations=stationLines[line];
        let html="";
        for (const st of stations) {
          if (st!==station) html+=`<div class="ml-6">${st}</div>`;
        }
        div.innerHTML=html;
        div.style.display="block";
      } else {
        div.style.display="none";
      }
    }
  </script>
</body>
</html>
