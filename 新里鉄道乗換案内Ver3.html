<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道 乗換案内</title>
  <style>
    body { font-family: sans-serif; }
    .diagram { display: flex; }
    .line {
      position: relative;
      margin: 0 20px;
      border-left: 4px solid #000;
    }
    .station {
      position: relative;
      margin: 20px 0;
      padding-left: 20px;
    }
    .station .dot {
      position: absolute;
      left: -10px;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }
    .station-name { font-weight: bold; }
    .line-name {
      display: block;
      padding: 2px 6px;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      margin-top: 4px;
    }
    .toggle-btn {
      display: block;
      margin-top: 5px;
    }
    /* 途中駅用 */
    .intermediate { margin-top: 5px; margin-left: 25px; }
    .intermediate-station {
      position: relative;
      margin: 10px 0 10px 0;
      padding-left: 20px;
      font-size: 14px;
    }
    .intermediate-station .dot {
      position: absolute;
      left: -8px;
      top: 0;
      width: 12px;   /* 主要駅の 75% */
      height: 12px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <h1>新里鉄道 乗換案内</h1>

  <div>
    出発駅:
    <select id="fromLine"></select>
    <select id="fromStation"></select>
    到着駅:
    <select id="toLine"></select>
    <select id="toStation"></select>
    <button onclick="searchRoute()">検索</button>
  </div>

  <div id="result"></div>

  <script>
    // ==== 路線データ ====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮","南鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };

    // ==== 路線カラー ====
    const lineColors = {
      "湯の浜線":"#00bfff",
      "燠野線":"#ff4d6d",
      "鶴宮線":"#ffa500",
      "新里線":"#228b22",
      "彩山線":"#32cd32"
    };

    // ==== 駅間距離データ ====
    const rawGraph = {
      "豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
    };
    for(const a in rawGraph){
      for(const b in rawGraph[a]){
        if(!rawGraph[b]) rawGraph[b] = {};
        rawGraph[b][a] = rawGraph[a][b];
      }
    }

    // ==== 運賃 ====
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ==== UI初期化 ====
    const fromLineSel=document.getElementById("fromLine");
    const fromStationSel=document.getElementById("fromStation");
    const toLineSel=document.getElementById("toLine");
    const toStationSel=document.getElementById("toStation");

    function initSelectors(){
      for(const line in stationLines){
        fromLineSel.add(new Option(line,line));
        toLineSel.add(new Option(line,line));
      }
      fromLineSel.onchange=()=>updateStations(fromLineSel,fromStationSel);
      toLineSel.onchange=()=>updateStations(toLineSel,toStationSel);
      updateStations(fromLineSel,fromStationSel);
      updateStations(toLineSel,toStationSel);
    }
    function updateStations(lineSel,stationSel){
      stationSel.innerHTML="";
      stationLines[lineSel.value].forEach(st=>{
        stationSel.add(new Option(st,st));
      });
    }

    // ==== ダイクストラ ====
    function dijkstra(start,goal){
      let dist={},prev={},Q=new Set();
      for(let v in rawGraph){ dist[v]=Infinity; Q.add(v); }
      dist[start]=0;
      while(Q.size){
        let u=null;
        for(let v of Q){ if(u===null||dist[v]<dist[u]) u=v; }
        if(u===goal) break;
        Q.delete(u);
        for(let v in rawGraph[u]){
          let alt=dist[u]+rawGraph[u][v];
          if(alt<dist[v]){ dist[v]=alt; prev[v]=u; }
        }
      }
      let path=[],u=goal;
      while(u){ path.unshift(u); u=prev[u]; }
      return {path,distance:dist[goal]};
    }

    // ==== 検索 ====
    let lastResult=null;
    function searchRoute(){
      const from=fromStationSel.value,to=toStationSel.value;
      if(!from||!to) return;
      const result=dijkstra(from,to);
      lastResult=result;

      let fareInfo=fare(result.distance);
      document.getElementById("result").innerHTML=
        `<p>距離:${result.distance.toFixed(1)}km 運賃:大人${fareInfo.adult}円 子供${fareInfo.child}円</p>`;

      // 経路図
      let html=`<div class="line">`;
      result.path.forEach((st,i)=>{
        let line=findLine(st);
        let color=lineColors[line]||"#000";
        html+=`<div class="station" data-index="${i}">
          <div class="dot" style="background:${color}"></div>
          <div class="station-name">${st}</div>`;
        if(i===0 || i===result.path.length-1 || isTransfer(st,result.path)){
          html+=`<div class="line-name" style="background:${color}">${line}</div>`;
          if(i<result.path.length-1){
            html+=`<button class="toggle-btn" onclick="toggleIntermediate(this,${i})">途中駅を表示</button>`;
          }
        }
        html+=`</div>`;
      });
      html+=`</div>`;
      document.getElementById("result").innerHTML+=html;
    }

    // ==== 駅の路線判定 ====
    function findLine(st){
      for(const line in stationLines){
        if(stationLines[line].includes(st)) return line;
      }
      return null;
    }
    function isTransfer(st,path){
      let cnt=0;
      for(const line in stationLines){
        if(stationLines[line].includes(st)) cnt++;
      }
      return cnt>1;
    }

    // ==== 途中駅展開 ====
    function toggleIntermediate(btn,index){
      if(btn.nextSibling && btn.nextSibling.classList &&
         btn.nextSibling.classList.contains("intermediate")){
        btn.nextSibling.remove();
        btn.textContent="途中駅を表示";
      }else{
        let from=lastResult.path[index];
        let to=lastResult.path[index+1];
        let line=findLine(from);
        let stations=stationLines[line];
        let i1=stations.indexOf(from),i2=stations.indexOf(to);
        let between=[];
        if(i1<i2) between=stations.slice(i1+1,i2);
        else between=stations.slice(i2+1,i1).reverse();
        let div=document.createElement("div");
        div.className="intermediate";
        div.innerHTML=between.map(s=>
          `<div class="intermediate-station">
             <div class="dot" style="background:${lineColors[line]}"></div>
             <div>${s}</div>
           </div>`
        ).join("");
        btn.parentNode.insertBefore(div,btn.nextSibling);
        btn.textContent="途中駅を非表示";
      }
    }

    initSelectors();
  </script>
</body>
</html>
