<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新里鉄道 乗換案内</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 18px; }
    h1 { font-size: 18px; margin: 0 0 8px; }

    .controls {
      display: grid;
      grid-template-rows: auto auto;
      gap: 8px;
      margin-bottom: 8px;
    }
    .controls label { font-weight: 600; }
    .controls select { margin-left: 6px; margin-right: 6px; padding: 4px 6px; font-size: 14px; }

    .controls-row { display: flex; gap: 12px; align-items: center; margin-top: 8px; }
    #info { font-weight: 600; }
    .info-ok { color: #222; }
    .info-err { color: #c33; }

    #map { width: 100%; border: 1px solid #ddd; border-radius: 10px; margin-top: 22px; }

    .station.major circle.node { r: 8; fill: var(--line-color); }
    .station.minor circle.node { r: 6; fill: var(--line-color); }
    .station.minor text.name { font-size: 14px; fill: #333; text-anchor: start; dominant-baseline: middle; }

    line.segment { stroke-width: 5px; stroke-linecap: round; }
    .line-pill { font-size: 13px; fill: #fff; dominant-baseline: middle; }
    .pill-bg { rx: 6; ry: 6; }
    .seg-btn { font-size: 13px; }
  </style>
</head>
<body>
  <h1>新里鉄道 乗換案内</h1>

  <div class="controls">
    <div>
      <label>出発駅：
        <select id="fromLine"></select>
        <select id="fromStation"></select>
      </label>
    </div>
    <div>
      <label>到着駅：
        <select id="toLine"></select>
        <select id="toStation"></select>
      </label>
    </div>
  </div>

  <div class="controls-row">
    <button id="searchBtn">経路検索</button>
    <span id="info" class="info-ok"></span>
  </div>

  <svg id="map" height="400"></svg>

  <script>
    // ==== 路線データ ====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };
    const lineColors = { "湯の浜線":"#07b5f7", "燠野線":"#fd5062", "新里線":"#0cab5e", "鶴宮線":"#feac2c", "彩山線":"#7dca22" };

    // ==== グラフ（変更不可）====
    const rawGraph = {
      "豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
    };

    // 双方向化
    const graph = {};
    for (const [from, targets] of Object.entries(rawGraph)) {
      if (!graph[from]) graph[from] = {};
      for (const [to, d] of Object.entries(targets)) {
        graph[from][to] = d;
        if (!graph[to]) graph[to] = {};
        graph[to][from] = d;
      }
    }

    // 運賃
    function fare(distance){
      if(distance<=3) return {adult:150,child:80};
      if(distance<=7) return {adult:200,child:100};
      if(distance<=15) return {adult:250,child:130};
      if(distance<=25) return {adult:300,child:150};
      if(distance<=40) return {adult:400,child:200};
      return {adult:500,child:250};
    }

    // UI
    const fromLineSel=document.getElementById('fromLine');
    const toLineSel=document.getElementById('toLine');
    const fromStaSel=document.getElementById('fromStation');
    const toStaSel=document.getElementById('toStation');
    const infoEl=document.getElementById('info');

    function setInfo(msg,isErr=false){
      infoEl.textContent=msg;
      infoEl.className=isErr?'info-err':'info-ok';
    }
    function populateLineSelect(sel){
      for(const l in stationLines){
        const opt=document.createElement('option');
        opt.value=l; opt.textContent=l;
        sel.appendChild(opt);
      }
    }
    function populateStationSelect(lineSel,staSel){
      staSel.innerHTML="";
      const line=lineSel.value;
      if(!line) return;
      for(const s of stationLines[line]){
        const opt=document.createElement('option');
        opt.value=s; opt.textContent=s;
        staSel.appendChild(opt);
      }
    }

    populateLineSelect(fromLineSel);
    populateLineSelect(toLineSel);
    fromLineSel.value="湯の浜線"; populateStationSelect(fromLineSel,fromStaSel); fromStaSel.value="新里";
    toLineSel.value="燠野線"; populateStationSelect(toLineSel,toStaSel); toStaSel.value="燠野温泉";

    fromLineSel.addEventListener('change',()=>populateStationSelect(fromLineSel,fromStaSel));
    toLineSel.addEventListener('change',()=>populateStationSelect(toLineSel,toStaSel));

    // 経路探索（ダイクストラ）
    function shortestPath(start,goal){
      const dist={}, prev={}, pq=[];
      for(const v in graph){ dist[v]=Infinity; }
      dist[start]=0; pq.push([0,start]);
      while(pq.length){
        pq.sort((a,b)=>a[0]-b[0]);
        const [d,u]=pq.shift();
        if(u===goal) break;
        if(d>dist[u]) continue;
        for(const [v,w] of Object.entries(graph[u])){
          const nd=d+w;
          if(nd<dist[v]){
            dist[v]=nd;
            prev[v]=u;
            pq.push([nd,v]);
          }
        }
      }
      const path=[]; let u=goal;
      while(u){ path.unshift(u); u=prev[u]; }
      return {path,distance:dist[goal]};
    }

    // SVGクリア
    const svg=document.getElementById('map');
    function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

    // 途中駅表示状態
    const segToggle=new Map();

    // 駅描画
    function drawStation({name,x,y,isMajor,line}){
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class',isMajor?'station major':'station minor');
      g.setAttribute('transform',`translate(${x},${y})`);
      if(line) g.style.setProperty('--line-color',lineColors[line]||'#999');
      const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('class','node');
      g.appendChild(circle);
      if(!isMajor){
        const text=document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('class','name');
        text.setAttribute('x',15);
        text.setAttribute('y',0);
        text.setAttribute('dominant-baseline','middle');
        text.textContent=name;
        g.appendChild(text);
      }
      svg.appendChild(g);
    }

    // 経路描画（中央揃え版）
    function drawRoute(path){
      clearSVG();
      if(!path.length) return;
      const cx=100;
      let offsetY=40;
      const basePad=30;
      const ys=[offsetY];

      // 駅の座標を計算
      for(let i=1;i<path.length;i++){
        offsetY+=basePad;
        ys.push(offsetY);
      }

      // 線分
      for(let i=0;i<path.length-1;i++){
        const line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',cx); line.setAttribute('y1',ys[i]);
        line.setAttribute('x2',cx); line.setAttribute('y2',ys[i+1]);
        line.setAttribute('class','segment');
        const lineName=findLine(path[i],path[i+1]);
        line.setAttribute('stroke',lineColors[lineName]||'#999');
        svg.appendChild(line);
      }

      // 駅・ラベル描画
      for(let i=0;i<path.length;i++){
        const name=path[i];
        drawStation({name,x:cx,y:ys[i],isMajor:true,line:findLine(path[i-1],path[i])||findLine(path[i],path[i+1])});
        if(i<path.length-1){
          let offsetYmid=ys[i]+20;

          // 路線ラベル
          const lineName=findLine(path[i],path[i+1]);
          if(lineName){
            const color=lineColors[lineName];
            const g=document.createElementNS('http://www.w3.org/2000/svg','g');
            g.setAttribute('transform',`translate(0,${offsetYmid})`);
            const text=document.createElementNS('http://www.w3.org/2000/svg','text');
            text.setAttribute('class','line-pill');
            text.setAttribute('x',cx+20);
            text.setAttribute('dominant-baseline','middle');
            text.textContent=`新里鉄道${lineName}`;
            g.appendChild(text);
            const bbox=text.getBBox();
            const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
            rect.setAttribute('class','pill-bg');
            rect.setAttribute('x',bbox.x-6);
            rect.setAttribute('y',bbox.y-10);
            rect.setAttribute('width',bbox.width+12);
            rect.setAttribute('height',bbox.height+6);
            rect.setAttribute('fill',color);
            g.insertBefore(rect,text);
            svg.appendChild(g);
            offsetYmid+=20;

            // ボタン
            const fo=document.createElementNS('http://www.w3.org/2000/svg','foreignObject');
            fo.setAttribute('x',cx+20);
            fo.setAttribute('y',offsetYmid-14);
            fo.setAttribute('width',140);
            fo.setAttribute('height',28);
            const div=document.createElementNS('http://www.w3.org/1999/xhtml','div');
            div.className='seg-btn';
            const key=`${path[i]}-${path[i+1]}`;
            const on=!!segToggle.get(key);
            div.textContent=on?'途中駅を非表示':'途中駅を表示';
            div.style.cursor='pointer';
            div.style.background='#f3f3f3';
            div.style.border='1px solid #ccc';
            div.style.borderRadius='6px';
            div.style.display='inline-block';
            div.style.padding='2px 6px';
            div.addEventListener('click',()=>{
              segToggle.set(key,!segToggle.get(key));
              drawRoute(path);
            });
            fo.appendChild(div);
            svg.appendChild(fo);
            offsetYmid+=30;

            // 途中駅
            if(segToggle.get(key)){
              const subs=getSubs(lineName,path[i],path[i+1]);
              for(let j=0;j<subs.length;j++){
                const subY=offsetYmid+(j*30);
                drawStation({name:subs[j],x:cx,y:subY,isMajor:false,line:lineName});
              }
              offsetYmid+=subs.length*30;
            }
          }
        }
      }
    }

    function findLine(a,b){
      for(const l in stationLines){
        const arr=stationLines[l];
        if(arr.includes(a)&&arr.includes(b)) return l;
      }
      return null;
    }
    function getSubs(line,a,b){
      const arr=stationLines[line];
      const ia=arr.indexOf(a), ib=arr.indexOf(b);
      if(ia<0||ib<0) return [];
      if(ia<ib) return arr.slice(ia+1,ib);
      else return arr.slice(ib+1,ia).reverse();
    }

    // ボタン動作
    document.getElementById('searchBtn').addEventListener('click',()=>{
      const from=fromStaSel.value, to=toStaSel.value;
      if(!from||!to){ setInfo('駅を選択してください',true); return; }
      const {path,distance}=shortestPath(from,to);
      if(!path.length){ setInfo('経路が見つかりません',true); clearSVG(); return; }
      const f=fare(distance);
      setInfo(`距離:${distance.toFixed(1)}km　運賃:大人${f.adult}円 子供${f.child}円`);
      drawRoute(path);
    });

    // 初期表示
    document.getElementById('searchBtn').click();
  </script>
</body>
</html>
