<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新里鉄道路線 ルート検索</title>
  <style>
    :root{
      --major-r: 8px;      /* 主要駅 ● 半径 */
      --minor-r: 6px;     /* 途中駅 ● 半径（主要の75%） */
      --seg-width: 5px;     /* 区間線の太さ */
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', Meiryo, sans-serif; margin: 18px; }
    h1 { font-size: 18px; margin: 0 0 8px; }

    /* コントロール */
    .controls { display: grid; grid-template-columns: auto auto; gap: 8px 12px; align-items: center; }
    .controls select, .controls button { padding: 6px 8px; font-size: 14px; }
    .controls-row { display: grid; grid-template-columns: auto auto auto; gap: 8px 12px; align-items: center; margin-top: 8px; }
    #info { font-weight: 600; }

    /* 描画領域 */
    #map { width: 100%; border: 1px solid #ddd; border-radius: 10px; margin-top: 12px; }

    /* ラベル */
    .label text.name { font-size: 20px; dominant-baseline: central; }
    .label .line-pill { font-size: 13px; dominant-baseline: hanging; fill: #fff; }
    .pill-bg { rx: 6; ry: 6; }

    /* 駅 ● */
    .station.major circle.node { r: var(--major-r); fill: var(--line-color); stroke: var(--line-color); stroke-width: 0; }
    .station.minor circle.node { r: var(--minor-r); fill: var(--line-color); stroke: var(--line-color); stroke-width: 0; }
    .station.minor text.name { font-size: 15px; fill: #333; dominant-baseline: central; }

    /* 区間線 */
    line.segment { stroke-width: var(--seg-width); stroke-linecap: round; }

    /* 途中駅トグルボタン */
    .seg-btn { font-size: 13px; padding: 2px 6px; margin-left: 8px; }
  </style>
</head>
<body>
  <h1>新里鉄道路線 ルート検索</h1>
  <div class="controls">
    <label>出発路線：<select id="fromLine"></select></label>
    <label>出発駅：<select id="fromStation"></select></label>
    <label>到着路線：<select id="toLine"></select></label>
    <label>到着駅：<select id="toStation"></select></label>
  </div>
  <div class="controls-row">
    <button id="searchBtn">経路検索</button>
    <span id="info"></span>
  </div>

  <svg id="map" height="400"></svg>

  <script>
    // ==== 駅・路線データ（変更不可・そのまま使用）====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };
    const lineColors = {
      "湯の浜線":"#07b5f7",
      "燠野線":"#fd5062",
      "新里線":"#0cab5e",
      "鶴宮線":"#feac2c",
      "彩山線":"#7dca22"
    };

    // ==== 駅間距離データ（双方向展開）====
    const rawGraph = {
      "豊町":{"東豊町":1.2},
      "東豊町":{"清水浜":1.4},
      "清水浜":{"安田町":1.9},
      "安田町":{"南栃原":2.2},
      "南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},
      "宇城":{"須川":2.1},
      "須川":{"御浜埼公園":1.9},
      "御浜埼公園":{"御浜":0.6},
      "御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},
      "垳下":{"北浜":2.3},
      "北浜":{"西新里":1.4},
      "西新里":{"新里":1.7},
      "新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},
      "新里海浜公園":{"湯の浜海岸":2.3},
      "湯の浜海岸":{"湯の浜":1.5},
      "湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},
      "那珂町":{"宇多野":2.2},
      "宇多野":{"伊奈崎":1.8},
      "伊奈崎":{"鶴宮神社":1.5},
      "鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},
      "新里大学前":{"綾原":0.7},
      "綾原":{"福来":1.2},
      "福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},
      "湯川":{"温泉口":1.6},
      "温泉口":{"燠野温泉":1.9},
      "南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},
      "橘町":{"燠野山口":1.1},
      "燠野山口":{"白枝":1.2},
      "白枝":{"燠野":1.1},
      "紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},
      "湊川":{"彩山親水公園":1.1},
      "彩山親水公園":{"彩山":1.2},
      "彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},
      "星宮":{"田ノ原":1.1},
      "南新里":{"田ノ原":2.3},
      "田ノ原":{"北玖川":2.4},
      "北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},
      "彩山口":{"新里国際スキー場":3.4},
      "新里国際スキー場":{"鷹見台":10.7},
      "鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},
      "浪原":{"深江":1.4},
      "深江":{"三栗谷":1.3},
      "三栗谷":{"桜川公園":1.5},
      "桜川公園":{"桜川":2.2}
    };
    const graph = {};
    for (const [from, targets] of Object.entries(rawGraph)) {
      if (!graph[from]) graph[from] = {};
      for (const [to, d] of Object.entries(targets)) {
        graph[from][to] = d;
        if (!graph[to]) graph[to] = {};
        graph[to][from] = d;
      }
    }

    // ==== 運賃 ====
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ==== UI初期化 ====
    const fromLineSel = document.getElementById('fromLine');
    const toLineSel   = document.getElementById('toLine');
    const fromStaSel  = document.getElementById('fromStation');
    const toStaSel    = document.getElementById('toStation');

    function populateLineSelect(sel){
      sel.innerHTML='';
      Object.keys(stationLines).forEach(l=> sel.add(new Option(l,l)));
      sel.selectedIndex=0;
    }
    function populateStationSelect(lineSel, staSel){
      staSel.innerHTML='';
      (stationLines[lineSel.value]||[]).forEach(s=> staSel.add(new Option(s,s)));
      staSel.selectedIndex=0;
    }

    populateLineSelect(fromLineSel);
    populateStationSelect(fromLineSel, fromStaSel);
    populateLineSelect(toLineSel);
    populateStationSelect(toLineSel, toStaSel);

    fromLineSel.addEventListener('change',()=>populateStationSelect(fromLineSel, fromStaSel));
    toLineSel.addEventListener('change',()=>populateStationSelect(toLineSel, toStaSel));

    // ==== 経路探索（ダイクストラ）====
    function shortestPath(start, goal){
      const dist={}, prev={};
      const Q=new Set(Object.keys(graph));
      Object.keys(graph).forEach(s=>dist[s]=Infinity);
      dist[start]=0;
      while(Q.size){
        let u=null, best=Infinity;
        for(const n of Q){ if(dist[n]<best){best=dist[n]; u=n;} }
        if(u===null) break;
        Q.delete(u);
        if(u===goal) break;
        for(const [v,w] of Object.entries(graph[u]||{})){
          const alt=dist[u]+w;
          if(alt<dist[v]){ dist[v]=alt; prev[v]=u; }
        }
      }
      const path=[];
      let u=goal;
      while(u){ path.unshift(u); u=prev[u]; }
      return { path, distance: dist[goal] };
    }

    // ==== 区間の路線名（majors[i]→majors[i+1] に使う路線）====
    function segmentLineBetween(fullPath, a, b){
      const i1 = fullPath.indexOf(a);
      const i2 = fullPath.indexOf(b);
      for(let i=i1; i<i2; i++){
        const ln = findAdjacentLine(fullPath[i], fullPath[i+1]);
        if(ln) return ln;
      }
      return null;
    }

    function findAdjacentLine(a,b){
      for(const [line, arr] of Object.entries(stationLines)){
        const ia=arr.indexOf(a), ib=arr.indexOf(b);
        if(ia!==-1 && ib!==-1 && Math.abs(ia-ib)===1) return line;
      }
      return null;
    }

    function extractMajorStations(path){
      if(path.length===0) return [];
      const majors=[path[0]];
      for(let i=1;i<path.length-1;i++){
        const l1=findAdjacentLine(path[i-1],path[i]);
        const l2=findAdjacentLine(path[i],path[i+1]);
        if(l1!==l2) majors.push(path[i]);
      }
      majors.push(path[path.length-1]);
      return majors;
    }

    // ==== SVG 描画 ====
    const mapSVG = document.getElementById('map');

    function drawRoute(fullPath){
      mapSVG.innerHTML='';
      if(fullPath.length<2) return;
      const n=fullPath.length;
      const margin=60;
      const w=mapSVG.clientWidth;
      const h=mapSVG.clientHeight;
      const dx=(w-2*margin)/(n-1);
      const centerY=h/2;

      const coords={};
      fullPath.forEach((name,idx)=>{
        coords[name]={ x: margin+dx*idx, y: centerY };
      });

      for(let i=0;i<n-1;i++){
        const a=fullPath[i], b=fullPath[i+1];
        const lineName=findAdjacentLine(a,b);
        const color=lineColors[lineName]||'#888';
        const p1=coords[a], p2=coords[b];
        const seg=document.createElementNS('http://www.w3.org/2000/svg','line');
        seg.setAttribute('x1',p1.x);
        seg.setAttribute('y1',p1.y);
        seg.setAttribute('x2',p2.x);
        seg.setAttribute('y2',p2.y);
        seg.setAttribute('class','segment');
        seg.setAttribute('stroke',color);
        mapSVG.appendChild(seg);
      }

      fullPath.forEach(name=>{
        const p=coords[name];
        const stn=document.createElementNS('http://www.w3.org/2000/svg','g');
        stn.setAttribute('class','station minor');
        const circ=document.createElementNS('http://www.w3.org/2000/svg','circle');
        circ.setAttribute('class','node');
        circ.setAttribute('cx',p.x);
        circ.setAttribute('cy',p.y);
        const label=document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('class','name');
        label.setAttribute('x',p.x);
        label.setAttribute('y',p.y - 18);
        label.setAttribute('text-anchor','middle');
        label.textContent=name;
        stn.appendChild(circ);
        stn.appendChild(label);
        mapSVG.appendChild(stn);
      });
    }

    // ==== イベント ====
    document.getElementById('searchBtn').addEventListener('click',()=>{
      const from=fromStaSel.value;
      const to=toStaSel.value;
      if(!from || !to){ alert('出発駅と到着駅を選択してください'); return; }
      const result=shortestPath(from,to);
      if(!result.path.length){ alert('経路が見つかりません'); return; }
      const majors=extractMajorStations(result.path);
      const total=result.distance;
      const fareObj=fare(total);
      const infoText=`距離：約${total.toFixed(1)}km　運賃：大人${fareObj.adult}円／子供${fareObj.child}円`;
      document.getElementById('info').textContent=infoText;
      drawRoute(result.path);
    });
  </script>
</body>
</html>
