<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道 乗換案内</title>
  <style>
    body { font-family: sans-serif; }
    .seg-btn {
      font-size: 12px;
      background: #f3f3f3;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: inline-block;
      padding: 2px 6px;
    }
  </style>
</head>
<body>
  <h1>新里鉄道 乗換案内</h1>
  出発駅:
  <select id="fromLine"></select><select id="fromStation"></select>
  到着駅:
  <select id="toLine"></select><select id="toStation"></select>
  <button id="searchBtn">検索</button>
  <div id="result"></div>
  <svg id="map" width="400" height="800"></svg>

  <script>
    // ==== 駅・路線データ（変更不可）====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["新里","田ノ原","北玖川","玖川","中野原","彩山"],
      "彩山線":["彩山","蓮華寺","星宮","田ノ原","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };

    const lineColors = {
      "湯の浜線":"#07b5f7",
      "燠野線":"#e74c3c",
      "鶴宮線":"#f39c12",
      "彩山線":"#27ae60"
    };

    // ==== グラフデータ ====
    const rawGraph = {
      "豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
    };

    // ==== 運賃 ====
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ==== 最短経路探索 ====
    function shortestPath(start,goal){
      const dist={},prev={},Q=new Set(Object.keys(rawGraph));
      for(const v of Q) dist[v]=Infinity;
      dist[start]=0;
      while(Q.size){
        let u=null,du=Infinity;
        for(const v of Q){ if(dist[v]<du){du=dist[v];u=v;} }
        if(u===goal) break;
        Q.delete(u);
        for(const v in rawGraph[u]){
          const alt=dist[u]+rawGraph[u][v];
          if(alt<dist[v]){dist[v]=alt;prev[v]=u;}
        }
      }
      const path=[];
      let u=goal;
      while(u){path.unshift(u);u=prev[u];}
      return {path,distance:dist[goal]};
    }

    // ==== SVG描画 ====
    const svg=document.getElementById("map");
    let segToggle=new Map();

    function drawStation({name,x,y,isMajor,line}){
      const g=document.createElementNS("http://www.w3.org/2000/svg","g");
      const circle=document.createElementNS("http://www.w3.org/2000/svg","circle");
      circle.setAttribute("cx",x);
      circle.setAttribute("cy",y);
      circle.setAttribute("r",isMajor?8:6);
      circle.setAttribute("fill","#fff");
      circle.setAttribute("stroke",lineColors[line]||"#000");
      circle.setAttribute("stroke-width",3);
      g.appendChild(circle);
      const text=document.createElementNS("http://www.w3.org/2000/svg","text");
      text.setAttribute("x",x+20);
      text.setAttribute("y",y+4);
      text.textContent=name;
      g.appendChild(text);
      svg.appendChild(g);
    }

    function findLine(a,b){
      if(!a||!b) return null;
      for(const [line,sts] of Object.entries(stationLines)){
        const i=sts.indexOf(a);
        if(i>=0 && sts[i+1]===b || sts[i-1]===b) return line;
      }
      return null;
    }

    function getSubs(line,a,b){
      const arr=stationLines[line];
      const ia=arr.indexOf(a),ib=arr.indexOf(b);
      if(ia<0||ib<0) return [];
      if(ia<ib) return arr.slice(ia+1,ib);
      else return arr.slice(ib+1,ia).reverse();
    }

    function drawRoute(path){
      svg.innerHTML="";
      const cx=40;
      const ys=[];
      const segLen=60;
      for(let i=0;i<path.length;i++) ys.push(40+i*segLen);

      for(let i=0;i<path.length-1;i++){
        const a=path[i],b=path[i+1];
        const line=findLine(a,b);
        const lineElem=document.createElementNS("http://www.w3.org/2000/svg","line");
        lineElem.setAttribute("x1",cx);
        lineElem.setAttribute("y1",ys[i]);
        lineElem.setAttribute("x2",cx);
        lineElem.setAttribute("y2",ys[i+1]);
        lineElem.setAttribute("stroke",lineColors[line]||"#000");
        lineElem.setAttribute("stroke-width",6);
        svg.appendChild(lineElem);
      }

      for(let i=0;i<path.length;i++){
        const name=path[i];
        const prevLine=findLine(path[i-1],path[i]);
        const nextLine=findLine(path[i],path[i+1]);

        if(i===0 || i===path.length-1 || (prevLine && nextLine && prevLine!==nextLine)){
          drawStation({name,x:cx,y:ys[i],isMajor:true,line:prevLine||nextLine});
        }

        if(i<path.length-1){
          const lineName=findLine(path[i],path[i+1]);
          if(lineName){
            const key=`${path[i]}-${path[i+1]}`;
            let offsetYmid=ys[i]+20;

            const fo=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");
            fo.setAttribute("x",cx+20);
            fo.setAttribute("y",offsetYmid-14);
            fo.setAttribute("width",140);
            fo.setAttribute("height",28+20); // 20px余白
            const div=document.createElementNS("http://www.w3.org/1999/xhtml","div");
            div.className="seg-btn";
            const on=!!segToggle.get(key);
            div.textContent=on?"途中駅を非表示":"途中駅を表示";
            div.style.cursor="pointer";
            div.addEventListener("click",()=>{
              segToggle.set(key,!segToggle.get(key));
              drawRoute(path);
            });
            fo.appendChild(div);
            svg.appendChild(fo);

            if(segToggle.get(key)){
              const subs=getSubs(lineName,path[i],path[i+1]);
              for(let j=0;j<subs.length;j++){
                const subY=ys[i]+((j+1)*(ys[i+1]-ys[i])/(subs.length+1));
                drawStation({name:subs[j],x:cx,y:subY,isMajor:false,line:lineName});
              }
            }
          }
        }
      }
    }

    // ==== UI構築 ====
    function populateStations(selLine,selStation){
      selStation.innerHTML="";
      const line=selLine.value;
      if(!line)return;
      for(const st of stationLines[line]){
        const opt=document.createElement("option");
        opt.value=st;opt.textContent=st;
        selStation.appendChild(opt);
      }
    }

    const fromLine=document.getElementById("fromLine");
    const fromStation=document.getElementById("fromStation");
    const toLine=document.getElementById("toLine");
    const toStation=document.getElementById("toStation");

    for(const l in stationLines){
      for(const sel of [fromLine,toLine]){
        const opt=document.createElement("option");
        opt.value=l;opt.textContent=l;
        sel.appendChild(opt.cloneNode(true));
      }
    }

    fromLine.addEventListener("change",()=>populateStations(fromLine,fromStation));
    toLine.addEventListener("change",()=>populateStations(toLine,toStation));

    document.getElementById("searchBtn").addEventListener("click",()=>{
      const s=fromStation.value,g=toStation.value;
      if(!s||!g)return;
      const {path}=shortestPath(s,g);
      segToggle=new Map();
      drawRoute(path);
    });

    fromLine.value="湯の浜線";
    populateStations(fromLine,fromStation);
    fromStation.value="新里";
    toLine.value="燠野線";
    populateStations(toLine,toStation);
    toStation.value="燠野温泉";
    document.getElementById("searchBtn").click();
  </script>
</body>
</html>
