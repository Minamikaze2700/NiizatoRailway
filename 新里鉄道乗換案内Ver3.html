<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新里鉄道路線 ルート検索</title>
  <style>
    :root {
      --major-r: 8px;    /* 主要駅 ● 半径 */
      --minor-r: 6.5px;  /* 途中駅 ● 半径 */
      --seg-width: 5px;  /* 線の太さ */
    }
    body {
      font-family: sans-serif;
    }
    #controls {
      margin-bottom: 1em;
    }
    #result {
      margin-top: 1em;
      color: red; /* エラーを赤字で */
      font-weight: bold;
    }
    .line-toggle {
      margin: 0.5em 0;
      display: block;
    }
  </style>
</head>
<body>
  <h1>新里鉄道路線 ルート検索</h1>

  <div id="controls">
    <label>出発路線:
      <select id="start-line"></select>
    </label>
    <label>出発駅:
      <select id="start-station"></select>
    </label>
    <br/>
    <label>到着路線:
      <select id="goal-line"></select>
    </label>
    <label>到着駅:
      <select id="goal-station"></select>
    </label>
    <br/>
    <button id="search">検索</button>
  </div>

  <div id="line-toggles"></div>

  <svg id="map" width="900" height="700"></svg>

  <div id="result"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // ==== 駅・路線データ（変更不可・そのまま使用）====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };
    const lineColors = {
      "湯の浜線":"#07b5f7",
      "燠野線":"#fd5062",
      "新里線":"#0cab5e",
      "鶴宮線":"#feac2c",
      "彩山線":"#7dca22"
    };

    const svg = d3.select("#map");

    // ==== 駅配置用の座標例（簡易配置、必要なら調整可）====
    const lineCoords = {};
    Object.keys(stationLines).forEach((line, idx) => {
      lineCoords[line] = stationLines[line].map((st, i) => ({
        x: 100 + i * 30,
        y: 100 + idx * 100
      }));
    });

    // ==== 路線の描画 ====
    function drawMap(startStation, goalStation) {
      svg.selectAll("*").remove();

      const interchangeStations = findInterchangeStations();

      Object.keys(stationLines).forEach(line => {
        const stations = stationLines[line];
        const coords = lineCoords[line];

        // 線
        svg.append("path")
          .datum(coords)
          .attr("fill", "none")
          .attr("stroke", lineColors[line])
          .attr("stroke-width", 5)
          .attr("d", d3.line().x(d => d.x).y(d => d.y));

        // 停車駅
        coords.forEach((c, i) => {
          svg.append("circle")
            .attr("cx", c.x)
            .attr("cy", c.y)
            .attr("r", stations[i] === startStation || stations[i] === goalStation ? 8 : 6)
            .attr("fill", "white")
            .attr("stroke", lineColors[line])
            .attr("stroke-width", 3);
        });

        // 駅ラベル
        drawStationLabels(svg, line, stations, coords, startStation, goalStation, interchangeStations);
      });
    }

    // ==== 駅ラベル ====
    function drawStationLabels(svg, lineName, stations, lineCoords, startStation, goalStation, interchangeStations) {
      stations.forEach((station, i) => {
        const x = lineCoords[i].x;
        const y = lineCoords[i].y;
        const isStartOrGoal = (station === startStation || station === goalStation);
        const isInterchange = interchangeStations.includes(station);
        const fontSize = (isStartOrGoal || isInterchange) ? "20px" : "12px";

        svg.append("text")
          .attr("x", x + 10)
          .attr("y", y - 5)
          .attr("font-size", fontSize)
          .attr("fill", "black")
          .text(station);
      });
    }

    // ==== 乗換駅を探す ====
    function findInterchangeStations() {
      const count = {};
      for (const line in stationLines) {
        stationLines[line].forEach(st => {
          count[st] = (count[st] || 0) + 1;
        });
      }
      return Object.keys(count).filter(st => count[st] > 1);
    }

    // ==== 発着駅セレクトの準備 ====
    function setupStationSelectors() {
      const startLineSel = document.getElementById("start-line");
      const startStationSel = document.getElementById("start-station");
      const goalLineSel = document.getElementById("goal-line");
      const goalStationSel = document.getElementById("goal-station");

      // 路線を追加
      Object.keys(stationLines).forEach(line => {
        startLineSel.add(new Option(line, line));
        goalLineSel.add(new Option(line, line));
      });

      // 路線選択時に駅セレクトを更新
      startLineSel.addEventListener("change", () => {
        updateStationOptions(startLineSel.value, startStationSel);
      });
      goalLineSel.addEventListener("change", () => {
        updateStationOptions(goalLineSel.value, goalStationSel);
      });

      // 初期状態
      updateStationOptions(startLineSel.value, startStationSel);
      updateStationOptions(goalLineSel.value, goalStationSel);
    }

    function updateStationOptions(line, stationSel) {
      stationSel.innerHTML = "";
      stationLines[line].forEach(st => {
        stationSel.add(new Option(st, st));
      });
    }

    // ==== 停車駅表示切替ボタン ====
    function setupLineToggles() {
      const div = document.getElementById("line-toggles");
      div.innerHTML = "";
      Object.keys(stationLines).forEach(line => {
        const btn = document.createElement("button");
        btn.textContent = line + " の停車駅表示切替";
        btn.className = "line-toggle";
        btn.onclick = () => {
          const texts = svg.selectAll("text").filter(function() {
            return d3.select(this).text() && stationLines[line].includes(d3.select(this).text());
          });
          const hidden = texts.style("display") === "none";
          texts.style("display", hidden ? "block" : "none");
        };
        div.appendChild(btn);
      });
    }

    // ==== 検索ボタン ====
    document.getElementById("search").addEventListener("click", () => {
      const startStation = document.getElementById("start-station").value;
      const goalStation = document.getElementById("goal-station").value;
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "";

      if (!startStation || !goalStation) {
        resultDiv.textContent = "出発駅と到着駅を選んでください。";
        return;
      }
      if (startStation === goalStation) {
        resultDiv.textContent = "出発駅と到着駅が同じです。";
        return;
      }

      // 仮ルート検索（経路探索は未実装）
      drawMap(startStation, goalStation);
    });

    // ==== 初期化 ====
    setupStationSelectors();
    setupLineToggles();
    drawMap(null, null);
  </script>
</body>
</html>
