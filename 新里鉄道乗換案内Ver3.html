<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>新里鉄道 乗換案内</title>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 950px; }
h2 { margin-bottom: 10px; }
.route-line { color: white; padding: 2px 6px; border-radius: 4px; margin: 0 4px; }
.route { margin: 6px 0; }
select { margin: 0 10px 0 0; padding: 2px; }
button { padding: 2px 6px; }
#result { margin-top: 12px; max-height: 600px; overflow-y: auto; border:1px solid #ccc; padding:6px; }

/* 新しい出力デザイン */
.route-container { display: flex; flex-direction: column; margin: 10px 0; }
.route-row { display: flex; align-items: flex-start; margin: 4px 0; position: relative; }
.route-marker { width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; position: relative; flex: 0 0 16px; }
.route-marker.small { width: 10px; height: 10px; flex-basis: 10px; }
.route-line-vertical { position: absolute; left: 50%; top: 16px; width: 2px; height: calc(100% - 16px); transform: translateX(-50%); }
.station-label { display: flex; flex-direction: column; }
.station-name { font-size: 14px; font-weight: bold; }
.station-line { font-size: 12px; color: #fff; padding:2px 6px; border-radius:4px; margin-top:2px; display: inline-block; }
.hidden { display: none; }
.toggle-btn { font-size: 12px; margin-top: 2px; }
.error { color: #c00; font-weight: bold; }
</style>
</head>
<body>
<h2>新里鉄道 乗換案内</h2>

<label>発路線:
<select id="startLine" onchange="updateStations('start')"></select>
</label>
<label>発駅:
<select id="start"></select>
</label>
<br><br>
<label>着路線:
<select id="goalLine" onchange="updateStations('goal')"></select>
</label>
<label>着駅:
<select id="goal"></select>
</label>
<br><br>
<button onclick="showAllRoutes()">検索</button>

<div id="result"></div>

<script>
// --- 駅・路線データ ---
const stationLines = {
"湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
"燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
"鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
"新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
"彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
};

const lineColors = {
"湯の浜線":"#07b5f7",
"燠野線":"#fd5062",
"新里線":"#0cab5e",
"鶴宮線":"#feac2c",
"彩山線":"#7dca22"
};

// --- 駅間距離 ---
const rawGraph = {
"豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},
"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},"栃原":{"宇城":2.2},
"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},
"御浜":{"伊坂":2.5},"伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},
"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},"河岸":{"新里海浜公園":1.7},
"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
"七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},
"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},"鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},
"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
"燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},
"南鶴宮":{"あずさ台":1.4},"あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},
"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
"桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},
"彩山":{"蓮華寺":0.8,"彩山口":2.1},"蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},
"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},"玖川":{"中野原":3.1},
"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},
"鷹見台":{"久我原":2.7},"久我原":{"浪原":1.5},"浪原":{"深江":1.4},
"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
};

// --- グラフ整形 ---
const graph = {};
for (let s in rawGraph){
  if(!graph[s]) graph[s]={};
  for (let t in rawGraph[s]){
    let d = rawGraph[s][t];
    graph[s][t]=d;
    if(!graph[t]) graph[t]={};
    graph[t][s]=d;
  }
}

// --- UI初期化 ---
window.onload = ()=>{
  for(let line in stationLines){
    let opt1=document.createElement("option"); opt1.value=line; opt1.text=line;
    document.getElementById("startLine").appendChild(opt1);
    let opt2=document.createElement("option"); opt2.value=line; opt2.text=line;
    document.getElementById("goalLine").appendChild(opt2);
  }
  updateStations("start"); updateStations("goal");
};
function updateStations(which){
  let line=document.getElementById(which+"Line").value;
  let sel=document.getElementById(which);
  sel.innerHTML="";
  stationLines[line].forEach(st=>{
    let o=document.createElement("option"); o.value=st; o.text=st; sel.appendChild(o);
  });
}

// --- ダイクストラ ---
function shortestPath(start,goal){
  let dist={}, prev={}, visited={};
  for(let s in graph){ dist[s]=Infinity; prev[s]=null; }
  dist[start]=0;
  while(true){
    let u=null, min=Infinity;
    for(let s in dist){ if(!visited[s] && dist[s]<min){min=dist[s]; u=s;} }
    if(u===null||u===goal) break;
    visited[u]=true;
    for(let v in graph[u]){
      let alt=dist[u]+graph[u][v];
      if(alt<dist[v]){ dist[v]=alt; prev[v]=u; }
    }
  }
  let path=[], u=goal;
  while(u){ path.unshift(u); u=prev[u]; }
  return {path, distance:dist[goal]};
}

// --- 路線判定 ---
function findLine(st1,st2){
  for(let line in stationLines){
    let arr=stationLines[line];
    if(arr.includes(st1)&&arr.includes(st2)) return line;
  }
  return null;
}

/* ▼ 途中駅表示トグル用のグローバル状態（デフォルト非表示） ▼ */
let showIntermediate = false;

// --- 検索結果表示 ---
function showAllRoutes(){
  const start=document.getElementById("start").value;
  const goal=document.getElementById("goal").value;
  const result=document.getElementById("result");
  result.innerHTML="";

  // 同一駅エラー
  if(start===goal){
    result.innerHTML = "<p class='error'>発駅と着駅が同じです</p>";
    return;
  }

  const res=shortestPath(start,goal);
  if(!res.path || !res.path.length || !isFinite(res.distance)){
    result.innerHTML = "<p class='error'>ルートが見つかりません</p>";
    return;
  }

  const container=document.createElement("div");
  container.className="route-container";

  for(let i=0;i<res.path.length;i++){
    const st=res.path[i];
    const row=document.createElement("div"); row.className="route-row";

    // 路線判定
    const prevLine = findLine(res.path[i-1], st);
    const nextLine = findLine(st, res.path[i+1]);
    const line = prevLine || nextLine;

    // 乗換駅判定（前後で路線が変わる中間駅）
    const isTransfer = (i>0 && i<res.path.length-1 && prevLine && nextLine && prevLine !== nextLine);

    // マーカー
    const marker=document.createElement("div"); marker.className="route-marker";
    if(i>0 && i<res.path.length-1 && !isTransfer) marker.classList.add("small");
    marker.style.background = line ? lineColors[line] : "#aaa";

    // 縦線（次の駅があるとき）
    if(i<res.path.length-1){
      const vline=document.createElement("div");
      vline.className="route-line-vertical";
      vline.style.background = marker.style.background;
      marker.appendChild(vline);
    }

    // ラベル
    const label=document.createElement("div"); label.className="station-label";
    const name=document.createElement("div"); name.className="station-name"; name.textContent=st;
    label.appendChild(name);

    // 発駅と乗換駅だけ路線名ラベルと「途中駅を表示」ボタン
    if(i===0 || isTransfer){
      if(line){
        const ln=document.createElement("div");
        ln.className="station-line";
        ln.textContent = "新里鉄道 " + line;
        ln.style.background = lineColors[line];
        label.appendChild(ln);
      }
      const btn=document.createElement("button");
      btn.className="toggle-btn";
      btn.textContent = showIntermediate ? "途中駅を隠す" : "途中駅を表示";
      btn.onclick = ()=>{
        showIntermediate = !showIntermediate;
        showAllRoutes(); // 再描画
      };
      label.appendChild(btn);
    }

    // 非表示判定：中間かつ乗換でない駅は、トグルがOFFなら隠す
    if(i>0 && i<res.path.length-1 && !isTransfer && !showIntermediate){
      row.classList.add("hidden");
    }

    row.appendChild(marker);
    row.appendChild(label);
    container.appendChild(row);
  }

  result.appendChild(container);

  // 距離・運賃
  const distP = document.createElement("p");
  distP.textContent = "距離：" + res.distance.toFixed(1) + " km";
  result.appendChild(distP);

  const price = fare(res.distance);
  const fareP = document.createElement("p");
  fareP.textContent = `運賃：大人 ${price.adult}円／小児 ${price.child}円`;
  result.appendChild(fareP);
}
</script>
</body>
</html>
