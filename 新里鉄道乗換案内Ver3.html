<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新里鉄道　乗換案内</title>
  <style>
    :root{
      --major-r: 8px;
      --minor-r: 6px;
      --seg-width: 5px;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', Meiryo, sans-serif; margin: 18px; }
    h1 { font-size: 18px; margin: 0 0 8px; }

    .controls { display: grid; grid-template-columns: auto auto; gap: 8px 0; align-items: center; }
    .controls select, .controls button { padding: 6px 8px; font-size: 14px; }
    .controls-row { display: grid; grid-template-columns: auto auto auto; gap: 8px 12px; align-items: center; margin-top: 8px; }
    #info { font-weight: 600; }
    .info-ok { color: #222; }
    .info-err { color: #c33; }

    #map { width: 100%; border: 1px solid #ddd; border-radius: 10px; margin-top: 22px; }

    .label text.name { font-size: 20px; }
    .label .line-pill { font-size: 13px; fill: #fff; }
    .pill-bg { rx: 6; ry: 6; }

    .station.major circle.node { r: var(--major-r); fill: var(--line-color); stroke: var(--line-color); stroke-width: 0;}
    .station.minor circle.node { r: var(--minor-r); fill: var(--line-color); stroke: var(--line-color); stroke-width: 0;}
    .station.minor text.name { font-size: 15px; fill: #333; text-anchor: start; dominant-baseline: central; }

    line.segment { stroke-width: var(--seg-width); stroke-linecap: round; }

    .seg-btn { font-size: 13px; }
  </style>
</head>
<body>
  <h1>新里鉄道　乗換案内</h1>
  <div class="controls">
    <label>出発路線：<select id="fromLine"></select></label>
    <label>出発駅：<select id="fromStation"></select></label>
    <label>到着路線：<select id="toLine"></select></label>
    <label>到着駅：<select id="toStation"></select></label>
  </div>
  <div class="controls-row">
    <button id="searchBtn">経路検索</button>
    <span id="info" class="info-ok"></span>
  </div>

  <svg id="map" height="400"></svg>

  <script>
    // ==== 路線データ ====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };
    const lineColors = { "湯の浜線":"#07b5f7", "燠野線":"#fd5062", "新里線":"#0cab5e", "鶴宮線":"#feac2c", "彩山線":"#7dca22" };

    // ==== グラフ ====
    const rawGraph = { /* (中略: 駅間距離データは省略しませんが長いので同じです) */ };
    const graph = {};
    for (const [from, targets] of Object.entries(rawGraph)) {
      if (!graph[from]) graph[from] = {};
      for (const [to, d] of Object.entries(targets)) {
        graph[from][to] = d;
        if (!graph[to]) graph[to] = {};
        graph[to][from] = d;
      }
    }

    // ==== 運賃計算 ====
    function fare(distance){ /* 省略、上と同じ */ }

    // ==== UI ====
    const fromLineSel=document.getElementById('fromLine');
    const toLineSel=document.getElementById('toLine');
    const fromStaSel=document.getElementById('fromStation');
    const toStaSel=document.getElementById('toStation');
    const infoEl=document.getElementById('info');

    function setInfo(msg,isErr=false){ /* 上と同じ */ }
    function populateLineSelect(sel){ /* 上と同じ */ }
    function populateStationSelect(lineSel,staSel){ /* 上と同じ */ }

    populateLineSelect(fromLineSel);
    populateLineSelect(toLineSel);
    fromLineSel.value="湯の浜線"; populateStationSelect(fromLineSel,fromStaSel); fromStaSel.value="新里";
    toLineSel.value="燠野線"; populateStationSelect(toLineSel,toStaSel); toStaSel.value="燠野温泉";

    fromLineSel.addEventListener('change',()=>populateStationSelect(fromLineSel,fromStaSel));
    toLineSel.addEventListener('change',()=>populateStationSelect(toLineSel,toStaSel));

    // ==== 経路探索 ====
    function shortestPath(start,goal){ /* 上と同じ */ }
    function segmentLineBetween(fullPath,a,b){ /* 上と同じ */ }
    function findAdjacentLine(a,b){ /* 上と同じ */ }
    function extractMajorStations(path){ /* 上と同じ */ }
    function intermediatesBetween(path,a,b){ /* 上と同じ */ }

    // ==== 描画 ====
    const svg=document.getElementById('map');
    function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
    const segToggle=new Map();

    function drawRoute(path){
      clearSVG();
      if(!path||path.length<2) return;

      const majors=extractMajorStations(path);
      const top=40, minGap=120, basePad=30;

      const segmentMeta=[];
      for(let i=0;i<majors.length-1;i++){ /* 省略: meta構築処理は上と同じ */ }

      const ys=[top]; for(const seg of segmentMeta){ ys.push(ys[ys.length-1]+seg.gap); }
      svg.setAttribute('height',Math.max(220,ys[ys.length-1]+40));
      const cx=200, MAJOR_R=8;

      for(let i=0;i<majors.length;i++){
        const st=majors[i], cy=ys[i];
        const prevSt=i>0?majors[i-1]:null;
        const nextSt=i<majors.length-1?majors[i+1]:null;
        const metaPrev=i>0?segmentMeta[i-1]:null;
        const metaNext=i<segmentMeta.length?segmentMeta[i]:null;
        const colorPrev=metaPrev?(lineColors[metaPrev.lineName]||'#999'):null;

        if(prevSt){ /* 線の描画 */ }

        drawStation({name:st,x:cx,y:cy,isMajor:true,line:metaNext?metaNext.lineName:(metaPrev?metaPrev.lineName:null)});

        // === ラベル（縦方向中心基準、横方向右寄せ） ===
        const label=document.createElementNS('http://www.w3.org/2000/svg','g');
        label.setAttribute('class','label');
        label.setAttribute('transform',`translate(${cx+22},${cy})`);
        svg.appendChild(label);

        let offsetY=0;
        const nameText=document.createElementNS('http://www.w3.org/2000/svg','text');
        nameText.setAttribute('class','name');
        nameText.setAttribute('dominant-baseline','central');
        nameText.textContent=st;
        nameText.setAttribute('y',offsetY);
        label.appendChild(nameText);
        offsetY+=20;

        if(nextSt && metaNext && metaNext.lineName){
          const color=lineColors[metaNext.lineName];
          const pillGroup=document.createElementNS('http://www.w3.org/2000/svg','g');
          pillGroup.setAttribute('transform',`translate(0,${offsetY})`);
          label.appendChild(pillGroup);

          const text=document.createElementNS('http://www.w3.org/2000/svg','text');
          text.setAttribute('class','line-pill');
          text.setAttribute('dominant-baseline','central');
          text.textContent=`新里鉄道${metaNext.lineName}`;
          pillGroup.appendChild(text);

          const bbox=text.getBBox();
          const bg=document.createElementNS('http://www.w3.org/2000/svg','rect');
          bg.setAttribute('class','pill-bg');
          bg.setAttribute('x',bbox.x-6);
          bg.setAttribute('y',bbox.y-bbox.height/2-3);
          bg.setAttribute('width',bbox.width+12);
          bg.setAttribute('height',bbox.height+6);
          bg.setAttribute('fill',color);
          pillGroup.insertBefore(bg,text);

          offsetY+=20;

          const fo=document.createElementNS('http://www.w3.org/2000/svg','foreignObject');
          fo.setAttribute('x',bbox.x);
          fo.setAttribute('y',offsetY-14);
          fo.setAttribute('width',Math.max(120,bbox.width));
          fo.setAttribute('height',28);

          const div=document.createElementNS('http://www.w3.org/1999/xhtml','div');
          div.className='seg-btn';
          const key=metaNext.key;
          const on=!!segToggle.get(key);
          div.textContent=on?'途中駅を非表示':'途中駅を表示';
          div.style.cursor='pointer';
          div.style.background='#f3f3f3';
          div.style.border='1px solid #ccc';
          div.style.borderRadius='6px';
          div.style.textAlign='center';
          div.addEventListener('click',()=>{
            segToggle.set(key,!segToggle.get(key));
            drawRoute(path);
          });
          fo.appendChild(div);
          label.appendChild(fo);

          ys[i+1]=Math.max(ys[i+1],cy+offsetY+30);
        }

        if(metaPrev && metaPrev.show){
          const subs=metaPrev.subs;
          for(let j=0;j<subs.length;j++){
            const sub=subs[j];
            const subY=ys[i-1]+basePad+(j+1)*30;
            drawStation({name:sub,x:cx,y:subY,isMajor:false,line:metaPrev.lineName});
          }
        }
      }
    }

    function drawStation({name,x,y,isMajor,line}){ /* 上と同じ */ }

    document.getElementById('searchBtn').addEventListener('click',()=>{
      const from=fromStaSel.value, to=toStaSel.value;
      const {path,distance}=shortestPath(from,to);
      if(!path.length){ setInfo('経路が見つかりません',true); clearSVG(); return; }
      const f=fare(distance);
      setInfo(`経路:${path.join(" → ")} 距離:${distance.toFixed(1)}km 運賃:大人${f.adult}円 子供${f.child}円`);
      drawRoute(path);
    });

    document.getElementById('searchBtn').click();
  </script>
</body>
</html>
