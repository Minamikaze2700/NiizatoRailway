<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道 乗換案内</title>
  <style>
    body { font-family: sans-serif; }
    .seg-btn {
      cursor: pointer;
      background: #f3f3f3;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 14px;
      display: inline-block;
    }
    svg { width: 100%; }
    .station text {
      font-size: 14px;
      dominant-baseline: middle;
    }
  </style>
</head>
<body>
  <h2>新里鉄道 乗換案内</h2>
  出発駅:
  <select id="fromLine"></select>
  <select id="fromStation"></select>
  到着駅:
  <select id="toLine"></select>
  <select id="toStation"></select>
  <button id="searchBtn">検索</button>
  <div id="info"></div>
  <svg id="routeMap" height="600"></svg>

  <script>
    // ==== 路線色 ====
    const lineColors={
      "湯の浜線":"#07b5f7",
      "新里線":"#00a84f",
      "鶴宮線":"#f39800",
      "彩山線":"#3cb44b",
      "燠野線":"#e94d64"
    };

    // ==== 路線・駅データ（元のまま）====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮","南鶴宮"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "鶴宮線":["田ノ原","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"],
      "彩山線":["彩山口","彩山","蓮華寺","星宮","田ノ原"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉","紅葉台","桐山","湊川","彩山親水公園","彩山","橘町","燠野山口","白枝","燠野"]
    };

    // ==== 駅間距離データ（元のまま）====
    const rawGraph = {
      "豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
    };

    // ==== 運賃 ====
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ==== 最短経路探索 ====
    function shortestPath(start,goal){
      const dist={},prev={},Q=new Set(Object.keys(rawGraph).concat(...Object.values(rawGraph).map(Object.keys)).flat());
      for(const v of Q) dist[v]=Infinity;
      dist[start]=0;
      while(Q.size){
        let u=null;
        for(const v of Q){ if(u===null||dist[v]<dist[u]) u=v; }
        Q.delete(u);
        if(u===goal) break;
        for(const [nb,d] of Object.entries(rawGraph[u]||{})){
          if(dist[u]+d<dist[nb]){ dist[nb]=dist[u]+d; prev[nb]=u; }
        }
      }
      const path=[]; let u=goal;
      while(u){ path.unshift(u); u=prev[u]; }
      return {path,distance:dist[goal]};
    }

    // ==== セレクトボックス設定 ====
    const fromLineSel=document.getElementById("fromLine");
    const fromStaSel=document.getElementById("fromStation");
    const toLineSel=document.getElementById("toLine");
    const toStaSel=document.getElementById("toStation");

    for(const line in stationLines){
      [fromLineSel,toLineSel].forEach(sel=>{
        const opt=document.createElement("option");
        opt.value=line; opt.textContent=line;
        sel.appendChild(opt);
      });
    }

    function fillStations(lineSel,staSel){
      staSel.innerHTML="";
      const line=stationLines[lineSel.value];
      for(const st of line){
        const opt=document.createElement("option");
        opt.value=st; opt.textContent=st;
        staSel.appendChild(opt);
      }
    }

    fromLineSel.addEventListener("change",()=>fillStations(fromLineSel,fromStaSel));
    toLineSel.addEventListener("change",()=>fillStations(toLineSel,toStaSel));
    fillStations(fromLineSel,fromStaSel);
    fillStations(toLineSel,toStaSel);

    // ==== 途中駅表示管理 ====
    let segToggle=new Map();

    function getSubs(lineName,from,to){
      const line=stationLines[lineName];
      const i1=line.indexOf(from),i2=line.indexOf(to);
      if(i1<0||i2<0) return [];
      const [a,b]=i1<i2?[i1,i2]:[i2,i1];
      return line.slice(a+1,b); // 端点除外
    }

    function findLine(a,b){
      if(!a||!b) return null;
      for(const [line,sts] of Object.entries(stationLines)){
        const i=sts.indexOf(a);
        if((i>=0 && sts[i+1]===b) || (i>=0 && sts[i-1]===b)) return line;
      }
      return null;
    }

    function drawStation({name,x,y,isMajor,line}){
      const g=document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("class","station "+(isMajor?"major":"minor"));
      const col=lineColors[line]||"#000";

      const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx",x); c.setAttribute("cy",y);
      c.setAttribute("r",isMajor?8:6);
      c.setAttribute("fill",col);
      g.appendChild(c);

      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",x+15); t.setAttribute("y",y);
      t.textContent=name;
      g.appendChild(t);

      document.getElementById("routeMap").appendChild(g);
    }

    function drawRoute(path){
      const svg=document.getElementById("routeMap");
      svg.innerHTML="";
      const cx=40, step=80;
      const ys=path.map((_,i)=>40+i*step);

      for(let i=0;i<path.length;i++){
        const name=path[i];
        const prevLine=findLine(path[i-1],path[i]);
        const nextLine=findLine(path[i],path[i+1]);
        if(i===0||i===path.length-1||(prevLine&&nextLine&&prevLine!==nextLine)){
          drawStation({name,x:cx,y:ys[i],isMajor:true,line:prevLine||nextLine});
        }
        if(i<path.length-1){
          const lineName=findLine(path[i],path[i+1]);
          const key=`${path[i]}-${path[i+1]}`;
          const midY=(ys[i]+ys[i+1])/2;

          // ==== 途中駅ボタン ====
          const fo=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");
          fo.setAttribute("x",cx+20);
          fo.setAttribute("y",midY-14);
          fo.setAttribute("width",140);
          fo.setAttribute("height",28);
          const div=document.createElementNS("http://www.w3.org/1999/xhtml","div");
          div.className="seg-btn";
          div.textContent=segToggle.get(key)?"途中駅を非表示":"途中駅を表示";
          div.addEventListener("click",()=>{
            segToggle.set(key,!segToggle.get(key));
            drawRoute(path);
          });
          fo.appendChild(div);
          svg.appendChild(fo);

          // ==== 途中駅表示（修正: ボタン下端+5pxから配置）====
          if(segToggle.get(key)){
            const subs=getSubs(lineName,path[i],path[i+1]);
            if(subs.length>0){
              const btnBottom = midY + 14;   // ボタンの下端
              const startY = btnBottom + 5;  // そこから5px下
              const fixedStep=30;
              subs.forEach((name,idx)=>{
                const sy=startY+fixedStep*idx;
                drawStation({name,x:cx,y:sy,isMajor:false,line:lineName});
              });
            }
          }
        }
      }
    }

    // ==== 検索ボタン ====
    document.getElementById("searchBtn").addEventListener("click",()=>{
      const s=fromStaSel.value,g=toStaSel.value;
      if(!s||!g) return;
      const {path,distance}=shortestPath(s,g);
      const f=fare(distance);
      document.getElementById("info").textContent=
        `距離:${distance.toFixed(1)}km 運賃:大人${f.adult}円 子供${f.child}円`;
      segToggle=new Map();
      drawRoute(path);
    });
  </script>
</body>
</html>
