<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新里鉄道路線 ルート検索</title>
  <style>
    :root{
      --major-r: 8px;      /* 主要駅 ● 半径 */
      --minor-r: 6.5px;    /* 途中駅 ● 半径（主要の75%） */
      --seg-width: 5px;    /* 線の太さ */
    }

    body {
      font-family: sans-serif;
    }

    #controls {
      margin: 10px;
    }

    #map {
      border: 1px solid #888;
      margin-top: 10px;
    }

    .line-button {
      display: block;
      margin: 4px 0 4px 10px;
      padding: 4px 8px;
      background: #f0f0f0;
      border: 1px solid #aaa;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>新里鉄道路線 ルート検索</h2>

  <div id="controls">
    出発駅: <input type="text" id="start" />
    到着駅: <input type="text" id="goal" />
    <button onclick="searchRoute()">検索</button>
  </div>

  <!-- エラーや検索結果を表示 -->
  <div id="result"></div>

  <svg id="map" width="900" height="700"></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // ==== 駅・路線データ（変更不可・そのまま使用）====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };
    const lineColors = {
      "湯の浜線":"#07b5f7",
      "燠野線":"#fd5062",
      "新里線":"#0cab5e",
      "鶴宮線":"#feac2c",
      "彩山線":"#7dca22"
    };

    const svg = d3.select("#map");

    // ==== 乗換駅の判定 ====
    function findInterchangeStations() {
      const stationCount = {};
      for (const line in stationLines) {
        stationLines[line].forEach(st => {
          stationCount[st] = (stationCount[st] || 0) + 1;
        });
      }
      return Object.keys(stationCount).filter(st => stationCount[st] > 1);
    }

    // ==== 駅ラベル描画 ====
    function drawStationLabels(svg, lineName, stations, lineCoords, startStation, goalStation) {
      const interchangeStations = findInterchangeStations();

      stations.forEach((station, i) => {
        const x = lineCoords[i].x;
        const y = lineCoords[i].y;

        const isStartOrGoal = (station === startStation || station === goalStation);
        const isInterchange = interchangeStations.includes(station);
        const fontSize = (isStartOrGoal || isInterchange) ? "20px" : "12px";

        svg.append("text")
          .attr("x", x + 10)
          .attr("y", y - 5)
          .attr("font-size", fontSize)
          .attr("fill", "black")
          .text(station);
      });
    }

    // ==== 路線描画 ====
    function drawLine(lineName, offsetY, startStation, goalStation) {
      const stations = stationLines[lineName];
      const color = lineColors[lineName];
      const xStart = 50;
      const xStep = 30;
      const y = offsetY;

      const coords = stations.map((s,i)=>({x: xStart+i*xStep, y:y}));

      // 路線線
      svg.append("line")
        .attr("x1", coords[0].x)
        .attr("y1", y)
        .attr("x2", coords[coords.length-1].x)
        .attr("y2", y)
        .attr("stroke", color)
        .attr("stroke-width", 5);

      // 駅の丸
      coords.forEach(c=>{
        svg.append("circle")
          .attr("cx", c.x)
          .attr("cy", c.y)
          .attr("r", 6)
          .attr("fill", "white")
          .attr("stroke", color)
          .attr("stroke-width", 2);
      });

      // 路線名
      svg.append("text")
        .attr("x", coords[0].x)
        .attr("y", y - 20)
        .attr("font-size", "16px")
        .attr("fill", color)
        .text(lineName);

      // 停車駅表示/非表示ボタン
      const button = document.createElement("button");
      button.innerText = lineName + " 停車駅 表示/非表示";
      button.className = "line-button";
      document.body.insertBefore(button, svg.node().nextSibling);

      let stationsVisible = true;
      button.addEventListener("click", () => {
        stationsVisible = !stationsVisible;
        svg.selectAll(".label-" + lineName.replace(/線/,""))
          .style("display", stationsVisible ? "block" : "none");
      });

      // 駅ラベル
      const interchangeStations = findInterchangeStations();
      stations.forEach((station,i)=>{
        const x = coords[i].x;
        const y = coords[i].y;
        const isStartOrGoal = (station === startStation || station === goalStation);
        const isInterchange = interchangeStations.includes(station);
        const fontSize = (isStartOrGoal || isInterchange) ? "20px" : "12px";

        svg.append("text")
          .attr("class", "label-" + lineName.replace(/線/,""))
          .attr("x", x + 10)
          .attr("y", y - 5)
          .attr("font-size", fontSize)
          .attr("fill", "black")
          .text(station);
      });
    }

    // ==== ルート検索 ====
    function searchRoute() {
      const start = document.getElementById("start").value.trim();
      const goal = document.getElementById("goal").value.trim();
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (!start || !goal) {
        resultDiv.innerText = "出発駅と到着駅を入力してください。";
        return;
      }

      // 入力駅が存在するかチェック
      const allStations = Object.values(stationLines).flat();
      if (!allStations.includes(start) || !allStations.includes(goal)) {
        resultDiv.innerText = "入力された駅が存在しません。";
        return;
      }

      // 描画リセット
      svg.selectAll("*").remove();

      // 路線ごとに描画
      let offsetY = 80;
      for (const line in stationLines) {
        drawLine(line, offsetY, start, goal);
        offsetY += 100;
      }

      resultDiv.innerText = "検索完了: " + start + " → " + goal;
    }

  </script>
</body>
</html>
