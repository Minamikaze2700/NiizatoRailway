<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道路線 ルート検索</title>
  <style>
    body { font-family: sans-serif; }
    svg { border: 1px solid #ccc; margin-top: 10px; }
    .station-circle { stroke: black; stroke-width: 1; }
    .station-label { font-size: 14px; text-anchor: middle; dominant-baseline: central; }
    .line-segment { stroke-width: 4; }
    .button { cursor: pointer; fill: #eee; stroke: #333; stroke-width: 1; }
    .button-label { font-size: 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>新里鉄道路線 ルート検索</h1>
  <div>
    出発駅:
    <select id="fromLine"></select>
    <select id="fromStation"></select>
    到着駅:
    <select id="toLine"></select>
    <select id="toStation"></select>
    <button onclick="searchRoute()">検索</button>
  </div>
  <div id="result"></div>
  <svg id="routeMap" width="800" height="600"></svg>

  <script>
    // ==== 路線データ ====
    const stationLines = {
      "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };

    const lineColors = {
      "湯の浜線":"#07b5f7",
      "燠野線":"#f57c00",
      "鶴宮線":"#4caf50",
      "新里線":"#e91e63",
      "彩山線":"#9c27b0"
    };

    // ==== 駅間距離データ ====
    const rawGraph = {
      "豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},
      "栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},
      "伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},
      "河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},
      "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
      "燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},
      "あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
      "桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},
      "玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},
      "久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
    };
    for(const a in rawGraph){
      for(const b in rawGraph[a]){
        if(!rawGraph[b]) rawGraph[b] = {};
        rawGraph[b][a] = rawGraph[a][b];
      }
    }

    // ==== 運賃 ====
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ==== ダイクストラ経路探索 ====
    function dijkstra(start, goal){
      let dist={}, prev={}, Q=new Set();
      for(let v in rawGraph){ dist[v]=Infinity; prev[v]=null; Q.add(v); }
      dist[start]=0;
      while(Q.size>0){
        let u=null, min=Infinity;
        for(let v of Q){ if(dist[v]<min){min=dist[v];u=v;} }
        if(u===null) break;
        Q.delete(u);
        if(u===goal) break;
        for(let v in rawGraph[u]){
          let alt=dist[u]+rawGraph[u][v];
          if(alt<dist[v]){ dist[v]=alt; prev[v]=u; }
        }
      }
      let path=[], u=goal;
      while(u){ path.unshift(u); u=prev[u]; }
      return {distance:dist[goal], path:path};
    }

    // ==== UI 初期化 ====
    window.onload=function(){
      let fromLine=document.getElementById("fromLine");
      let toLine=document.getElementById("toLine");
      for(let line in stationLines){
        fromLine.add(new Option(line,line));
        toLine.add(new Option(line,line));
      }
      fromLine.onchange=()=>populateStations("from");
      toLine.onchange=()=>populateStations("to");
      fromLine.value="湯の浜線"; populateStations("from");
      toLine.value="燠野線"; populateStations("to");
      document.getElementById("fromStation").value="新里";
      document.getElementById("toStation").value="燠野温泉";
    };

    function populateStations(type){
      let line=document.getElementById(type+"Line").value;
      let sel=document.getElementById(type+"Station");
      sel.innerHTML="";
      stationLines[line].forEach(st=>sel.add(new Option(st,st)));
    }

    // ==== 路線判定 ====
    function findLineSegment(a,b){
      for(let line in stationLines){
        let arr=stationLines[line];
        if(arr.includes(a)&&arr.includes(b)){
          if(Math.abs(arr.indexOf(a)-arr.indexOf(b))===1){
            return line;
          }
        }
      }
      return null;
    }

    // ==== 検索 ====
    function searchRoute(){
      let from=document.getElementById("fromStation").value;
      let to=document.getElementById("toStation").value;
      let result=dijkstra(from,to);
      let f=fare(result.distance);
      document.getElementById("result").innerHTML=`距離: ${result.distance.toFixed(1)} km<br>運賃: 大人 ${f.adult} 円, 子供 ${f.child} 円`;
      drawRoute(result.path);
    }

    // ==== 描画 ====
    function drawRoute(path){
      let svg=document.getElementById("routeMap");
      svg.innerHTML="";
      let cx=100, cy=50, gap=80;

      for(let i=0;i<path.length;i++){
        let st=path[i];
        let prevLine=(i>0)?findLineSegment(path[i-1],st):null;
        let nextLine=(i<path.length-1)?findLineSegment(st,path[i+1]):null;
        let isMajor=(i===0||i===path.length-1||(prevLine&&nextLine&&prevLine!==nextLine));
        let color=isMajor?(nextLine?lineColors[nextLine]:lineColors[prevLine]):(prevLine?lineColors[prevLine]:lineColors[nextLine]);

        if(i>0){
          let line=findLineSegment(path[i-1],st);
          svg.appendChild(makeLine(cx,cy+(i-1)*gap,cx,cy+i*gap,lineColors[line]));
        }

        if(isMajor){
          svg.appendChild(makeCircle(cx,cy+i*gap,8,color));
          svg.appendChild(makeText(cx,cy+i*gap-15,st));
          if(i===0||i===path.length-1|| (prevLine&&nextLine&&prevLine!==nextLine)){
            let lineName=nextLine||prevLine;
            svg.appendChild(makeText(cx,cy+i*gap+15,lineName));
            if(i<path.length-1){
              let btnY=cy+i*gap+35;
              let btn=makeButton(cx-30,btnY,60,20,"途中駅表示");
              btn.onclick=()=>toggleIntermediate(svg,path[i],path[i+1],cx,btnY+25);
              svg.appendChild(btn);
            }
          }
        }
      }
    }

    function makeLine(x1,y1,x2,y2,color){
      let l=document.createElementNS("http://www.w3.org/2000/svg","line");
      l.setAttribute("x1",x1);l.setAttribute("y1",y1);
      l.setAttribute("x2",x2);l.setAttribute("y2",y2);
      l.setAttribute("stroke",color);l.setAttribute("class","line-segment");
      return l;
    }

    function makeCircle(x,y,r,color){
      let c=document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx",x);c.setAttribute("cy",y);
      c.setAttribute("r",r);c.setAttribute("fill",color);
      c.setAttribute("class","station-circle");
      return c;
    }

    function makeText(x,y,text){
      let t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",x);t.setAttribute("y",y);
      t.setAttribute("class","station-label");
      t.textContent=text;
      return t;
    }

    function makeButton(x,y,w,h,label){
      let g=document.createElementNS("http://www.w3.org/2000/svg","g");
      let r=document.createElementNS("http://www.w3.org/2000/svg","rect");
      r.setAttribute("x",x);r.setAttribute("y",y);
      r.setAttribute("width",w);r.setAttribute("height",h);
      r.setAttribute("rx",5);r.setAttribute("ry",5);
      r.setAttribute("class","button");
      let t=makeText(x+w/2,y+h/2+4,label);
      t.setAttribute("class","button-label");
      g.appendChild(r);g.appendChild(t);
      g.onclick=null;
      return g;
    }

    function toggleIntermediate(svg,from,to,cx,startY){
      let line=findLineSegment(from,to);
      let arr=stationLines[line];
      let fi=arr.indexOf(from), ti=arr.indexOf(to);
      if(fi>ti)[fi,ti]=[ti,fi];
      let subs=arr.slice(fi+1,ti);
      let gap=20;
      subs.forEach((st,j)=>{
        let y=startY+j*gap;
        svg.appendChild(makeLine(cx,y-gap,cx,y,lineColors[line]));
        svg.appendChild(makeCircle(cx,y,6,lineColors[line]));
        svg.appendChild(makeText(cx,y-10,st));
      });
    }
  </script>
</body>
</html>
