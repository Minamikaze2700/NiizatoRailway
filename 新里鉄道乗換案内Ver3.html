<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道 乗換案内</title>
  <style>
    body { font-family: sans-serif; }
    .seg-btn{
      font-size:14px;
      background:#eee;
      border:1px solid #999;
      border-radius:5px;
      padding:2px 6px;
      cursor:pointer;
      display:inline-block;
      margin:2px 0;
    }
  </style>
</head>
<body>
  <h1>新里鉄道 乗換案内</h1>
  出発駅:
  <select id="fromLine"></select>
  <select id="fromStation"></select>
  到着駅:
  <select id="toLine"></select>
  <select id="toStation"></select>
  <button onclick="searchRoute()">検索</button>
  <div id="result"></div>
  <svg id="routeMap" width="400" height="800"></svg>

<script>
  // ==== 路線データ（元のまま保持）====
  const stationLines = {
    "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮","南鶴宮"],
    "燠野線":["新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
    "鶴宮線":["田ノ原","北玖川","玖川","中野原"],
    "彩山線":["彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"],
    "新里線":["新里","南新里","田ノ原"]
  };

  const lineColors = {
    "湯の浜線":"#00bfff",
    "燠野線":"#ff4d6d",
    "鶴宮線":"#ff9900",
    "彩山線":"#2ecc71",
    "新里線":"#009900"
  };

  // ==== 距離データ ====
  const rawGraph = {
    "豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},
    "栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},
    "伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},
    "河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},
    "七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},
    "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
    "燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},
    "あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},
    "桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},
    "蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},
    "玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},
    "久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}
  };

  // ==== 運賃 ====
  function fare(distance){
    if(distance<=3) return {adult:130,child:70};
    else if(distance<=6) return {adult:160,child:80};
    else if(distance<=10) return {adult:190,child:100};
    else if(distance<=15) return {adult:220,child:110};
    else if(distance<=20) return {adult:250,child:130};
    else if(distance<=25) return {adult:280,child:140};
    else if(distance<=30) return {adult:310,child:160};
    else return {adult:340,child:170};
  }

  // ==== 経路探索（ダイクストラ）====
  function dijkstra(start,goal){
    let dist={},prev={},Q=new Set();
    for(let v in rawGraph){
      dist[v]=Infinity; Q.add(v);
    }
    dist[start]=0;
    while(Q.size){
      let u=null, min=Infinity;
      for(let v of Q){ if(dist[v]<min){min=dist[v];u=v;} }
      if(u===goal||u==null) break;
      Q.delete(u);
      for(let nb in rawGraph[u]){
        let alt=dist[u]+rawGraph[u][nb];
        if(alt<dist[nb]){ dist[nb]=alt; prev[nb]=u; }
      }
    }
    let path=[],u=goal;
    while(u){ path.unshift(u); u=prev[u]; }
    return {path,dist:dist[goal]};
  }

  // ==== 路線判定 ====
  function findLine(a,b){
    for(let line in stationLines){
      let arr=stationLines[line];
      if(arr.includes(a)&&arr.includes(b)) return line;
    }
    return null;
  }

  // ==== 途中駅抽出 ====
  function getSubs(line,a,b){
    let arr=stationLines[line];
    let i=arr.indexOf(a), j=arr.indexOf(b);
    if(i<0||j<0) return [];
    if(i>j) [i,j]=[j,i];
    return arr.slice(i+1,j); // 端点除外
  }

  // ==== SVG描画 ====
  function drawStation({name,x,y,isMajor,line}){
    const svg=document.getElementById("routeMap");
    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    let r=isMajor?8:6;
    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",r);
    c.setAttribute("fill",lineColors[line]||"#000");
    g.appendChild(c);
    const t=document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",x+15); t.setAttribute("y",y+5);
    t.textContent=name;
    g.appendChild(t);
    svg.appendChild(g);
  }

  let segToggle=new Map();

  function drawRoute(path){
    const svg=document.getElementById("routeMap");
    svg.innerHTML="";
    const cx=40, step=80;
    const ys=path.map((_,i)=>40+i*step);

    for(let i=0;i<path.length;i++){
      const name=path[i];
      const prevLine=findLine(path[i-1],path[i]);
      const nextLine=findLine(path[i],path[i+1]);
      if(i>0){
        const lineName=prevLine||nextLine;
        const col=lineColors[lineName]||"#000";
        const line=document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1",cx);
        line.setAttribute("y1",ys[i-1]);
        line.setAttribute("x2",cx);
        line.setAttribute("y2",ys[i]);
        line.setAttribute("stroke",col);
        line.setAttribute("stroke-width",5);
        svg.appendChild(line);
      }
      drawStation({name,x:cx,y:ys[i],isMajor:true,line:prevLine||nextLine});

      if(i<path.length-1){
        const lineName=findLine(path[i],path[i+1]);
        const key=`${path[i]}-${path[i+1]}`;
        const midY=(ys[i]+ys[i+1])/2;

        const fo=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");
        fo.setAttribute("x",cx+20);
        fo.setAttribute("y",midY-14);
        fo.setAttribute("width",140);
        fo.setAttribute("height",28);
        const div=document.createElementNS("http://www.w3.org/1999/xhtml","div");
        div.className="seg-btn";
        div.textContent=segToggle.get(key)?"途中駅を非表示":"途中駅を表示";
        div.addEventListener("click",()=>{
          segToggle.set(key,!segToggle.get(key));
          drawRoute(path);
        });
        fo.appendChild(div);
        svg.appendChild(fo);

        // ==== 途中駅描画（修正版）====
        if(segToggle.get(key)){
          const subs=getSubs(lineName,path[i],path[i+1]);
          if(subs.length>0){
            const btnBottom = midY + 14;
            const startY = btnBottom + 5;
            const fixedStep=30;
            subs.forEach((name,idx)=>{
              const sy=startY+fixedStep*idx;
              drawStation({name,x:cx,y:sy,isMajor:false,line:lineName});
            });
          }
        }
      }
    }
  }

  // ==== UI初期化 ====
  function initSelects(){
    const fl=document.getElementById("fromLine");
    const tl=document.getElementById("toLine");
    for(let line in stationLines){
      fl.add(new Option(line,line));
      tl.add(new Option(line,line));
    }
    fl.onchange=()=>populateStations("from");
    tl.onchange=()=>populateStations("to");
    populateStations("from"); populateStations("to");
  }

  function populateStations(type){
    const lineSel=document.getElementById(type+"Line");
    const stSel=document.getElementById(type+"Station");
    stSel.innerHTML="";
    stationLines[lineSel.value].forEach(st=>{
      stSel.add(new Option(st,st));
    });
  }

  function searchRoute(){
    const fs=document.getElementById("fromStation").value;
    const ts=document.getElementById("toStation").value;
    const result=dijkstra(fs,ts);
    const f=fare(result.dist);
    document.getElementById("result").textContent=
      `距離:${result.dist.toFixed(1)}km 運賃:大人${f.adult}円 子供${f.child}円`;
    segToggle.clear();
    drawRoute(result.path);
  }

  initSelects();
</script>
</body>
</html>
