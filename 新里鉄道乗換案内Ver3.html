<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>経路検索</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    svg { border: 1px solid #ccc; }
    .station { cursor: pointer; }
    .toggle-btn { margin: 5px; padding: 2px 6px; font-size: 14px; }
    .line-segment { stroke-width: 4px; }
    .station-circle { r: 5; }
    .intermediate-circle { r: 3.75; }
    .station-text { font-size: 21px; dominant-baseline: middle; }
  </style>
</head>
<body>
  <h2>経路検索</h2>
  <div>
    発駅: <select id="fromLine"></select> <select id="fromStation"></select>
    着駅: <select id="toLine"></select> <select id="toStation"></select>
    <button id="searchBtn">検索</button>
  </div>
  <div id="route"></div>
  <svg id="map" width="400" height="800"></svg>

  <script>
    // ==== 駅・路線データ ====
    const stationLines = {
      "湯の浜線": [
        "豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"
      ],
      "燠野線": ["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
      "鶴宮線": ["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
      "新里線": ["新里","南新里","田ノ原","北玖川","玖川","中野原"],
      "彩山線": ["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
    };

    const lineColors = {
      "湯の浜線": "#07b5f7",
      "燠野線": "#fd5062",
      "新里線": "#0cab5e",
      "鶴宮線": "#feac2c",
      "彩山線": "#7dca22"
    };

    // ==== 駅間距離データ ====
    const rawGraph = {
      "豊町":{"東豊町":1.2}, "東豊町":{"清水浜":1.4}, "清水浜":{"安田町":1.9}, "安田町":{"南栃原":2.2},
      "南栃原":{"栃原":0.9}, "栃原":{"宇城":2.2}, "宇城":{"須川":2.1}, "須川":{"御浜埼公園":1.9},
      "御浜埼公園":{"御浜":0.6}, "御浜":{"伊坂":2.5}, "伊坂":{"垳下":2.6}, "垳下":{"北浜":2.3},
      "北浜":{"西新里":1.4}, "西新里":{"新里":1.7}, "新里":{"河岸":0.9,"南新里":2.5}, "河岸":{"新里海浜公園":1.7},
      "新里海浜公園":{"湯の浜海岸":2.3}, "湯の浜海岸":{"湯の浜":1.5}, "湯の浜":{"七浦":2.5,"新里大学前":0.8},
      "七浦":{"那珂町":1.6}, "那珂町":{"宇多野":2.2}, "宇多野":{"伊奈崎":1.8}, "伊奈崎":{"鶴宮神社":1.5},
      "鶴宮神社":{"鶴宮":1.2}, "鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7}, "新里大学前":{"綾原":0.7},
      "綾原":{"福来":1.2}, "福来":{"燠野":1.4}, "燠野":{"湯川":2.6,"紅葉台":1.1}, "湯川":{"温泉口":1.6},
      "温泉口":{"燠野温泉":1.9}, "南鶴宮":{"あずさ台":1.4}, "あずさ台":{"橘町":1.8}, "橘町":{"燠野山口":1.1},
      "燠野山口":{"白枝":1.2}, "白枝":{"燠野":1.1}, "紅葉台":{"桐山":0.8}, "桐山":{"湊川":0.8},
      "湊川":{"彩山親水公園":1.1}, "彩山親水公園":{"彩山":1.2}, "彩山":{"蓮華寺":0.8,"彩山口":2.1},
      "蓮華寺":{"星宮":1.1}, "星宮":{"田ノ原":1.1}, "南新里":{"田ノ原":2.3}, "田ノ原":{"北玖川":2.4},
      "北玖川":{"玖川":3.1}, "玖川":{"中野原":3.1}, "彩山口":{"新里国際スキー場":3.4}, "新里国際スキー場":{"鷹見台":10.7},
      "鷹見台":{"久我原":2.7}, "久我原":{"浪原":1.5}, "浪原":{"深江":1.4}, "深江":{"三栗谷":1.3},
      "三栗谷":{"桜川公園":1.5}, "桜川公園":{"桜川":2.2}
    };
    const graph = {};
    for (const [from, targets] of Object.entries(rawGraph)) {
      if (!graph[from]) graph[from] = {};
      for (const [to, d] of Object.entries(targets)) {
        graph[from][to] = d;
        if (!graph[to]) graph[to] = {};
        graph[to][from] = d;
      }
    }

    // ==== 経路探索（ダイクストラ） ====
    function shortestPath(start, goal) {
      const dist = {}, prev = {};
      const pq = new Set(Object.keys(graph));
      for (const v of pq) dist[v] = Infinity;
      dist[start] = 0;
      while (pq.size) {
        let u = null, min = Infinity;
        for (const v of pq) if (dist[v] < min) { min = dist[v]; u = v; }
        if (u === goal) break;
        pq.delete(u);
        for (const [nbr, d] of Object.entries(graph[u])) {
          const alt = dist[u] + d;
          if (alt < dist[nbr]) { dist[nbr] = alt; prev[nbr] = u; }
        }
      }
      const path = [];
      let u = goal;
      while (u) { path.unshift(u); u = prev[u]; }
      return path;
    }

    // ==== UI構築 ====
    function initSelectors() {
      for (const id of ["fromLine","toLine"]) {
        const sel = document.getElementById(id);
        for (const line of Object.keys(stationLines)) {
          const opt = document.createElement("option");
          opt.value = line; opt.textContent = line;
          sel.appendChild(opt);
        }
        sel.onchange = () => populateStations(id.replace("Line","Station"), sel.value);
        populateStations(id.replace("Line","Station"), sel.value);
      }
    }

    function populateStations(stSelId, line) {
      const sel = document.getElementById(stSelId);
      sel.innerHTML = "";
      for (const st of stationLines[line]) {
        const opt = document.createElement("option");
        opt.value = st; opt.textContent = st;
        sel.appendChild(opt);
      }
    }

    // ==== 描画 ====
    function drawRoute(path) {
      const svg = d3.select("#map");
      svg.selectAll("*").remove();
      const g = svg.append("g").attr("transform","translate(100,50)");
      let y = 0;
      const stationGroups = [];
      for (let i=0;i<path.length;i++) {
        const st = path[i];
        const line = Object.keys(stationLines).find(l => stationLines[l].includes(st));
        const color = lineColors[line];
        const group = g.append("g").attr("class","station").attr("transform",`translate(0,${y})`);
        group.append("circle")
             .attr("class","station-circle")
             .attr("r",5)
             .attr("fill",color);
        group.append("text")
             .attr("class","station-text")
             .attr("x",15).text(st);
        stationGroups.push({g:group,station:st,line,color,y});
        if (i<path.length-1) {
          g.append("line")
           .attr("x1",0).attr("y1",y)
           .attr("x2",0).attr("y2",y+50)
           .attr("stroke",color).attr("class","line-segment");
          y+=50;
        }
      }
    }

    document.getElementById("searchBtn").onclick = () => {
      const from = document.getElementById("fromStation").value;
      const to = document.getElementById("toStation").value;
      const path = shortestPath(from,to);
      drawRoute(path);
    };

    initSelectors();
  </script>
</body>
</html>
