<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道 乗換案内</title>
  <style>
    body { font-family: sans-serif; }
    .seg-btn {
      cursor: pointer;
      background: #f3f3f3;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 14px;
      display: inline-block;
    }
    svg { width: 100%; }
    .station text {
      font-size: 14px;
      dominant-baseline: middle;
    }
  </style>
</head>
<body>
  <h2>新里鉄道 乗換案内</h2>
  出発駅:
  <select id="fromLine"></select>
  <select id="fromStation"></select>
  到着駅:
  <select id="toLine"></select>
  <select id="toStation"></select>
  <button id="searchBtn">検索</button>
  <div id="info"></div>
  <svg id="routeMap" height="600"></svg>

  <script>
    // ==== 路線色 ====
    const lineColors={
      "湯の浜線":"#07b5f7",
      "新里線":"#00a84f",
      "鶴宮線":"#f39800",
      "彩山線":"#3cb44b",
      "燠野線":"#e94d64"
    };

    // ==== 路線・駅データ ====
    const stationLines={
      "湯の浜線":["新里","河岸","新里海浜公園","湯の浜海岸","湯の浜"],
      "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"]
    };

    // ==== 距離グラフ（変えないで）====
    const rawGraph = {
      "新里":{"河岸":0.9},"河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},
      "湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"新里大学前":0.8},
      "新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},
      "燠野":{"湯川":2.6},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9}
    };

    // ==== 運賃（変えないで）====
    function fare(distance){
      if(distance<=3) return {adult:130,child:70};
      else if(distance<=6) return {adult:160,child:80};
      else if(distance<=10) return {adult:190,child:100};
      else if(distance<=15) return {adult:220,child:110};
      else if(distance<=20) return {adult:250,child:130};
      else if(distance<=25) return {adult:280,child:140};
      else if(distance<=30) return {adult:310,child:160};
      else return {adult:340,child:170};
    }

    // ==== 最短経路探索（変えないで）====
    function shortestPath(start,goal){
      const dist={},prev={},Q=new Set(Object.keys(rawGraph).concat(...Object.values(rawGraph).map(Object.keys)).flat());
      for(const v of Q) dist[v]=Infinity;
      dist[start]=0;
      while(Q.size){
        let u=null;
        for(const v of Q){ if(u===null||dist[v]<dist[u]) u=v; }
        Q.delete(u);
        if(u===goal) break;
        for(const [nb,d] of Object.entries(rawGraph[u]||{})){
          if(dist[u]+d<dist[nb]){ dist[nb]=dist[u]+d; prev[nb]=u; }
        }
      }
      const path=[]; let u=goal;
      while(u){ path.unshift(u); u=prev[u]; }
      return {path,distance:dist[goal]};
    }

    // ==== 出発駅・到着駅セレクト ====
    const fromLineSel=document.getElementById("fromLine");
    const fromStaSel=document.getElementById("fromStation");
    const toLineSel=document.getElementById("toLine");
    const toStaSel=document.getElementById("toStation");

    for(const line in stationLines){
      [fromLineSel,toLineSel].forEach(sel=>{
        const opt=document.createElement("option");
        opt.value=line; opt.textContent=line;
        sel.appendChild(opt);
      });
    }

    function fillStations(lineSel,staSel){
      staSel.innerHTML="";
      const line=stationLines[lineSel.value];
      for(const st of line){
        const opt=document.createElement("option");
        opt.value=st; opt.textContent=st;
        staSel.appendChild(opt);
      }
    }

    fromLineSel.addEventListener("change",()=>fillStations(fromLineSel,fromStaSel));
    toLineSel.addEventListener("change",()=>fillStations(toLineSel,toStaSel));
    fillStations(fromLineSel,fromStaSel);
    fillStations(toLineSel,toStaSel);

    // ==== 途中駅表示管理 ====
    let segToggle=new Map();

    // 修正: 主要駅は除外
    function getSubs(lineName,from,to){
      const line=stationLines[lineName];
      const i1=line.indexOf(from),i2=line.indexOf(to);
      if(i1<0||i2<0) return [];
      const [a,b]=i1<i2?[i1,i2]:[i2,i1];
      return line.slice(a+1,b);
    }

    function findLine(a,b){
      if(!a||!b) return null;
      for(const [line,sts] of Object.entries(stationLines)){
        const i=sts.indexOf(a);
        if((i>=0 && sts[i+1]===b) || (i>=0 && sts[i-1]===b)) return line;
      }
      return null;
    }

    function drawStation({name,x,y,isMajor,line}){
      const g=document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("class","station "+(isMajor?"major":"minor"));
      const col=lineColors[line]||"#000";

      const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx",x); c.setAttribute("cy",y);
      c.setAttribute("r",isMajor?8:6);
      c.setAttribute("fill",col);
      g.appendChild(c);

      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",x+15); t.setAttribute("y",y);
      t.textContent=name;
      g.appendChild(t);

      document.getElementById("routeMap").appendChild(g);
    }

    function drawRoute(path){
      const svg=document.getElementById("routeMap");
      svg.innerHTML="";
      const cx=40, step=80;
      const ys=path.map((_,i)=>40+i*step);

      for(let i=0;i<path.length;i++){
        const name=path[i];
        const prevLine=findLine(path[i-1],path[i]);
        const nextLine=findLine(path[i],path[i+1]);
        if(i===0||i===path.length-1||(prevLine&&nextLine&&prevLine!==nextLine)){
          drawStation({name,x:cx,y:ys[i],isMajor:true,line:prevLine||nextLine});
        }
        if(i<path.length-1){
          const lineName=findLine(path[i],path[i+1]);
          const key=`${path[i]}-${path[i+1]}`;
          const midY=(ys[i]+ys[i+1])/2;

          // ==== 途中駅ボタン ====
          const fo=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");
          fo.setAttribute("x",cx+20);
          fo.setAttribute("y",midY-14);
          fo.setAttribute("width",140);
          fo.setAttribute("height",28);
          const div=document.createElementNS("http://www.w3.org/1999/xhtml","div");
          div.className="seg-btn";
          div.textContent=segToggle.get(key)?"途中駅を非表示":"途中駅を表示";
          div.addEventListener("click",()=>{
            segToggle.set(key,!segToggle.get(key));
            drawRoute(path);
          });
          fo.appendChild(div);
          svg.appendChild(fo);

          // ==== 途中駅を描画（ボタン下5pxから） ====
          if(segToggle.get(key)){
            const subs=getSubs(lineName,path[i],path[i+1]);
            if(subs.length>0){
              const startY=midY+28+5; // ボタン下5pxから開始
              const subGap=(ys[i+1]-startY)/(subs.length+1);
              for(let j=0;j<subs.length;j++){
                const subY=startY+(j+1)*subGap;
                drawStation({name:subs[j],x:cx,y:subY,isMajor:false,line:lineName});
              }
            }
          }
        }
      }
    }

    // ==== 検索ボタン ====
    document.getElementById("searchBtn").addEventListener("click",()=>{
      const s=fromStaSel.value,g=toStaSel.value;
      if(!s||!g) return;
      const {path,distance}=shortestPath(s,g);
      const f=fare(distance);
      document.getElementById("info").textContent=
        `距離:${distance.toFixed(1)}km 運賃:大人${f.adult}円 子供${f.child}円`;
      segToggle=new Map();
      drawRoute(path);
    });
  </script>
</body>
</html>
