<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>新里地方 乗換案内</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#f1f5f9;
  --card:#fff;
  --muted:#667085;
  --radius:12px;
  --gutter:34px;
  --dotMajor:16px;
  --dotMinor:12px;
  --lineWMajor:5px;
  --lineWMinor:5px;
  --font-sans:"Hiragino Kaku Gothic ProN","Meiryo",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
}
html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:#0b1324}
.wrap{max-width:980px;margin:28px auto;padding:20px}
h1{margin:0 0 12px;font-size:20px}
.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(2,6,23,0.07);margin-bottom:12px}
.row{display:flex;gap:12px;align-items:flex-start;flex-direction:column}
.col{display:flex;flex-direction:column;gap:6px;position:relative;align-items:flex-start}
select,button{font-size:14px;padding:8px 10px;border-radius:4px;border:1px solid #d1d5db;background:#fff}
label{font-size:13px;color:var(--muted)}
button.primary{cursor:pointer;background:#0b5fff;color:#fff;border:none}
.resultHeader{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.resultHeader .meta{display:flex;gap:18px;color:#111}

/* 路線図レイアウト */
.routeLine{display:flex;flex-direction:column;gap:10px;margin-top:4px}
.rowStation{display:grid;grid-template-columns:var(--gutter) 1fr;align-items:start;column-gap:10px;position:relative;}
.railCol{display:flex;flex-direction:column;align-items:center;position:relative;}

/* ドットは railCol の上端に固定（top:0）する */
.railDot{
  border-radius:50%;
  width:var(--dotMajor);
  height:var(--dotMajor);
  z-index:2;
  border:2px solid #fff;
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  box-sizing:content-box;
}
.rowBetween .railDot{
  width:var(--dotMinor);
  height:var(--dotMinor);
  border:2px solid #fff;
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  z-index:2;
}

/* 線は railCol 内で絶対配置。top と height は JS で調整する */
.railLineMajor{
  width:var(--lineWMajor);
  border-radius:2px;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  z-index:1;
  top:0;
  height:0;
  background:#999;
}
.railLineMinor{
  width:var(--lineWMinor);
  border-radius:1px;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  z-index:1;
  top:0;
  height:0;
  background:#999;
}

.stationText{display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start}
.stationName{font-weight:700;font-size:16px;line-height:1.25;margin:0}
.lineBadge{display:inline-block;color:#fff;font-size:12px;line-height:1;padding:2px 6px;border-radius:6px;margin-top:6px;white-space:nowrap}
.toggleWrap{margin-top:6px}
.toggleBtn{cursor:pointer;padding:4px 8px;font-size:12px}

/* minor stations: 駅名上端を dot の上端と揃える（余白は無し） */
.rowBetween{
  display:grid;
  grid-template-columns:var(--gutter) 1fr;
  column-gap:10px;
  align-items:start;
  height:auto;
  padding-top:12px; /* ← 少し広めに調整 */
}
.rowBetween .stationText{
  display:flex;
  align-items:flex-start; /* dotと駅名の上端を揃える */
  padding-top:0;
}
.minorName{
  font-size:14px;
  font-weight:400;
  margin:0;
  position:relative;
  top:-4px; /* ← ここで4px上にずらす（位置以外は変更無し） */
}

/* 線の高さも広めに */
.rowBetween .railLineMinor{
  height:48px; /* 以前は40px。広めに調整 */
}

/* デフォルトで非表示（主要駅のみ） */
.betweenList{ display:none; }

.spacer4{height:4px}
.spacer6{height:6px}

/* 経由地UI */
.viaList{display:flex;flex-direction:column;gap:6px;margin:6px 0;align-items:flex-start}
.viaRow{display:flex;align-items:center;gap:6px;justify-content:flex-start}
.viaRow button{font-size:12px;padding:4px 6px}
</style>
</head>
<body>
<div class="wrap">
<h1>新里地方 乗換案内</h1>

<div class="card">
  <div id="stationSelector">
    <div class="row">
      <div class="col">
        <label>発駅</label>
        <div style="display:flex;gap:6px">
          <select class="lineSelect" id="fromLine"></select>
          <select class="stationSelect" id="fromStation"></select>
        </div>
      </div>

      <div class="col">
        <label>経由地</label>
        <div class="viaList" id="viaList"></div>
        <button id="addViaBtn" class="primary">経由地を追加</button>
      </div>

      <div class="col">
        <label>着駅</label>
        <div style="display:flex;gap:6px">
          <select class="lineSelect" id="toLine"></select>
          <select class="stationSelect" id="toStation"></select>
        </div>
      </div>

      <div style="display:flex;align-items:flex-end;">
        <button id="searchBtn" class="primary">検索</button>
      </div>
    </div>
  </div>
</div>

<div id="resultArea"></div>
</div>

<script>
// ==== 駅・路線データ ====
const stationLines = {
 "新里鉄道湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
 "新里鉄道燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
 "新里鉄道鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
 "新里鉄道新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
 "新里鉄道彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
};
const lineColors = {" Y 新里鉄道湯の浜線":"#00bfff"," A 新里鉄道燠野線":"#ff4d6d"," T 新里鉄道鶴宮線":"#ffa500"," N 新里鉄道新里線":"#228b22"," S 新里鉄道彩山線":"#32cd32"};

const rawGraph={"豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},"栃原":{"宇城":2.2},"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},"御浜":{"伊坂":2.5},"伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},"西新里":{"新里":1.7},"新里":{"河岸":0.9,"南新里":2.5},"河岸":{"新里海浜公園":1.7},"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},"湯の浜":{"七浦":2.5,"新里大学前":0.8},"七浦":{"那珂町":1.6},"那珂町":{"宇多野":2.2},"宇多野":{"伊奈崎":1.8},"伊奈崎":{"鶴宮神社":1.5},"鶴宮神社":{"鶴宮":1.2},"鶴宮":{"北鶴宮":1.1,"南鶴宮":1.7},"新里大学前":{"綾原":0.7},"綾原":{"福来":1.2},"福来":{"燠野":1.4},"燠野":{"湯川":2.6,"紅葉台":1.1},"湯川":{"温泉口":1.6},"温泉口":{"燠野温泉":1.9},"南鶴宮":{"あずさ台":1.4},"あずさ台":{"橘町":1.8},"橘町":{"燠野山口":1.1},"燠野山口":{"白枝":1.2},"白枝":{"燠野":1.1},"紅葉台":{"桐山":0.8},"桐山":{"湊川":0.8},"湊川":{"彩山親水公園":1.1},"彩山親水公園":{"彩山":1.2},"彩山":{"蓮華寺":0.8,"彩山口":2.1},"蓮華寺":{"星宮":1.1},"星宮":{"田ノ原":1.1},"南新里":{"田ノ原":2.3},"田ノ原":{"北玖川":2.4},"北玖川":{"玖川":3.1},"玖川":{"中野原":3.1},"彩山口":{"新里国際スキー場":3.4},"新里国際スキー場":{"鷹見台":10.7},"鷹見台":{"久我原":2.7},"久我原":{"浪原":1.5},"浪原":{"深江":1.4},"深江":{"三栗谷":1.3},"三栗谷":{"桜川公園":1.5},"桜川公園":{"桜川":2.2}};

// --- グラフ作成（双方向） ---
function buildGraphBidirectional(raw){
  const g = {};
  for(const [a,edges] of Object.entries(raw)){
    if(!g[a]) g[a]={};
    for(const [b,d] of Object.entries(edges)){
      g[a][b]=d;
      if(!g[b]) g[b]={};
      if(g[b][a]==null) g[b][a]=d;
    }
  }
  return g;
}
const graph = buildGraphBidirectional(rawGraph);
const allStations = Array.from(new Set([...Object.keys(graph), ...Object.values(graph).flatMap(x => Object.keys(x))])).sort();

// --- 運賃表（距離→運賃） ---
function fareFromTotalDistance(km){
  if(km<=1)return 130;
  if(km<=2)return 140;
  if(km<=3)return 150;
  if(km<=5)return 170;
  if(km<=8)return 200;
  if(km<=12)return 240;
  if(km<=20)return 290;
  if(km<=30)return 350;
  if(km<=40)return 420;
  if(km<=50)return 490;
  if(km<=59)return 540;
  return 540;
}

// --- ヘルパー（路線判定など） ---
function findLineOfSegment(a,b){
  for(const [line,stations] of Object.entries(stationLines)){
    const ia = stations.indexOf(a), ib = stations.indexOf(b);
    if(ia !== -1 && ib !== -1 && Math.abs(ia-ib) === 1) return line;
  }
  return null;
}

// Dijkstra 最短経路（返り値 {path:[], distance:数値}）
function shortestPath(start,goal){
  if(!graph[start] || !graph[goal]) return {path:[],distance:Infinity};
  const dist = {}, prev = {}, Q = new Set(allStations);
  allStations.forEach(s=>{ dist[s] = Infinity; prev[s] = null; });
  dist[start] = 0;
  while(Q.size){
    let u = null, best = Infinity;
    for(const v of Q){ if(dist[v] < best){ u = v; best = dist[v]; } }
    if(u === null) break;
    Q.delete(u);
    if(u === goal) break;
    for(const [v,w] of Object.entries(graph[u]||{})){
      const alt = dist[u] + w;
      if(alt < dist[v]){ dist[v] = alt; prev[v] = u; }
    }
  }
  if(!isFinite(dist[goal])) return {path:[],distance:Infinity};
  const path = []; for(let cur = goal; cur != null; cur = prev[cur]) path.unshift(cur);
  return {path, distance: dist[goal]};
}

function majorStops(path){
  if(path.length <= 1) return {majors: path};
  const majors = [path[0]];
  let curLine = findLineOfSegment(path[0], path[1]);
  for(let i = 1; i < path.length; i++){
    const prev = path[i-1], here = path[i];
    const ln = findLineOfSegment(prev, here);
    if(ln !== curLine){ majors.push(prev); curLine = ln; }
  }
  majors.push(path[path.length-1]);
  return {majors};
}
function findCommonLines(a,b){
  const list = [];
  for(const [line,stations] of Object.entries(stationLines)){
    if(stations.indexOf(a) !== -1 && stations.indexOf(b) !== -1) list.push(line);
  }
  return list;
}

// --- UI 初期化 ---
const fromLineSel = document.getElementById('fromLine');
const toLineSel = document.getElementById('toLine');
const fromStationSel = document.getElementById('fromStation');
const toStationSel = document.getElementById('toStation');
const addViaBtn = document.getElementById('addViaBtn');
const viaListDiv = document.getElementById('viaList');
const searchBtn = document.getElementById('searchBtn');
const resultArea = document.getElementById('resultArea');

function populateLineSelect(sel){
  sel.innerHTML = '';
  Object.keys(stationLines).forEach(l=>{
    const o = document.createElement('option'); o.value = l; o.textContent = l; sel.appendChild(o);
  });
}
function populateStationSelect(lineSel, stationSel){
  stationSel.innerHTML = '';
  const line = lineSel.value;
  (stationLines[line] || []).forEach(st=>{
    const o = document.createElement('option'); o.value = st; o.textContent = st; stationSel.appendChild(o);
  });
}

// 初期の2セット（発・着）のライン/駅を作る
[ fromLineSel, toLineSel ].forEach(sel => populateLineSelect(sel));
populateStationSelect(fromLineSel, fromStationSel);
populateStationSelect(toLineSel, toStationSel);

// リスナー（2つの既存 lineSelect に対して station を更新）
fromLineSel.addEventListener('change', ()=> populateStationSelect(fromLineSel, fromStationSel));
toLineSel.addEventListener('change', ()=> populateStationSelect(toLineSel, toStationSel));

// デフォルト選択（要求どおり）：発 湯の浜線 新里、着 燠野線 燠野温泉
if(stationLines['新里鉄道湯の浜線'] && stationLines['新里鉄道湯の浜線'].indexOf('新里')!==-1){
  fromLineSel.value = '新里鉄道湯の浜線';
  populateStationSelect(fromLineSel, fromStationSel);
  fromStationSel.value = '新里';
}
if(stationLines['新里鉄道燠野線'] && stationLines['新里鉄道燠野線'].indexOf('燠野温泉')!==-1){
  toLineSel.value = '新里鉄道燠野線';
  populateStationSelect(toLineSel, toStationSel);
  toStationSel.value = '燠野温泉';
}

// 経由地追加（無制限）
addViaBtn.addEventListener('click', ()=>{
  const viaRow = document.createElement('div');
  viaRow.className = 'viaRow';

  const lineSel = document.createElement('select');
  lineSel.className = 'lineSelect';
  populateLineSelect(lineSel);

  const stationSel = document.createElement('select');
  stationSel.className = 'stationSelect';
  populateStationSelect(lineSel, stationSel);

  lineSel.addEventListener('change', ()=> populateStationSelect(lineSel, stationSel));

  const delBtn = document.createElement('button');
  delBtn.type = 'button';
  delBtn.textContent = '削除';
  delBtn.addEventListener('click', ()=> { viaListDiv.removeChild(viaRow); });

  viaRow.appendChild(lineSel);
  viaRow.appendChild(stationSel);
  viaRow.appendChild(delBtn);
  viaListDiv.appendChild(viaRow);
});

// レイアウト補助： major/minor line の top/height をドット位置から正確に計算してセットする
function adjustMajorLines(){
  const rows = Array.from(document.querySelectorAll('.rowStation'));
  rows.forEach((row, idx) => {
    const railCol = row.querySelector('.railCol');
    if(!railCol) return;
    const dot = railCol.querySelector('.railDot');
    const line = railCol.querySelector('.railLineMajor');
    if (!dot || !line) return;

    const nextRow = rows.slice(idx + 1).find(r => r.querySelector('.railDot'));
    if (!nextRow) {
      line.style.height = '0px';
      return;
    }

    const parentRect = railCol.getBoundingClientRect();
    const dotRect = dot.getBoundingClientRect();
    const nextDot = nextRow.querySelector('.railDot');
    const nextDotRect = nextDot.getBoundingClientRect();

    line.style.top = (dotRect.top - parentRect.top) + 'px';
    const h = Math.max(0, (nextDotRect.top - dotRect.top)) + 5;
    line.style.height = h + 'px';
  });

  document.querySelectorAll('.rowBetween').forEach(r => {
    const railCol = r.querySelector('.railCol');
    if(!railCol) return;
    const dot = r.querySelector('.railDot');
    const minorLine = r.querySelector('.railLineMinor');
    if(!dot || !minorLine) return;
    const parentRect = railCol.getBoundingClientRect();
    const dotRect = dot.getBoundingClientRect();
    minorLine.style.top = (dotRect.top - parentRect.top) + 'px';
    minorLine.style.height = '48px'; // 固定（広め）
  });
}
function runAdjustments(){ adjustMajorLines(); }
window.addEventListener('resize', runAdjustments);

/* ===========================
   ここからルート検索の新仕様
   =========================== */

// 経由地を順に通る区間最短を繋ぎ、同じ駅を二度以上通るならその直前の経由地で分割
function buildRoutePartsAvoidingDuplicates(from, viaStations, to){
  const waypoints = [from, ...viaStations, to];
  const parts = [];

  let currentPath = [];
  let currentDistance = 0;
  let visited = new Set();

  for(let i=0;i<waypoints.length-1;i++){
    const a = waypoints[i], b = waypoints[i+1];
    const sp = shortestPath(a,b);
    if(!sp.path.length) return null;

    // 連結用に最初の駅重複を避ける
    const segment = (i===0) ? sp.path : sp.path.slice(1);

    // この区間を追加した場合に visited と衝突しないか確認
    let conflict = false;
    for(const st of segment){
      if(visited.has(st)){ conflict = true; break; }
    }

    if(conflict){
      // 直前の経由地（= a）で分割：現在のパートを確定し、新しく開始
      if(currentPath.length){
        parts.push({ path: currentPath.slice(), distance: currentDistance });
      }
      currentPath = sp.path.slice(); // 新しいパート開始（a→b の区間全体）
      currentDistance = sp.distance;
      visited = new Set(sp.path); // 訪問済みをこのパートでリセット
    } else {
      // 問題ないので現在パートに結合
      currentPath = [...currentPath, ...segment];
      currentDistance += sp.distance;
      for(const st of segment) visited.add(st);
    }
  }
  if(currentPath.length){
    parts.push({ path: currentPath.slice(), distance: currentDistance });
  }
  return parts;
}

// 1パート分のルートカードを既存デザインで描画（ルート番号は表示しない）
function renderRouteCardForPart(part, partIndex){
  const path = part.path;
  const { majors } = majorStops(path);

  // ★このルート（パート）の発→着の最短距離で運賃計算
  const partStart = path[0];
  const partEnd = path[path.length - 1];
  const spPart = shortestPath(partStart, partEnd);
  const partFare = fareFromTotalDistance(spPart.distance);

  let routeHtml = `
    <div class="card">
      <div class="resultHeader">
        <div class="meta">
        </div>
      </div>
      <div class="routeLine">
  `;

  majors.forEach((st, idx)=>{
    const nextStation = idx < majors.length - 1 ? majors[idx+1] : null;

    // 線色：該当区間で見つかった路線色を採用
    let color = "#999";
    if(nextStation){
      const iFrom = path.indexOf(st);
      const iTo = path.indexOf(nextStation);
      for(let i=iFrom;i<iTo;i++){
        const ln = findLineOfSegment(path[i], path[i+1]);
        if(ln) color = lineColors[ln] || "#999";
      }
    } else if(idx > 0){
      const prevStation = majors[idx-1];
      const iFrom = path.indexOf(prevStation);
      const iTo = path.indexOf(st);
      for(let i=iFrom;i<iTo;i++){
        const ln = findLineOfSegment(path[i], path[i+1]);
        if(ln) color = lineColors[ln] || "#999";
      }
    }

    const commonLines = nextStation ? findCommonLines(st, nextStation) : [];
    let lineListHtml = '';
    if(commonLines.length > 0){
      lineListHtml = commonLines.map(l => `<div class="lineBadge" style="background:${lineColors[l]};color:#fff">${l}</div>`).join('');
    }

    const bigLineId = `part${partIndex}-bigline-${idx}`;
    routeHtml += `
      <div class="rowStation">
        <div class="railCol">
          <div class="railDot" style="background:${color}"></div>
          ${nextStation ? `<div id="${bigLineId}" class="railLineMajor" style="background:${color}"></div>` : `<div class="spacer6"></div>`}
        </div>
        <div class="stationText">
          <div class="stationName">${st}</div>
          ${lineListHtml}
          ${nextStation ? `<div class="toggleWrap"><button class="toggleBtn" data-part="${partIndex}" data-seg="${idx}" data-open="false">停車駅を表示</button></div>` : ''}
        </div>
      </div>
    `;

    if(nextStation){
      const iFrom = path.indexOf(st);
      const iTo = path.indexOf(nextStation);
      const between = path.slice(iFrom+1, iTo);
      if(between.length > 0){
        routeHtml += `<div id="part${partIndex}-between-${idx}" class="betweenList">`;
        between.forEach(s=>{
          routeHtml += `
            <div class="rowBetween">
              <div class="railCol">
                <div class="railDot" style="background:${color}"></div>
                <div class="railLineMinor" style="background:${color}"></div>
              </div>
              <div class="stationText"><div class="minorName">${s}</div></div>
            </div>
          `;
        });
        routeHtml += `</div>`;
      }
    }
  });

  routeHtml += `</div></div>`;
  return routeHtml;
}

// トグルボタンのイベントを有効化
function wireToggleButtons(){
  document.querySelectorAll('.toggleBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const part = btn.dataset.part;
      const idx = btn.dataset.seg;
      const list = document.getElementById(`part${part}-between-${idx}`);
      if(!list) return;
      const isOpen = getComputedStyle(list).display !== 'block';
      list.style.display = isOpen ? 'block' : 'none';
      btn.dataset.open = isOpen.toString();
      btn.textContent = isOpen ? '停車駅を非表示' : '停車駅を表示';
      runAdjustments();
    });
  });
}

/* ===========================
   検索ボタン：新ロジック
   =========================== */
searchBtn.addEventListener('click', ()=>{
  // 最新の選択状態を取得
  const stationSelectsAll = Array.from(document.querySelectorAll('.stationSelect'));
  const from = stationSelectsAll[0] ? stationSelectsAll[0].value : '';
  const to = stationSelectsAll[stationSelectsAll.length - 1] ? stationSelectsAll[stationSelectsAll.length - 1].value : '';

  // 経由地は viaList 内の stationSelect
  const viaSelects = Array.from(viaListDiv.querySelectorAll('.stationSelect'));
  const viaStations = viaSelects.map(s=>s.value).filter(v=>v);

  // ★修正ポイント（alert→テキスト表示）
  if(!from || !to){
    resultArea.innerHTML = '<div class="card">駅を選択してください</div>';
    return;
  }
  if(from === to && viaStations.length === 0){
    resultArea.innerHTML = '<div class="card">発駅と着駅が同じです</div>';
    return;
  }

  // パート分割付きの経路構築
  const parts = buildRoutePartsAvoidingDuplicates(from, viaStations, to);
  if(!parts || parts.length === 0){
    resultArea.innerHTML = '<div class="card">経路が見つかりませんでした。</div>';
    return;
  }

  // 合計距離は実際に通る距離の総和
  const totalDistance = parts.reduce((acc,p)=>acc+p.distance, 0);

  // ★合計運賃は「各ルート（パート）の発駅→着駅の最短距離」による運賃の合算
  const totalFare = parts.reduce((sum, part)=>{
    const s = part.path[0];
    const t = part.path[part.path.length-1];
    const sp = shortestPath(s, t);
    return sum + fareFromTotalDistance(sp.distance);
  }, 0);

  const headerHtml = `
    <div class="card">
      <div class="resultHeader">
        <div style="font-weight:800">検索結果</div>
        <div class="meta">
          <div>合計距離: <strong>${totalDistance.toFixed(1)} km</strong></div>
          <div>合計運賃: <strong>${totalFare} 円</strong></div>
        </div>
      </div>
    </div>
  `;

  // 各パートをカードで描画（ルート番号は表示しない）
  const bodyHtml = parts.map((part, idx) => renderRouteCardForPart(part, idx)).join('');

  resultArea.innerHTML = headerHtml + bodyHtml;

  // トグルを有効化 & レイアウト調整
  wireToggleButtons();
  setTimeout(runAdjustments, 0);
});
</script>
</body>
</html>
