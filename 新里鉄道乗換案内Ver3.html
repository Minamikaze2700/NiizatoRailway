import tkinter as tk
from tkinter import ttk

# 路線データ
lines = {
    "湯の浜線": ["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園",
               "御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園",
               "湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
    "燠野線": ["新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
    "鶴宮線": ["鶴宮","南鶴宮","東鶴宮","彩川","三津屋","白浜"],
    "彩山線": ["那珂町","彩山口","彩山","彩山温泉"],
    "新里線": ["西新里","西原","片岡","南片岡","北片岡","東片岡"]
}

# 路線カラー
line_colors = {
    "湯の浜線": "#1E90FF",
    "燠野線": "#32CD32",
    "鶴宮線": "#FF4500",
    "彩山線": "#FFD700",
    "新里線": "#8A2BE2"
}

# 経路探索（簡易版: 直通 or 新里乗換）
def find_route(start, goal):
    for line, stations in lines.items():
        if start in stations and goal in stations:
            s, g = stations.index(start), stations.index(goal)
            if s <= g:
                return [(line, stations[i]) for i in range(s, g+1)]
            else:
                return [(line, stations[i]) for i in range(s, g-1, -1)]

    # 新里で乗換
    if start in lines["湯の浜線"] and goal in lines["燠野線"]:
        s_index = lines["湯の浜線"].index(start)
        route1 = [("湯の浜線", st) for st in lines["湯の浜線"][s_index:lines["湯の浜線"].index("新里")+1]]
        route2 = [("燠野線", st) for st in lines["燠野線"]]
        return route1 + route2
    if start in lines["燠野線"] and goal in lines["湯の浜線"]:
        g_index = lines["湯の浜線"].index(goal)
        route1 = [("燠野線", st) for st in lines["燠野線"]]
        route2 = [("湯の浜線", st) for st in lines["湯の浜線"][:g_index+1]]
        return route1 + route2
    return []

# UI部分
root = tk.Tk()
root.title("新里鉄道路線検索")

# 発着駅入力
stations_with_line = [f"{line}{st}" for line, sts in lines.items() for st in sts]

start_var = tk.StringVar()
goal_var = tk.StringVar()

ttk.Label(root, text="出発駅").grid(row=0, column=0)
ttk.Combobox(root, textvariable=start_var, values=stations_with_line, width=20).grid(row=0, column=1)
ttk.Label(root, text="到着駅").grid(row=1, column=0)
ttk.Combobox(root, textvariable=goal_var, values=stations_with_line, width=20).grid(row=1, column=1)

# 結果表示
result_frame = tk.Frame(root)
result_frame.grid(row=3, column=0, columnspan=2)

def show_route():
    for widget in result_frame.winfo_children():
        widget.destroy()

    start, goal = start_var.get(), goal_var.get()
    if not start or not goal:
        return

    start_line, start_station = start[:start.find("線")+1], start[start.find("線")+1:]
    goal_line, goal_station = goal[:goal.find("線")+1], goal[goal.find("線")+1:]

    route = find_route(start_station, goal_station)
    if not route:
        tk.Label(result_frame, text="ルートが見つかりません").pack()
        return

    show_details = tk.BooleanVar(value=False)

    def render():
        for widget in result_frame.winfo_children():
            widget.destroy()

        last_line = None
        for idx, (line, station) in enumerate(route):
            frame = tk.Frame(result_frame)
            frame.pack(anchor="w")

            color = line_colors.get(line, "black")

            # 丸（途中駅小さい）
            size = 14 if idx in [0, len(route)-1] or (idx > 0 and route[idx-1][0] != line) else 8
            canvas = tk.Canvas(frame, width=20, height=20, highlightthickness=0, bg="white")
            canvas.create_oval(10-size//2, 10-size//2, 10+size//2, 10+size//2, fill=color, outline=color)
            if idx < len(route)-1 and route[idx+1][0] == line:
                canvas.create_line(10, 10, 10, 20, fill=color, width=2)
            canvas.pack(side="left")

            # 駅名＋路線名（発駅と乗換のみ）
            text = tk.Label(frame, text=station, anchor="w")
            text.pack(side="left")
            if idx in [0, len(route)-1] or (idx > 0 and route[idx-1][0] != line):
                line_label = tk.Label(frame, text=line, bg=color, fg="white")
                line_label.pack(side="left", padx=5)

            # 途中駅表示
            if idx in [0, len(route)-1] or (idx > 0 and route[idx-1][0] != line):
                toggle_btn = tk.Button(frame, text="途中駅を表示", command=lambda: toggle())
                toggle_btn.pack(side="left")

            # 途中駅表示
            if show_details.get() and not (idx in [0, len(route)-1] or (idx > 0 and route[idx-1][0] != line)):
                tk.Label(frame, text=f"{station}", fg="gray").pack(side="left")

    def toggle():
        show_details.set(not show_details.get())
        render()

    render()

ttk.Button(root, text="検索", command=show_route).grid(row=2, column=0, columnspan=2)

root.mainloop()
