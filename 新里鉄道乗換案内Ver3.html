<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新里鉄道路線 ルート検索</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    svg { border:1px solid #ccc; margin-top:20px; }
    select,button { margin:5px; }
  </style>
</head>
<body>
  <h1>新里鉄道路線 ルート検索</h1>
  <div>
    出発駅: 
    <select id="fromLine"></select>
    <select id="fromStation"></select>
    到着駅: 
    <select id="toLine"></select>
    <select id="toStation"></select>
    <button onclick="searchRoute()">検索</button>
  </div>
  <div id="result"></div>
  <svg id="map" width="1000" height="600"></svg>

<script>
/* ==== 路線データ ==== */
const stationLines = {
  "湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
  "燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
  "鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
  "新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
  "彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"]
};

/* ==== 路線カラー ==== */
const lineColors = {
  "湯の浜線":"#07b5f7",
  "燠野線":"#f28500",
  "鶴宮線":"#e60012",
  "新里線":"#009944",
  "彩山線":"#9b26af"
};

/* ==== 駅間距離データ ==== */
const rawGraph = {
  "豊町":{"東豊町":1.2},
  "東豊町":{"清水浜":1.4},
  "清水浜":{"安田町":1.9},
  "安田町":{"南栃原":2.2},
  "南栃原":{"栃原":0.9},
  "栃原":{"宇城":2.2},
  "宇城":{"須川":2.1},
  "須川":{"御浜埼公園":1.9},
  "御浜埼公園":{"御浜":0.6},
  "御浜":{"伊坂":2.5},
  "伊坂":{"垳下":2.6},
  "垳下":{"北浜":2.3},
  "北浜":{"西新里":1.4},
  "西新里":{"新里":1.7},
  "新里":{"河岸":0.9,"南新里":2.5},
  "河岸":{"新里海浜公園":1.7},
  "新里海浜公園":{"湯の浜海岸":2.3},
  "湯の浜海岸":{"湯の浜":1.5},
  "湯の浜":{"七浦":2.5,"新里大学前":0.8},
  "七浦":{"那珂町":1.6},
  "那珂町":{"宇多野":2.2},
  "宇多野":{"伊奈崎":1.8},
  "伊奈崎":{"鶴宮神社":1.5},
  "鶴宮神社":{"鶴宮":1.2},
  "鶮宮":{"北鶴宮":1.1,"南鶴宮":1.7},
  "新里大学前":{"綾原":0.7},
  "綾原":{"福来":1.2},
  "福来":{"燠野":1.4},
  "燠野":{"湯川":2.6,"紅葉台":1.1},
  "湯川":{"温泉口":1.6},
  "温泉口":{"燠野温泉":1.9},
  "南鶴宮":{"あずさ台":1.4},
  "あずさ台":{"橘町":1.8},
  "橘町":{"燠野山口":1.1},
  "燠野山口":{"白枝":1.2},
  "白枝":{"燠野":1.1},
  "紅葉台":{"桐山":0.8},
  "桐山":{"湊川":0.8},
  "湊川":{"彩山親水公園":1.1},
  "彩山親水公園":{"彩山":1.2},
  "彩山":{"蓮華寺":0.8,"彩山口":2.1},
  "蓮華寺":{"星宮":1.1},
  "星宮":{"田ノ原":1.1},
  "南新里":{"田ノ原":2.3},
  "田ノ原":{"北玖川":2.4},
  "北玖川":{"玖川":3.1},
  "玖川":{"中野原":3.1},
  "彩山口":{"新里国際スキー場":3.4},
  "新里国際スキー場":{"鷹見台":10.7},
  "鷹見台":{"久我原":2.7},
  "久我原":{"浪原":1.5},
  "浪原":{"深江":1.4},
  "深江":{"三栗谷":1.3},
  "三栗谷":{"桜川公園":1.5},
  "桜川公園":{"桜川":2.2}
};
// 双方向化
for(const a in rawGraph){
  for(const b in rawGraph[a]){
    if(!rawGraph[b]) rawGraph[b]={};
    rawGraph[b][a]=rawGraph[a][b];
  }
}

/* ==== 運賃計算 ==== */
function fare(distance){
  if(distance<=3) return {adult:130,child:70};
  else if(distance<=6) return {adult:160,child:80};
  else if(distance<=10) return {adult:190,child:100};
  else if(distance<=15) return {adult:220,child:110};
  else if(distance<=20) return {adult:250,child:130};
  else if(distance<=25) return {adult:280,child:140};
  else if(distance<=30) return {adult:310,child:160};
  else return {adult:340,child:170};
}

/* ==== ダイクストラ ==== */
function dijkstra(start){
  let dist={}, prev={};
  for(const v in rawGraph){ dist[v]=Infinity; prev[v]=null; }
  dist[start]=0;
  let pq=[start];
  while(pq.length){
    let u=pq.reduce((a,b)=>dist[a]<dist[b]?a:b);
    pq=pq.filter(x=>x!==u);
    for(const v in rawGraph[u]){
      let alt=dist[u]+rawGraph[u][v];
      if(alt<dist[v]){
        dist[v]=alt;
        prev[v]=u;
        if(!pq.includes(v)) pq.push(v);
      }
    }
  }
  return {dist,prev};
}
function shortestPath(start,goal){
  let {dist,prev}=dijkstra(start);
  let path=[],u=goal;
  if(prev[u]||u===start){
    while(u){ path.unshift(u); u=prev[u]; }
  }
  return {path,distance:dist[goal]};
}

/* ==== 路線判定 ==== */
function findLineSegment(a,b){
  for(const line in stationLines){
    let arr=stationLines[line];
    for(let i=0;i<arr.length-1;i++){
      if((arr[i]===a && arr[i+1]===b)||(arr[i]===b && arr[i+1]===a)){
        return line;
      }
    }
  }
  return null;
}

/* ==== 描画 ==== */
function drawRoute(result){
  const svg=document.getElementById("map");
  svg.innerHTML="";
  let x=50,y=100;
  for(let i=0;i<result.path.length;i++){
    let st=result.path[i];
    let prevLine=(i>0)?findLineSegment(result.path[i-1],st):null;
    let nextLine=(i<result.path.length-1)?findLineSegment(st,result.path[i+1]):null;
    let isMajor=(i===0 || i===result.path.length-1 || (prevLine && nextLine && prevLine!==nextLine));
    if(isMajor){
      if(i>0){
        let lineColor=lineColors[prevLine]||"#000";
        svg.innerHTML+=`<line x1="${x}" y1="${y}" x2="${x+120}" y2="${y}" stroke="${lineColor}" stroke-width="5"/>`;
        x+=120;
      }
      svg.innerHTML+=`<circle cx="${x}" cy="${y}" r="8" fill="${lineColors[nextLine||prevLine]||"#000"}"/>`;
      svg.innerHTML+=`<text x="${x}" y="${y-12}" text-anchor="middle">${st}</text>`;
      let lineName=nextLine||prevLine;
      if(lineName) svg.innerHTML+=`<text x="${x}" y="${y+20}" text-anchor="middle" font-size="12">${lineName}</text>`;
      if(i<result.path.length-1){
        let segStart=st, segEnd=result.path[i+1];
        let segLine=findLineSegment(segStart,segEnd);
        if(segLine){
          let btn=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");
          btn.setAttribute("x",x-40);
          btn.setAttribute("y",y+25);
          btn.setAttribute("width",80);
          btn.setAttribute("height",30);
          btn.innerHTML=`<button xmlns="http://www.w3.org/1999/xhtml" style="font-size:10px;">途中駅表示</button>`;
          btn.querySelector("button").addEventListener("click",()=>{
            showIntermediateStations(svg,x,y,segStart,segEnd,segLine);
          });
          svg.appendChild(btn);
        }
      }
    }
  }
}

function showIntermediateStations(svg,x,y,start,end,lineName){
  let arr=stationLines[lineName];
  let i1=arr.indexOf(start), i2=arr.indexOf(end);
  if(i1>-1 && i2>-1){
    let seg=arr.slice(Math.min(i1,i2)+1,Math.max(i1,i2));
    let cx=x+60, cy=y+50;
    for(const st of seg){
      svg.innerHTML+=`<circle cx="${cx}" cy="${cy}" r="6" fill="${lineColors[lineName]}"/>`;
      svg.innerHTML+=`<text x="${cx}" y="${cy-10}" text-anchor="middle" font-size="10">${st}</text>`;
      cy+=20;
    }
  }
}

/* ==== UI構築 ==== */
function initSelectors(){
  const fromLine=document.getElementById("fromLine");
  const toLine=document.getElementById("toLine");
  for(const line in stationLines){
    fromLine.add(new Option(line,line));
    toLine.add(new Option(line,line));
  }
  fromLine.onchange=()=>populateStations("from");
  toLine.onchange=()=>populateStations("to");
  populateStations("from");
  populateStations("to");
}
function populateStations(kind){
  const line=document.getElementById(kind+"Line").value;
  const sel=document.getElementById(kind+"Station");
  sel.innerHTML="";
  stationLines[line].forEach(st=>sel.add(new Option(st,st)));
}

/* ==== 検索 ==== */
function searchRoute(){
  const from=document.getElementById("fromStation").value;
  const to=document.getElementById("toStation").value;
  let result=shortestPath(from,to);
  let f=fare(result.distance);
  document.getElementById("result").innerText=
    `距離: ${result.distance.toFixed(1)} km / 運賃: 大人${f.adult}円, 子供${f.child}円`;
  drawRoute(result);
}

initSelectors();
</script>
</body>
</html>
