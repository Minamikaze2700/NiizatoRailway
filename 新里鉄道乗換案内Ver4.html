<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>新里地方 乗換案内 — 修正版（選択不具合対策）</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg:#f1f5f9;
  --card:#fff;
  --muted:#667085;
  --radius:12px;
  --gutter:34px;
  --dotMajor:16px;
  --dotMinor:12px;
  --lineWMajor:5px;
  --lineWMinor:5px;
  --font-sans:"Hiragino Kaku Gothic ProN","Meiryo",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
}
html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:#0b1324}
.wrap{max-width:980px;margin:28px auto;padding:20px;position:relative;z-index:10}
h1{margin:0 0 12px;font-size:20px}
.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(2,6,23,0.07);margin-bottom:12px}
.row{display:flex;gap:12px;align-items:flex-start;flex-direction:column}
.col{display:flex;flex-direction:column;gap:6px;position:relative;align-items:flex-start}
select,button{font-size:14px;padding:8px 10px;border-radius:4px;border:1px solid #d1d5db;background:#fff;position:relative;z-index:9999;pointer-events:auto}
select{min-width:160px}
label{font-size:13px;color:var(--muted)}
button.primary{cursor:pointer;background:#0b5fff;color:#fff;border:none}
.resultHeader{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.resultHeader .meta{display:flex;gap:18px;color:#111}

/* 路線図レイアウト */
.routeLine{display:flex;flex-direction:column;gap:10px;margin-top:4px}
.rowStation{display:grid;grid-template-columns:var(--gutter) 1fr;align-items:start;column-gap:10px;position:relative;}
.railCol{display:flex;flex-direction:column;align-items:center;position:relative;}
.railDot{border-radius:50%;width:var(--dotMajor);height:var(--dotMajor);z-index:2;border:2px solid #fff;position:absolute;left:50%;top:0;transform:translateX(-50%);box-sizing:content-box;}
.rowBetween .railDot{width:var(--dotMinor);height:var(--dotMinor);border:2px solid #fff;position:absolute;left:50%;top:0;transform:translateX(-50%);z-index:2;}
.railLineMajor{width:var(--lineWMajor);border-radius:2px;position:absolute;left:50%;transform:translateX(-50%);z-index:1;top:0;height:0;background:#999;}
.railLineMinor{width:var(--lineWMinor);border-radius:1px;position:absolute;left:50%;transform:translateX(-50%);z-index:1;top:0;height:0;background:#999;}
.stationText{display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start}
.stationName{font-weight:700;font-size:16px;line-height:1.25;margin:0}
.lineBadge{display:inline-block;color:#fff;font-size:13.5px;line-height:1;padding:2px 6px;border-radius:6px;margin-top:6px;white-space:nowrap;margin-right:6px}
.toggleWrap{margin-top:6px}
.toggleBtn{cursor:pointer;padding:4px 8px;font-size:12px}
.rowBetween{display:grid;grid-template-columns:var(--gutter) 1fr;column-gap:10px;align-items:start;height:auto;padding-top:12px;}
.rowBetween .stationText{display:flex;align-items:flex-start;padding-top:0;}
.minorName{font-size:14px;font-weight:400;margin:0;position:relative;top:-4px;}
.condMinorName{font-size:14px;font-weight:300;margin:0;position:relative;top:-4px;color:#333;}
.rowBetween .railLineMinor{height:48px;}
.betweenList{ display:none; }
.spacer4{height:4px}
.spacer6{height:6px}
.viaList{display:flex;flex-direction:column;gap:6px;margin:6px 0;align-items:flex-start}
.viaRow{display:flex;align-items:center;gap:6px;justify-content:flex-start}
.viaRow button{font-size:12px;padding:4px 6px}

/* デバッグ用エラーバー */
#errorBanner{
  position:fixed;
  left:0;right:0;top:0;
  background:#ff4d4f;color:#fff;padding:8px 12px;font-weight:700;z-index:99999;display:none;
  box-shadow:0 6px 24px rgba(0,0,0,0.18);
  font-family:monospace;
  white-space:pre-wrap;
}
</style>
</head>
<body>
<div id="errorBanner"></div>

<div class="wrap">
  <h1>新里地方 乗換案内 — 修正版（選択不具合対策）</h1>

  <div class="card">
    <div id="stationSelector">
      <div class="row">
        <div class="col">
          <label>発駅</label>
          <div style="display:flex;gap:6px">
            <select class="lineSelect" id="fromLine" tabindex="0"></select>
            <select class="stationSelect" id="fromStation" tabindex="0"></select>
          </div>
        </div>

        <div class="col">
          <label>経由地</label>
          <div class="viaList" id="viaList"></div>
          <button id="addViaBtn" class="primary">経由地を追加</button>
        </div>

        <div class="col">
          <label>着駅</label>
          <div style="display:flex;gap:6px">
            <select class="lineSelect" id="toLine" tabindex="0"></select>
            <select class="stationSelect" id="toStation" tabindex="0"></select>
          </div>
        </div>

        <div style="display:flex;align-items:flex-end;">
          <button id="searchBtn" class="primary">検索</button>
        </div>
      </div>
    </div>
  </div>

  <div id="resultArea"></div>
</div>

<script>
// -------------------------
// 安全に初期化するラッパー
// -------------------------
window.addEventListener('error', function(ev){
  const banner = document.getElementById('errorBanner');
  banner.style.display = 'block';
  banner.textContent = 'JavaScript error: ' + (ev && ev.message ? ev.message : String(ev));
});
window.addEventListener('unhandledrejection', function(ev){
  const banner = document.getElementById('errorBanner');
  banner.style.display = 'block';
  banner.textContent = 'Unhandled promise rejection: ' + (ev && ev.reason ? String(ev.reason) : String(ev));
});

document.addEventListener('DOMContentLoaded', () => {
  (function safeInit(){
    try {
      // ==== 駅・路線データ （元データ） ====
      const stationLines = {
       "新里鉄道湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
       "新里鉄道燠野線":["湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"],
       "新里鉄道鶴宮線":["鶴宮","南鶴宮","あずさ台","橘町","燠野山口","白枝","燠野","紅葉台","桐山","湊川","彩山親水公園","彩山","蓮華寺","星宮","田ノ原"],
       "新里鉄道新里線":["新里","南新里","田ノ原","北玖川","玖川","中野原"],
       "新里鉄道彩山線":["彩山","彩山口","新里国際スキー場","鷹見台","久我原","浪原","深江","三栗谷","桜川公園","桜川"],
      "鈴浜電気鉄道鈴浜電鉄線":["桜川国際空港","りんくう桜川","余田","白砂","千種園","大三浜","外神","紅原台","恋野宮","南河都","河都","北河都","百合ヶ丘公園","猫崎海岸","籾井","白木稲荷","流沢温泉口","流沢温泉","京新峡","奥沢高原","原津","神道山口","新的場","虹川","片牧町","鬼越峠","北鶴宮"],
      "桜川電気鉄道彩山線":["喜多瀬浜","喜多瀬","久我山","桜鉄彩山口"],
      "桜川電気鉄道空港線":["桜川","公園東口","桜川公園北口","御厨","南深江","北深江","桜鉄浪原","東浪原","喜多瀬浜","葵台","汐見台","月野原","高瀬","結原","りんくう桜川","桜川国際空港"],
      "桜川電気鉄道桜州環状線":["八軒町","川渡","西中野","中野","東中野","桜台","福原","桜鉄久我原","浪原","桜鉄浪原","彩山川","似島","中洲","糸島","南糸島","野瀬","新浜","海岸通り","桜町","東片野","東新地","新地"],
      "桜川電気鉄道中野線":["中野","南中野","大里","栄町","北桜川","桜川","南桜川","東豊野","すすき野","永田","平川","片野","北新地","新地"],
        "豊野鉄道豊野線":["糸島","西糸島","平田","文京町","東桜川","桜川","豊野月見台","豊野","西豊野","白州川","春田","桜峠","桑畑","常盤台","天津川","広野","追分","野川","幕生","羽草","清見台","東園木","園木"],
      "豊野鉄道新地線":["春田","南春田","日野原","加納","永楽町","室町","西新地","新地"],
      "豊野鉄道坂川線":["桑畑","北桑畑","坂川","天津温泉"],
        "坂津電鉄坂津本線":["坂津港","港通","坂電坂津","大井野","中天神町","飯倉町","酒何町","能地","初川","春原","岩川崎"],
      "坂津電鉄豊町線":["豊町","削野","勝垰","重石町","東坂津","港通"],
        "坂津ポートライナー線":["横宿","北横宿","総合運動場","郡元","鈴里","港通","坂津港"],
      "今橋鉄道成津線":["今橋","新今橋","土川","小弥又","大弥又","今橋学園前","久末","大町","成津","東成津","津塚","牛ヶ瀬","松橋","合浜","綿部","陣中原","萱海","弦川","二番街","高越","築田市","南築田","榎仏子","高座","口松","津垣","大道寺"],
      "今橋鉄道豊海線":["成津","北成津","原葉","徳橋","発樫","豊海","虹松","甲部","夕陽ヶ浜","艶華","富士町","園木"],
        "東橋鉄道東橋本線":[
          "東橋","河井町","黒田","新東橋","浅見","柴若","六日市通","岩田城","内山","新荘",
          "葉賀ノ台","木森","理李ヶ丘","小査","寺尾","栗島","宮間","大木沢","園木","新東園木",
          "綾山","豊川大野","垂生崎","南豊川","幕ヶ原","咲田口"
        ],
        "東橋鉄道横宿線":[
          "新東橋","東黒田","杜山","新大崎","小柴","朋田","和泉原","日森町","横宿"
        ]
      };

      const lineColors = {
        "新里鉄道湯の浜線":"#00bfff",
        "新里鉄道燠野線":"#ff4d6d",
        "新里鉄道鶴宮線":"#ffa500",
        "新里鉄道新里線":"#228b22",
        "新里鉄道彩山線":"#32cd32",
        "鈴浜電気鉄道鈴浜電鉄線":"#0c9451",
        "桜川電気鉄道彩山線":"#20b07b",
        "桜川電気鉄道中野線":"#e296f1",
        "桜川電気鉄道空港線":"#2dbbe5",
        "桜川電気鉄道桜州環状線":"#f18b23",
        "豊野鉄道豊野線":"#239d54",
        "豊野鉄道新地線":"#f06719",
        "豊野鉄道坂川線":"#fdc01f",
        "坂津電鉄坂津本線":"#0044cc",
        "坂津電鉄豊町線":"#0044cc",
        "坂津ポートライナー線":"#33ccff",
        "今橋鉄道豊海線":"#1f1fff",
        "今橋鉄道成津線":"#ff0000",
        "東橋鉄道東橋本線":"#00cc99",
        "東橋鉄道横宿線":"#0099cc"
      };

      // ==== 距離グラフ ====
      // （既存の rawGraph 大量データをここに入れます。省略せず実際のファイルでは全データを含めてください）
      const rawGraph = {
        "豊町":{"東豊町":1.2}, "東豊町":{"清水浜":1.4}, "清水浜":{"安田町":1.9},
        /* --- 中略: 実運用ではここに全部入っている想定 --- */
        // 東橋・横宿系の最低限の距離（重要）
        "東橋": { "河井町": 2.2 },
        "河井町": { "黒田": 2.1 },
        "黒田": { "新東橋": 4.0 },
        "新東橋": { "浅見": 2.5 ,"東黒田": 2.2},
        "浅見": { "柴若": 2.2 },
        "柴若": { "六日市通": 1.9 },
        "六日市通": { "岩田城": 2.7 },
        "岩田城": { "内山": 3.7 },
        "内山": { "新荘": 2.5 },
        "新荘": { "葉賀ノ台": 2.0 },
        "葉賀ノ台": { "木森": 3.1 },
        // 横宿線
        "東黒田": { "杜山": 2.4 },
        "杜山": { "新大崎": 2.7 },
        "新大崎": { "小柴": 2.2 },
        "小柴": { "朋田": 1.9 },
        "朋田": { "和泉原": 2.5 },
        "和泉原": { "日森町": 2.0 },
        "日森町": { "横宿": 3.9 }
      };

      // --- build graph safely ---
      function buildGraphBidirectional(raw){
        const g = {};
        for(const [a,edges] of Object.entries(raw)){
          if(!g[a]) g[a] = {};
          for(const [b,d] of Object.entries(edges)){
            g[a][b] = d;
            if(!g[b]) g[b] = {};
            if(g[b][a] == null) g[b][a] = d;
          }
        }
        return g;
      }
      const graph = buildGraphBidirectional(rawGraph);
      const allStations = Array.from(new Set([...Object.keys(graph), ...Object.values(graph).flatMap(x => Object.keys(x))])).sort();

      // ---- 以下、必要な関数群を定義（運賃、経路探索、表示用） ----
      function companyFromLineName(line){
        if(!line) return null;
        if(line.startsWith("今橋鉄道")) return "今橋鉄道";
        if(line.startsWith("桜川電気鉄道")) return "桜川電気鉄道";
        if(line.startsWith("坂津電鉄")) return "坂津電鉄";
        if(line.startsWith("坂津ポートライナー")) return "坂津ポートライナー";
        if(line.startsWith("鈴浜電気鉄道")) return "鈴浜電気鉄道";
        if(line.startsWith("豊野鉄道")) return "豊野鉄道";
        if(line.startsWith("東橋鉄道")) return "東橋鉄道";
        if(line.startsWith("新里鉄道")) return "新里鉄道";
        return null;
      }

      function findLinesOfSegment(a,b){
        const candidates = [];
        for(const [line, stations] of Object.entries(stationLines)){
          const ia = stations.indexOf(a);
          const ib = stations.indexOf(b);
          if(ia !== -1 && ib !== -1 && Math.abs(ia - ib) === 1){
            candidates.push(line);
          }
        }
        return candidates;
      }
      function findLineOfSegment(a,b){
        const cs = findLinesOfSegment(a,b);
        return cs.length ? cs[0] : null;
      }

      function shortestPath(start,goal){
        if(!graph[start] || !graph[goal]) return {path:[],distance:Infinity};
        const dist = {}, prev = {}, Q = new Set(allStations);
        allStations.forEach(s=>{ dist[s] = Infinity; prev[s] = null; });
        dist[start] = 0;
        while(Q.size){
          let u = null, best = Infinity;
          for(const v of Q){ if(dist[v] < best){ u = v; best = dist[v]; } }
          if(u === null) break;
          Q.delete(u);
          if(u === goal) break;
          for(const [v,w] of Object.entries(graph[u]||{})){
            const alt = dist[u] + w;
            if(alt < dist[v]){ dist[v] = alt; prev[v] = u; }
          }
        }
        if(!isFinite(dist[goal])) return {path:[],distance:Infinity};
        const path = []; for(let cur = goal; cur != null; cur = prev[cur]) path.unshift(cur);
        return {path, distance: dist[goal]};
      }

      // 簡易 Dijkstra（会社内最短）
      function shortestPathWithinCompany(start, goal, company){
        if(!graph[start] || !graph[goal]) return {path:[],distance:Infinity};
        const dist = {}, prev = {}, Q = new Set(allStations);
        allStations.forEach(s=>{ dist[s] = Infinity; prev[s] = null; });
        dist[start] = 0;
        while(Q.size){
          let u = null, best = Infinity;
          for(const v of Q){ if(dist[v] < best){ u = v; best = dist[v]; } }
          if(u === null) break;
          Q.delete(u);
          if(u === goal) break;
          for(const [v,w] of Object.entries(graph[u]||{})){
            const ln = findLineOfSegment(u, v);
            const comp = ln ? companyFromLineName(ln) : null;
            if(comp !== company) continue;
            const alt = dist[u] + w;
            if(alt < dist[v]){ dist[v] = alt; prev[v] = u; }
          }
        }
        if(!isFinite(dist[goal])) return {path:[],distance:Infinity};
        const path = []; for(let cur = goal; cur != null; cur = prev[cur]) path.unshift(cur);
        return {path, distance: dist[goal]};
      }

      // 途中駅扱いなどの補助データ（抜粋）
      const connectingStations = [
        { station: "北鶴宮", endpoints: ["鶴宮","鬼越峠"] },
        { station: "湯の浜", endpoints: ["湯の浜海岸","新里大学前"] },
        { station: "新東橋", endpoints: ["浅見", "東黒田"] },
        { station: "横宿", endpoints: ["日森町", "北横宿"] }
      ];
      const specialMajorStations = ["新里","湯の浜","鶴宮","新東橋","横宿"];

      function indexesOf(arr, value){
        const out=[]; for(let i=0;i<arr.length;i++) if(arr[i]===value) out.push(i); return out;
      }
      function betweenExclusive(idx, a, b){ return (a < idx && idx < b) || (b < idx && idx < a); }
      function findIndexFrom(path, station, start){
        for(let i=start;i<path.length;i++){
          if(path[i] === station) return i;
        }
        return -1;
      }

      // majorStops 簡潔版（新東橋の表示ルールはこの後 caller 側で扱う）
      function majorStops(path){
        if(path.length <= 1) return {majors: path.slice()};
        const majors = [path[0]];
        let curLine = findLineOfSegment(path[0], path[1]);
        for(let i = 1; i < path.length; i++){
          const prev = path[i-1];
          const here = path[i];
          const ln = findLineOfSegment(prev, here);
          let isBoundary = (ln !== curLine);
          let isSpecialSkip = false;
          if(specialMajorStations.includes(here) && i > 0 && i < path.length-1){
            const before = path[i-1];
            const after  = path[i+1];
            if(findLineOfSegment(before, here) && findLineOfSegment(here, after)){
              isSpecialSkip = true;
            }
          }
          if(isBoundary && !isSpecialSkip){
            majors.push(prev);
            curLine = ln;
          } else {
            curLine = ln;
          }
        }
        majors.push(path[path.length-1]);
        return {majors};
      }

      // ----- UI 初期化（DOMが準備できているためここで安全） -----
      const fromLineSel = document.getElementById('fromLine');
      const toLineSel = document.getElementById('toLine');
      const fromStationSel = document.getElementById('fromStation');
      const toStationSel = document.getElementById('toStation');
      const addViaBtn = document.getElementById('addViaBtn');
      const viaListDiv = document.getElementById('viaList');
      const searchBtn = document.getElementById('searchBtn');
      const resultArea = document.getElementById('resultArea');

      function populateLineSelect(sel){
        sel.innerHTML = '';
        Object.keys(stationLines).forEach(l=>{
          const o = document.createElement('option'); o.value = l; o.textContent = l; sel.appendChild(o);
        });
      }
      function populateStationSelect(lineSel, stationSel){
        stationSel.innerHTML = '';
        const line = lineSel.value;
        (stationLines[line] || []).forEach(st=>{
          const o = document.createElement('option'); o.value = st; o.textContent = st; stationSel.appendChild(o);
        });
      }

      // 初期化実行
      populateLineSelect(fromLineSel);
      populateLineSelect(toLineSel);
      populateStationSelect(fromLineSel, fromStationSel);
      populateStationSelect(toLineSel, toStationSel);

      // 既定値
      if(stationLines['新里鉄道湯の浜線'] && stationLines['新里鉄道湯の浜線'].indexOf('新里')!==-1){
        fromLineSel.value = '新里鉄道湯の浜線';
        populateStationSelect(fromLineSel, fromStationSel);
        fromStationSel.value = '新里';
      }
      if(stationLines['新里鉄道燠野線'] && stationLines['新里鉄道燠野線'].indexOf('燠野温泉')!==-1){
        toLineSel.value = '新里鉄道燠野線';
        populateStationSelect(toLineSel, toStationSel);
        toStationSel.value = '燠野温泉';
      }

      fromLineSel.addEventListener('change', ()=> populateStationSelect(fromLineSel, fromStationSel));
      toLineSel.addEventListener('change', ()=> populateStationSelect(toLineSel, toStationSel));

      addViaBtn.addEventListener('click', ()=>{
        const viaRow = document.createElement('div');
        viaRow.className = 'viaRow';
        const lineSel = document.createElement('select');
        lineSel.className = 'lineSelect';
        populateLineSelect(lineSel);
        const stationSel = document.createElement('select');
        stationSel.className = 'stationSelect';
        populateStationSelect(lineSel, stationSel);
        lineSel.addEventListener('change', ()=> populateStationSelect(lineSel, stationSel));
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = '削除';
        delBtn.addEventListener('click', ()=> { viaListDiv.removeChild(viaRow); });
        viaRow.appendChild(lineSel);
        viaRow.appendChild(stationSel);
        viaRow.appendChild(delBtn);
        viaListDiv.appendChild(viaRow);
      });

      // ヘルパー：経路分割（重複回避） — 必要最小限を実装
      function buildRoutePartsAvoidingDuplicates(from, viaStations, to){
        const waypoints = [from, ...viaStations, to];
        const parts = [];
        let currentPath = [];
        let currentDistance = 0;
        let visited = new Set();
        for(let i=0;i<waypoints.length-1;i++){
          const a = waypoints[i], b = waypoints[i+1];
          const sp = shortestPath(a,b);
          if(!sp.path.length) return null;
          const segment = (i===0) ? sp.path : sp.path.slice(1);
          let conflict = false;
          for(const st of segment){
            if(visited.has(st)){ conflict = true; break; }
          }
          if(conflict){
            if(currentPath.length){
              parts.push({ path: currentPath.slice(), distance: currentDistance });
            }
            currentPath = sp.path.slice();
            currentDistance = sp.distance;
            visited = new Set(sp.path);
          } else {
            currentPath = [...currentPath, ...segment];
            currentDistance += sp.distance;
            for(const st of segment) visited.add(st);
          }
        }
        if(currentPath.length){
          parts.push({ path: currentPath.slice(), distance: currentDistance });
        }
        return parts;
      }

      // render の最小実装（主要駅判定だけ使う）
      function renderRouteCardForPart(part, partIndex){
        const path = part.path;
        const {majors} = majorStops(path);
        let html = '<div class="card"><div class="routeLine">';
        for(let i=0;i<majors.length;i++){
          const st = majors[i];
          html += `
            <div class="rowStation">
              <div class="railCol">
                <div class="railDot" style="background:#999"></div>
                <div class="railLineMajor" style="background:#999"></div>
              </div>
              <div class="stationText"><div class="stationName">${st}</div></div>
            </div>
          `;
        }
        html += '</div></div>';
        return html;
      }

      // 検索イベント（最小安全パス）
      searchBtn.addEventListener('click', ()=>{
        try {
          const stationSelectsAll = Array.from(document.querySelectorAll('.stationSelect'));
          const from = stationSelectsAll[0] ? stationSelectsAll[0].value : '';
          const to = stationSelectsAll[stationSelectsAll.length - 1] ? stationSelectsAll[stationSelectsAll.length - 1].value : '';
          const viaSelects = Array.from(viaListDiv.querySelectorAll('.stationSelect'));
          const viaStations = viaSelects.map(s=>s.value).filter(v=>v);

          if(!from || !to){
            resultArea.innerHTML = '<div class="card">駅を選択してください</div>';
            return;
          }
          if(from === to && viaStations.length === 0){
            resultArea.innerHTML = '<div class="card">発駅と着駅が同じです</div>';
            return;
          }

          const parts = buildRoutePartsAvoidingDuplicates(from, viaStations, to);
          if(!parts || parts.length === 0){
            resultArea.innerHTML = '<div class="card">経路が見つかりませんでした。</div>';
            return;
          }

          const totalDistance = parts.reduce((acc,p)=>acc+p.distance, 0);
          resultArea.innerHTML = `<div class="card"><div style="font-weight:800">検索結果</div><div>合計距離: ${totalDistance.toFixed(1)} km</div></div>`;
          resultArea.innerHTML += parts.map((part, idx) => renderRouteCardForPart(part, idx)).join('');
        } catch(e){
          console.error("検索時エラー", e);
          const banner = document.getElementById('errorBanner');
          banner.style.display = 'block';
          banner.textContent = '検索時エラー: ' + e.message;
        }
      });

      // 起動完了メッセージを Console に
      console.log("初期化完了: select に駅が読み込まれています。");
    } catch(initErr){
      console.error("初期化中に例外が発生しました:", initErr);
      const banner = document.getElementById('errorBanner');
      banner.style.display = 'block';
      banner.textContent = '初期化エラー: ' + (initErr && initErr.message ? initErr.message : String(initErr));
    }
  })();
});
</script>
</body>
</html>
