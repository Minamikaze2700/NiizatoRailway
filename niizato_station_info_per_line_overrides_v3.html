<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>新里鉄道 駅情報表示（完全版：全路線全駅 個別設定）</title>
<style>
  :root{--panel-gap:14px;--accent:#0b6fb8;--muted:#666;--bg:#fbfbfb;}
  body{font-family:"Helvetica","Arial",sans-serif;margin:0;padding:16px;background:#fff;color:#111;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
  h1{font-size:18px;margin:0;}
  main{display:grid;grid-template-columns:320px 1fr;gap:var(--panel-gap);align-items:start;}
  @media (max-width:880px){ main{grid-template-columns:1fr;} }
  .panel{background:var(--bg);border:1px solid #e6e6e6;padding:12px;border-radius:10px;}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;}
  select{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;background:#fff;margin-bottom:8px;}
  .buttons{display:flex;flex-direction:column;gap:8px;margin-top:6px;}
  .buttons button{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;text-align:left;font-size:14px;}
  .buttons button.active{background:var(--accent);color:#fff;border-color:var(--accent);}
  #infoDisplay{background:var(--bg);border:1px solid #e6e6e6;padding:12px;border-radius:10px;min-height:240px;}
  #stationHeader{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
  .station-title{font-size:18px;font-weight:700;margin:0;}
  .station-meta{color:var(--muted);font-size:13px;margin-top:4px;}
  .num-vertical{display:inline-flex;flex-direction:column;justify-content:center;align-items:center;width:40px;height:40px;padding:-2px;box-sizing:border-box;font-weight:700;color:#fff;margin-right:8px;}
  .num-vertical.filled{border-radius:0;}
  .num-vertical.rounded{border-radius:10px;background:transparent;border:4.5px solid;color:#000;}
  .num-vertical.circle{border-radius:50%;background:transparent;border:5px solid;color:#000;}
  .small-code{display:inline-flex;align-items:center;justify-content:center;width:36px;height:32px;border-radius:6px;border:3px solid #bbb;background:transparent;font-weight:700;margin-right:8px;}
  .small-code.filled{background:var(--lc);color:#fff;border:0;}
  .small-code.rounded{border-radius:8px;background:transparent;color:#000;}
  .small-code.circle{border-radius:50%;width:36px;height:36px;background:transparent;color:#000;}
  .tabbar{display:flex;gap:8px;margin-bottom:10px;}
  .tabbar button{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
  .tabbar button.active{background:var(--accent);color:#fff;border-color:var(--accent);}
  .content-area{padding:8px;border-radius:8px;background:#fff;border:1px solid #eee;min-height:160px;}

  .timetable-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
  .dir-btn{padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
  .dir-btn.active{background:#0b6fb8;color:#fff;border-color:#0b6fb8;}

  .timetable-simple{display:flex;flex-direction:column;gap:8px;}
  .tt-line{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid #f0f0f0;background:#fcfcfc;justify-content:flex-start;}
  .tt-type{padding:4px 8px;border-radius:6px;font-weight:700;color:#fff;font-size:13px;min-width:96px;text-align:center;}
  .tt-time{width:64px;font-weight:700;font-family:monospace;text-align:right;}
  .tt-dest{font-weight:700;display:flex;align-items:center;gap:8px;}

  .plat-circle{
    display:inline-flex;align-items:center;justify-content:center;
    width:26px;height:26px;border-radius:50%;border:2px solid #333;font-weight:700;font-size:13px;margin-left:6px;
    background:transparent;color:#000;
  }

  .type-local{background:#4caf50;}
  .type-express{background:#ff7043;}
  .type-rapid{background:#29b6f6;color:#000;}

  .muted{color:var(--muted);font-size:13px;}
  .editor-hint{font-size:13px;color:#444;margin-top:8px;background:#fff;padding:8px;border-radius:6px;border:1px dashed #ddd;}
</style>
</head>
<body>
<header>
  <h1>新里鉄道 駅情報表示（全路線・全駅 個別設定）</h1>
</header>

<main>
  <aside class="panel" aria-label="操作パネル">
    <label for="companySelect">会社</label>
    <select id="companySelect"><option value="">選択してください</option><option value="新里鉄道">新里鉄道</option></select>
    <label for="lineSelect">路線</label>
    <select id="lineSelect" disabled><option value="">先に会社を選んでください</option></select>
    <label for="stationSelect">駅</label>
    <select id="stationSelect" disabled><option value="">先に路線を選んでください</option></select>
    <div class="buttons" id="infoButtons" role="tablist" aria-label="情報メニュー">
      <button data-view="platforms" class="active" role="tab">のりば案内</button>
      <button data-view="timetable" role="tab">時刻表</button>
      <button data-view="exits" role="tab">出口案内</button>
      <button data-view="details" role="tab">詳細</button>
    </div>
    <div class="editor-hint">
      <strong>備考：</strong>各駅の個別データは「路線ごと」に管理されます。駅番号は数字のみ（例: 01, 02）で、路線記号は路線データ側で表示されます。ファイル内の <code>STATION_OVERRIDES_BY_LINE</code> を編集してください。
    </div>
  </aside>

  <section id="infoDisplay" class="panel" aria-live="polite">
    <div id="stationHeader">
      <div id="stationNumber" style="display:flex;align-items:center;"></div>
      <div>
        <div id="stationName" class="station-title">駅が選択されていません</div>
        <div id="stationSub" class="station-meta">会社・路線・駅番号などがここに表示されます</div>
      </div>
    </div>

    <div class="tabbar" role="tablist" id="tabbar">
      <button data-view="platforms" class="active">のりば案内</button>
      <button data-view="timetable">時刻表</button>
      <button data-view="exits">出口案内</button>
      <button data-view="details">詳細</button>
    </div>

    <div class="content-area" id="infoContent">駅を選択するとここに表示されます。</div>
  </section>
</main>

<script>
/* Priority order */
const LINE_PRIORITY = ["湯の浜線","燠野線","鶴宮線","新里線","彩山線"];

/* DATA (彩山線は atwiki から取得・更新済み) */
const DATA = {
  "新里鉄道": {
    "湯の浜線": { code:"Y", colorHex:"#07b5f7", style:"circle", stations:[
"豊町駅","東豊町駅","清水浜駅","安田町駅","南栃原駅","栃原駅","宇城駅","須川駅","御浜埼公園駅","御浜駅",
"伊坂駅","垳下駅","北浜駅","西新里駅","新里駅","河岸駅","新里海浜公園駅","湯の浜海岸駅","湯の浜駅","七浦駅",
"那珂町駅","宇多野駅","伊奈崎駅","鶴宮神社駅","鶴宮駅","北鶴宮駅","鬼越峠駅","片牧町駅","虹川駅","新的場駅",
"神道山口駅","原津駅","奥沢高原駅","京新峡駅","流沢温泉駅","流沢温泉口駅","白木稲荷駅","籾井駅","猫崎海岸駅","百合ヶ山公園駅",
"北河都駅","河都駅","南河都駅","恋野宮駅","紅原台駅","外神駅","大三浜駅","千種園駅","白砂駅","余田駅","りんくう桜川駅"
] },
    "燠野線": { code:"A", colorHex:"#fd5062", style:"circle", stations:["湯の浜駅","新里大学前駅","綾原駅","福来駅","燠野駅","湯川駅","温泉口駅"] },
    "鶴宮線": { code:"T", colorHex:"#feac2c", style:"circle", stations:["鶴宮駅","南鶴宮駅","あずさ台駅","橘町駅","白枝駅","紅葉台駅","桐山駅","湊川駅","彩山駅","田ノ原駅"] },
    "新里線": { code:"N", colorHex:"#0cab5e", style:"circle", stations:["新里駅","南新里駅","田ノ原駅","北玖川駅","玖川駅","中野原駅"] },
    /* 彩山線を atwiki (新里地方wiki) から更新しました（S-01〜S-10）。*/
    "彩山線": { code:"S", colorHex:"#7dca22", style:"circle", stations:[
"彩山駅","彩山口駅","新里国際スキー場駅","鷹見台駅","久我原駅","浪原駅","深江駅","三栗谷駅","桜川公園駅","桜川駅"
] }
  }
};

/* Build STATION_OVERRIDES_BY_LINE - per-line, per-station individual data (数字のみのナンバリング)
   This generates an override object for every station on every line so that all stations are "individually configurable".
   The generated stationNumber is numeric-only (e.g. "01","02").
   You can still edit STATION_OVERRIDES_BY_LINE later to customize platforms/timetables/exits/details for specific stations.
*/
const STATION_OVERRIDES_BY_LINE = {};
for(const company of Object.keys(DATA)){
  STATION_OVERRIDES_BY_LINE[company] = {};
  for(const lineName of Object.keys(DATA[company])){
    const line = DATA[company][lineName];
    STATION_OVERRIDES_BY_LINE[company][lineName] = {};
    for(const [i, station] of line.stations.entries()){
      // default per-station override for this line
      STATION_OVERRIDES_BY_LINE[company][lineName][station] = {
        // numeric only station number (two digits). The route symbol (Y/A/T/S/N etc) is stored in line.code.
        stationNumber: String(i+1).padStart(2,'0'),
        platforms: [`${lineName}方面（のりば1）`,`対向方面（のりば2）`],
        timetables: [
          { typeLabel:"各駅停車", typeClass:"type-local", time: `${String(6 + Math.floor(i/10)).padStart(2,'0')}:${String((10 + i*3)%60).padStart(2,'0')}`, destination: `${lineName}方面`, platformNumber:1 },
          { typeLabel:"急行", typeClass:"type-express", time: `${String(6 + Math.floor((i+5)/10)).padStart(2,'0')}:${String((25 + i*2)%60).padStart(2,'0')}`, destination: `主要方面`, platformNumber:2 }
        ],
        exits: ["北口 - バス停","南口 - タクシー乗り場"],
        details: { address:`架空県 ${company} ${lineName} ${station}`, contact:"電話:000-0000-0000" }
      };
    }
  }
}

/* Helper: get per-line override if exists */
function getPerLineOverride(company, lineName, station){
  if(STATION_OVERRIDES_BY_LINE[company] && STATION_OVERRIDES_BY_LINE[company][lineName] && STATION_OVERRIDES_BY_LINE[company][lineName][station]){
    return STATION_OVERRIDES_BY_LINE[company][lineName][station];
  }
  return null;
}

/* Build merged per-station info for display (keeps older behavior but uses per-line overrides when rendering after line selection) */
const STATION_INFO = {};
function sampleTime(baseH, baseM){
  let h = baseH; let m = baseM + Math.floor(Math.random()*30);
  if(m>=60){ h+=Math.floor(m/60); m%=60; }
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

/* Stations that should have platform numbers (legacy fallback) */
const PLAT_NUM_STATIONS = new Set();
// example additions
PLAT_NUM_STATIONS.add("豊町駅");
PLAT_NUM_STATIONS.add("鶴宮駅");
PLAT_NUM_STATIONS.add("彩山駅");

/* Build default STATION_INFO (generic), but per-line overrides will be preferred when a line is selected */
for(const company of Object.keys(DATA)){
  const lines = DATA[company];
  for(const lineName of Object.keys(lines)){
    const line = lines[lineName];
    for(const [idx, station] of line.stations.entries()){
      if(!STATION_INFO[station]) STATION_INFO[station] = { platforms: [], timetables: [], exits: [], details: {} };
      // default platforms (simple)
      if(STATION_INFO[station].platforms.length === 0){
        STATION_INFO[station].platforms = [`${lineName}方面（のりば1）: ${line.code}${String(idx+1).padStart(2,'0')}`, `対向方面（のりば2）`];
      }
      const hasPlat = PLAT_NUM_STATIONS.has(station);
      const t1 = { typeLabel:"急行", typeClass:"type-express", time: sampleTime(6,10+(idx%10)), destination: lineName + "方面", lineCode: line.code, platformNumber: hasPlat? 1 : undefined };
      const t2 = { typeLabel:"各駅停車", typeClass:"type-local", time: sampleTime(6,30+(idx%20)), destination: "市内各停車駅方面", lineCode: line.code, platformNumber: hasPlat? 2 : undefined };
      STATION_INFO[station].timetables.push(t1, t2);
      STATION_INFO[station].exits = ["北口 - バスターミナル","南口 - 駅ビル・タクシー乗り場"];
      STATION_INFO[station].details = { address:"架空県 架空市（仮）", contact:"電話:000-0000-0000" };
    }
  }
}

/* DOM refs */
const companySelect = document.getElementById('companySelect');
const lineSelect = document.getElementById('lineSelect');
const stationSelect = document.getElementById('stationSelect');
const infoButtons = document.getElementById('infoButtons');
const infoContent = document.getElementById('infoContent');
const stationNumber = document.getElementById('stationNumber');
const stationName = document.getElementById('stationName');
const stationSub = document.getElementById('stationSub');
const tabbar = document.getElementById('tabbar');

/* Populate selects */
companySelect.addEventListener('change', ()=>{
  const company = companySelect.value;
  lineSelect.innerHTML=''; stationSelect.innerHTML='<option value="">先に路線を選んでください</option>'; stationSelect.disabled=true;
  if(!company){ lineSelect.innerHTML='<option value="">先に会社を選んでください</option>'; lineSelect.disabled=true; clearInfo(); return; }
  const lines = Object.keys(DATA[company]||{});
  const ph=document.createElement('option'); ph.value=''; ph.textContent='選択してください'; lineSelect.appendChild(ph);
  for(const l of lines){ const opt=document.createElement('option'); opt.value=l; opt.textContent=l; lineSelect.appendChild(opt); }
  lineSelect.disabled=false; clearInfo();
});
lineSelect.addEventListener('change', ()=>{
  const company = companySelect.value; const line=lineSelect.value;
  stationSelect.innerHTML=''; if(!line){ stationSelect.innerHTML='<option value="">選択してください</option>'; stationSelect.disabled=true; clearInfo(); return; }
  const stations=(DATA[company]&&DATA[company][line])?DATA[company][line].stations:[]; const ph=document.createElement('option'); ph.value=''; ph.textContent='選択してください'; stationSelect.appendChild(ph);
  for(const s of stations){ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; stationSelect.appendChild(opt); }
  stationSelect.disabled=false; clearInfo();
});

/* Handlers */
stationSelect.addEventListener('change', ()=>{ renderHeaderBadges(); const view = getActiveView(); renderInfo(view); });

infoButtons.addEventListener('click',(e)=>{ if(e.target.tagName!=='BUTTON') return; const btns=infoButtons.querySelectorAll('button'); btns.forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); const view=e.target.dataset.view; renderInfo(view); setActiveTab(view); });
tabbar.addEventListener('click',(e)=>{ if(e.target.tagName!=='BUTTON') return; const view=e.target.dataset.view; setActiveTab(view); const leftBtn = infoButtons.querySelector('button[data-view="'+view+'"]'); if(leftBtn){ const btns=infoButtons.querySelectorAll('button'); btns.forEach(b=>b.classList.remove('active')); leftBtn.classList.add('active'); } renderInfo(view); });
function setActiveTab(view){ const tabs=tabbar.querySelectorAll('button'); tabs.forEach(t=>t.classList.remove('active')); const active=tabbar.querySelector('button[data-view="'+view+'"]'); if(active) active.classList.add('active'); }
function getActiveView(){ const btn=infoButtons.querySelector('button.active'); return btn?btn.dataset.view:'platforms'; }
function clearInfo(){ stationNumber.innerHTML=''; stationName.textContent='駅が選択されていません'; stationSub.textContent='会社・路線・駅番号などがここに表示されます'; infoContent.innerHTML='駅を選択するとここに表示されます。'; }

/* Render header badges: show per-line numeric station numbers
   Use per-line override if present (STATION_OVERRIDES_BY_LINE), otherwise compute index.
   Badge itself shows only digits (ユーザー指定)。路線記号は別に表示（badge shows code above digits).
*/
function renderHeaderBadges(){
  const company = companySelect.value;
  const station = stationSelect.value;
  stationNumber.innerHTML=''; stationName.textContent = station || '駅が選択されていません';
  stationSub.textContent = station ? ('選択駅: ' + station) : '会社・路線・駅番号などがここに表示されます';
  if(!company || !station) return;
  const lines = DATA[company];
  const serving = [];
  for(const ln of LINE_PRIORITY){ if(lines[ln] && lines[ln].stations.includes(station)) serving.push({name:ln, info:lines[ln]}); }
  for(const ln of Object.keys(lines)){ if(!LINE_PRIORITY.includes(ln) && lines[ln].stations.includes(station)) serving.push({name:ln, info:lines[ln]}); }

  const badges = serving.map(s=>{
    // get per-line override for this company/line/station
    const perLine = getPerLineOverride(company, s.name, station);
    let idxDigits = null;
    if(perLine && perLine.stationNumber){
      // per-line stationNumber is numeric-only by construction
      const m = String(perLine.stationNumber).match(/^0*([0-9]+)$/);
      if(m) idxDigits = m[1].padStart(2,'0');
    }
    if(idxDigits===null){
      const pos = s.info.stations.indexOf(station);
      idxDigits = String(pos+1).padStart(2,'0');
    }
    const c = s.info.colorHex; const style = s.info.style||'filled';
    if(style==='filled'){ return `<span class="num-vertical filled" style="background:${c};"><span style="font-size:14px;line-height:1">${s.info.code}</span><span style="font-size:14px;line-height:1;margin-top:2px">${idxDigits}</span></span>`;}
    if(style==='rounded'){ return `<span class="num-vertical rounded" style="border-color:${c};"><span style="font-size:14px;line-height:1;color:#000">${s.info.code}</span><span style="font-size:14px;line-height:1;margin-top:2px;color:#000">${idxDigits}</span></span>`;}
    return `<span class="num-vertical circle" style="border-color:${c};"><span style="font-size:14px;line-height:1;color:#000">${s.info.code}</span><span style="font-size:14px;line-height:1;margin-top:2px;color:#000">${idxDigits}</span></span>`;
  });
  stationNumber.innerHTML = badges.join('');
  // stationSub shows codes with numeric index like "S-03" etc.
  const label = serving.map(s=>{
    const perLine = getPerLineOverride(company, s.name, station);
    let numLabel = null;
    if(perLine && perLine.stationNumber){
      numLabel = s.info.code + '-' + String(perLine.stationNumber).padStart(2,'0');
    }
    if(!numLabel){
      const pos = s.info.stations.indexOf(station);
      numLabel = s.info.code + '-' + String(pos+1).padStart(2,'0');
    }
    return numLabel;
  }).join(' / ');
  stationSub.textContent = company + ' — ' + label;
}

/* Render info: uses per-line override if available (selected company+line) */
function renderInfo(view){
  const company = companySelect.value; const line = lineSelect.value; const station = stationSelect.value;
  if(!company || !line || !station){ infoContent.innerHTML = '<em>駅が選択されていません。</em>'; return; }
  const perLine = getPerLineOverride(company, line, station);
  // fallback to aggregated STATION_INFO when necessary
  const sInfo = STATION_INFO[station] ? JSON.parse(JSON.stringify(STATION_INFO[station])) : { platforms:[], timetables:[], exits:[], details:{} };
  // apply per-line overrides (override whole fields if present)
  if(perLine){
    if(perLine.platforms) sInfo.platforms = perLine.platforms.slice();
    if(perLine.timetables) sInfo.timetables = perLine.timetables.slice();
    if(perLine.exits) sInfo.exits = perLine.exits.slice();
    if(perLine.details) sInfo.details = Object.assign({}, perLine.details);
    // include stationNumber in details for reference
    sInfo.details._stationNumber = perLine.stationNumber;
  }

  if(view==='platforms'){
    let html = `<h3 style="margin-top:0">${station} のりば案内（${line} - 個別表示）</h3><ul>`;
    for(const p of sInfo.platforms) html += `<li>${p}</li>`;
    html += `</ul>`; infoContent.innerHTML = html; return;
  }

  if(view==='timetable'){
    const directions = [];
    for(const t of sInfo.timetables){
      const label = t.destination;
      const key = label + '|' + (t.lineCode||'');
      if(!directions.find(d=>d.key===key)) directions.push({key, label, lineCode: t.lineCode||''});
    }

    let html = `<h3 style="margin-top:0">${station} 時刻表（${line} - 個別）</h3>`;
    html += `<div class="timetable-controls" id="timetableControls">`;
    if(directions.length===0){
      html += `<div class="muted">この駅の時刻表データは登録されていません。</div>`;
    } else {
      directions.forEach((d,i)=>{ html += `<button class="dir-btn" data-key="${d.key}" ${i===0?'data-default="true"':''}>${d.label}</button>`; });
    }
    html += `</div><div id="timetableList"></div>`;
    infoContent.innerHTML = html;

    const ctrl = document.getElementById('timetableControls');
    if(directions.length>0){
      const buttons = Array.from(ctrl.querySelectorAll('button.dir-btn'));
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const key = btn.dataset.key;
          renderTimetableForKey(key, sInfo, company);
        });
      });
      const defaultBtn = buttons.find(b=>b.dataset.default==='true') || buttons[0];
      defaultBtn.click();
    }
    return;
  }

  if(view==='exits'){
    let html=`<h3 style="margin-top:0">${station} 出口案内（${line}）</h3><ul>`;
    for(const e of sInfo.exits) html += `<li>${e}</li>`;
    html += `</ul>`; infoContent.innerHTML = html; return;
  }

  if(view==='details'){
    const d = sInfo.details; infoContent.innerHTML = `<h3 style="margin-top:0">${station} 詳細（${line}）</h3><p>所在地: ${d.address}</p><p>${d.contact}</p><p class="muted">駅番号（路線内）: ${d._stationNumber||'--'}</p>`; return;
  }
}

/* render timetable entries matching a direction key (label|lineCode) */
function renderTimetableForKey(key, sInfo, company){
  const parts = key.split('|'); const label = parts[0]; const code = parts[1];
  const entries = sInfo.timetables.filter(t=>t.destination===label || (t.lineCode||'')===code);
  let list = entries.length? entries : sInfo.timetables.slice();
  let html = '';
  if(list.length===0){ html = `<div class="muted">この方面の時刻データが見つかりません。</div>`; }
  else {
    html = `<div class="timetable-simple">`;
    for(const t of list){
      const platHtml = (typeof t.platformNumber !== 'undefined' && t.platformNumber !== null) ? `<span class="plat-circle">${t.platformNumber}</span>` : '';
      html += `<div class="tt-line"><div class="tt-type ${t.typeClass}">${t.typeLabel}</div><div class="tt-time">${t.time}</div><div class="tt-dest">${t.destination}${platHtml}</div></div>`;
    }
    html += `</div>`;
  }
  const container = document.getElementById('timetableList');
  if(container) container.innerHTML = html;
}

/* initialize */
clearInfo();

</script>
</body>
</html>
