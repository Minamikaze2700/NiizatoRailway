<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>新里鉄道 乗換案内</title>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 950px; }
h2 { margin-bottom: 10px; }
.route-line { color: white; padding: 2px 6px; border-radius: 4px; margin: 0 4px; }
.route { margin: 6px 0; }
select { margin: 0 10px 0 0; padding: 2px; }
button { padding: 2px 6px; }
#result { margin-top: 12px; max-height: 600px; overflow-y: auto; border:1px solid #ccc; padding:6px; }
</style>
</head>
<body>
<h2>新里鉄道 乗換案内</h2>

<label>発路線:
<select id="startLine" onchange="updateStations('start')"></select>
</label>
<label>発駅:
<select id="start"></select>
</label>
<br><br>
<label>着路線:
<select id="goalLine" onchange="updateStations('goal')"></select>
</label>
<label>着駅:
<select id="goal"></select>
</label>
<br><br>
<button onclick="showAllRoutes()">検索</button>

<div id="result"></div>

<script>
const stationLines = {
"湯の浜線":["豊町","東豊町","清水浜","安田町","南栃原","栃原","宇城","須川","御浜埼公園","御浜","伊坂","垳下","北浜","西新里","新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","七浦","那珂町","宇多野","伊奈崎","鶴宮神社","鶴宮","北鶴宮"],
"燠野線":["新里","河岸","新里海浜公園","湯の浜海岸","湯の浜","新里大学前","綾原","福来","燠野","湯川","温泉口","燠野温泉"]
};

const lineColors = {
"湯の浜線":"#07b5f7",
"燠野線":"#fd5062"
};

// 駅間距離（前回コードと同じ）
const rawGraph = {
"豊町":{"東豊町":1.2},"東豊町":{"清水浜":1.4},"清水浜":{"安田町":1.9},
"安田町":{"南栃原":2.2},"南栃原":{"栃原":0.9},"栃原":{"宇城":2.2},
"宇城":{"須川":2.1},"須川":{"御浜埼公園":1.9},"御浜埼公園":{"御浜":0.6},
"御浜":{"伊坂":2.5},"伊坂":{"垳下":2.6},"垳下":{"北浜":2.3},"北浜":{"西新里":1.4},
"西新里":{"新里":1.7},"新里":{"河岸":0.9},"河岸":{"新里海浜公園":1.7},
"新里海浜公園":{"湯の浜海岸":2.3},"湯の浜海岸":{"湯の浜":1.5},
"湯の浜":{"新里大学前":0.8,"七浦":2.5}
};

// 双方向化
const graph = {};
for(const [from,targets] of Object.entries(rawGraph)){
    if(!graph[from]) graph[from]={};
    for(const [to,d] of Object.entries(targets)){
        graph[from][to]=d;
        if(!graph[to]) graph[to]={};
        graph[to][from]=d;
    }
}

// 運賃関数
function fare(distance){
    if(distance<=3) return {adult:130,child:70};
    else if(distance<=6) return {adult:160,child:80};
    else if(distance<=10) return {adult:190,child:100};
    else if(distance<=15) return {adult:220,child:110};
    else if(distance<=20) return {adult:250,child:130};
    else if(distance<=25) return {adult:280,child:140};
    else if(distance<=30) return {adult:310,child:160};
    else return {adult:340,child:170};
}

// 路線判定
function getLine(from,to){
    for(const [line,stations] of Object.entries(stationLines)){
        for(let i=0;i<stations.length-1;i++){
            if((stations[i]===from && stations[i+1]===to)||(stations[i]===to && stations[i+1]===from)) return line;
        }
    }
    return null;
}

// BFS探索
function findBestPath(start,goal){
    const queue=[[ [start],0 ]];
    const visited={};
    let best=null;
    while(queue.length>0){
        queue.sort((a,b)=>a[1]-b[1]);
        const [path,distance]=queue.shift();
        const last=path[path.length-1];
        if(last===goal){
            if(!best || distance<best.distance) best={path,distance};
            continue;
        }
        for(const next in graph[last]){
            if(path.includes(next)) continue;
            const key=path.concat(next).join(">");
            if(visited[key]) continue;
            visited[key]=true;
            queue.push([path.concat(next),distance+graph[last][next]]);
        }
    }
    return best;
}

// 表示用パス生成
function processDisplayPath(path){
    let display=[]; 
    let lastLine=getLine(path[0],path[1]);
    display.push({station:path[0],line:lastLine});
    for(let i=1;i<path.length-1;i++){
        const line=getLine(path[i],path[i+1]);
        if(line!==lastLine){
            display.push({station:path[i],line:line});
        }
        lastLine=line;
    }
    display.push({station:path[path.length-1],line:lastLine});
    return display;
}

// 駅選択更新
function updateStations(type){
    const lineSelect = document.getElementById(type+"Line");
    const stationSelect = document.getElementById(type);
    stationSelect.innerHTML = "";
    const line = lineSelect.value;
    stationLines[line].forEach(st=>{
        if(line==="燠野線" && ["新里","河岸","新里海浜公園","湯の浜海岸","湯の浜"].includes(st)) return;
        const opt = document.createElement("option");
        opt.value = st;
        opt.text = st;
        stationSelect.appendChild(opt);
    });
}

// 初期化
const startLine=document.getElementById("startLine");
const goalLine=document.getElementById("goalLine");
Object.keys(stationLines).forEach(l=>{
    const opt1=document.createElement("option"); opt1.value=l; opt1.text=l; startLine.appendChild(opt1);
    const opt2=document.createElement("option"); opt2.text=l; opt2.value=l; goalLine.appendChild(opt2);
});
updateStations("start"); updateStations("goal");

// 新里経由ルール判定
function determineSpecialPath(start,goal){
    const yLine="湯の浜線";
    const nLine="燠野線";
    const indexStartY = stationLines[yLine].indexOf(start);
    const indexGoalY  = stationLines[yLine].indexOf(goal);
    const indexStartN = stationLines[nLine].indexOf(start);
    const indexGoalN  = stationLines[nLine].indexOf(goal);
    const indexShinriY = stationLines[yLine].indexOf("新里");
    const indexShinriN = stationLines[nLine].indexOf("新里");

    // 出発駅が豊町～西新里（新里含まず）
    if(indexStartY>=0 && indexStartY<indexShinriY && indexGoalN>indexShinriN){
        const part1 = findBestPath(start,"新里");
        const part2 = findBestPath("新里",goal);
        return part1 && part2 ? {path: part1.path.concat(part2.path.slice(1)), distance: part1.distance+part2.distance} : null;
    }
    // 出発駅が新里～湯の浜（新里含む）
    if(indexStartN>indexShinriN || (indexStartY>=indexShinriY && indexStartY<=stationLines[yLine].indexOf("湯の浜"))){
        return findBestPath(start,goal);
    }
    // 着駅が豊町～西新里（新里含まず）
    if(indexGoalY>=0 && indexGoalY<indexShinriY && indexStartN>indexShinriN){
        const part1 = findBestPath(start,"新里");
        const part2 = findBestPath("新里",goal);
        return part1 && part2 ? {path: part1.path.concat(part2.path.slice(1)), distance: part1.distance+part2.distance} : null;
    }
    // 着駅が新里～湯の浜（新里含む）
    if(indexGoalN>indexShinriN || (indexGoalY>=indexShinriY && indexGoalY<=stationLines[yLine].indexOf("湯の浜"))){
        return findBestPath(start,goal);
    }
    // それ以外は普通に探索
    return findBestPath(start,goal);
}

// 表示
function showAllRoutes(){
    const start=document.getElementById("start").value;
    const goal=document.getElementById("goal").value;
    const resultDiv=document.getElementById("result");
    resultDiv.innerHTML="";
    if(start===goal){ resultDiv.innerHTML="発駅と着駅が同じです"; return; }

    const best=determineSpecialPath(start,goal);
    if(!best){ resultDiv.innerHTML="ルートが見つかりません"; return; }

    const display=processDisplayPath(best.path);
    let html="";
    for(let i=0;i<display.length;i++){
        const curr=display[i];
        html+=curr.station;
        if(i < display.length-1){
            html+=" <span class='route-line' style='background:"+lineColors[curr.line]+"'>新里鉄道 "+curr.line+"</span> ";
        } else { html+=" "; }
    }
    html+=`<br>\n総距離: ${best.distance.toFixed(1)} km<br>`;
    const f=fare(best.distance);
    html+=`運賃: 大人 ${f.adult}円／小児 ${f.child}円`;
    const div=document.createElement("div"); div.className="route"; div.innerHTML=html;
    resultDiv.appendChild(div);
}
</script>
</body>
</html>
